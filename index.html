<!DOCTYPE html>
<html lang="en" class="h-full overflow-hidden" style="background: var(--color-bg-main);">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nimbus Super Trading Platform</title>

  <!-- Fonts: Geist + Geist Mono -->
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist/400.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist/500.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist/600.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist/700.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-mono/400.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-mono/500.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-mono/600.css" rel="stylesheet">

  <!-- Global Design System -->
  <link href="assets/css/components.css" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- TradingView Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <!-- Chart.js for portfolio charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/navbar.js"></script>

  <style>
    /* Page-specific overrides for index.html */
    
    /* Tab active indicator - uses global CSS variables */
    .tab-active { 
      color: var(--color-text-primary);
      position: relative; 
    }

    .tab-active::after { 
      content: ""; 
      position: absolute; 
      left: 0; 
      right: 0; 
      bottom: -1px; 
      height: 2px; 
      background: var(--color-accent); 
      border-radius: 2px; 
    }

    /* TradingView container */
    #tradingview_widget { 
      height: 100% !important; 
      width: 100% !important; 
    }


    /* Order Book Animations */
    .order-row {
      transition: all 0.3s ease-in-out;
      opacity: 1;
      transform: translateX(0);
    }

    .order-row.updating {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .order-row.new-order {
      animation: slideInFade 0.3s ease-in-out;
    }

    .order-row.removed-order {
      animation: slideOutFade 0.3s ease-in-out forwards;
    }

    @keyframes slideInFade {
      0% {
        opacity: 0;
        transform: translateX(-10px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutFade {
      0% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(10px);
      }
    }

    .price-flash {
      animation: priceFlash 0.6s ease-in-out;
    }

    @keyframes priceFlash {
      0%, 100% { background-color: transparent; }
      50% { background-color: rgba(0, 255, 224, 0.2); }
    }

    /* News Utilities */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2;
      overflow: hidden;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* Layout Classes - No more inline styles */
    .panel-height {
      height: calc(100vh - 60px);
    }
    
    .border-subtle {
      border-color: var(--color-border-subtle);
    }
    
    .text-primary {
      color: var(--color-text-primary);
    }
    
    .border-row {
      border-color: var(--border-row);
    }
    
    .tab-switch-width {
      width: 200px;
    }
    
    .tab-slider-left {
      left: 0.25rem;
    }
    
    .order-slider-left {
      left: 0%;
    }
    
    .side-slider-bg {
      background: rgba(52, 211, 153, 0.18);
      box-shadow: inset 0 0 0 1px rgba(110,231,183,0.30);
    }
    
    .grid-slider-left {
      left: 0.25rem;
    }
    
    .portfolio-layout {
      display: flex;
      flex-direction: column;
      height: 25vh; /* 1/4 of viewport height */
    }

    /* Dynamic Position Classes */
    .tab-left { left: 0.25rem !important; }
    .tab-right { left: calc(50% + 0.25rem) !important; }
    
    .order-market { left: 0% !important; }
    .order-limit { left: 33.333% !important; }
    .order-pro { left: 66.666% !important; }
    
    .side-long { 
      left: 0.25rem !important;
      background: rgba(52,211,153,0.18) !important;
      box-shadow: inset 0 0 0 1px rgba(110,231,183,0.30) !important;
    }
    .side-short { 
      left: calc(50% + 0.25rem) !important;
      background: rgba(244,63,94,0.18) !important;
      box-shadow: inset 0 0 0 1px rgba(248,113,113,0.30) !important;
    }

    /* Dynamic width utility */
    .dynamic-width {
      width: var(--width, 0%);
    }

    /* 2-Column Layout */
    .main-layout {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    .left-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }
    
    .right-column {
      display: flex;
      flex-direction: column;
      width: 420px;
      min-width: 380px;
      max-width: 460px;
      height: calc(100vh - 60px);
      overflow: hidden;
    }
    
    .chart-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    .chart-section.hidden-by-portfolio {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .portfolio-section {
      height: 25vh;
      display: flex;
      flex-direction: column;
      min-height: 0;
      transition: height 0.3s ease-in-out, z-index 0.3s ease-in-out;
    }

    .portfolio-section.fullscreen {
      height: 100%;
      z-index: 10;
      position: relative;
    }
    
    .trading-panel {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: visible;
    }
    
    .token-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    /* Chart Layout Styles */
    .chart-layout-option.active {
      background: rgba(110, 231, 183, 0.1);
      color: #6EE7B7;
    }

    .chart-layout-option.active svg {
      stroke: #6EE7B7;
    }

    #chartLayoutMenu {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>

<body class="h-full overflow-hidden text-gray-200 antialiased bg-gradient-main">
  <!-- Page Wrapper -->
  <div class="h-full flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>
    
    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col min-h-0">
      <!-- 2-Column Layout -->
      <div class="main-layout">
        <!-- Left Column: Chart + Portfolio -->
        <div class="left-column">
          <!-- Chart Section -->
          <div class="chart-section">
            <div id="coreArea" class="flex-1 min-w-0 flex flex-col">
          <!-- Chart header controls -->

            <!-- TradingView Chart Container -->
            <div id="chartContainer" class="relative flex-1 overflow-hidden">
              <!-- Single Chart Layout -->
              <div id="singleChartLayout" class="w-full h-full">
                <div id="tradingview_widget" class="w-full h-full"></div>
                </div>

              <!-- Two Charts Layout -->
              <div id="twoChartsLayout" class="hidden w-full h-full flex gap-1">
                <div id="tradingview_widget_1" class="flex-1 h-full"></div>
                <div id="tradingview_widget_2" class="flex-1 h-full"></div>
                </div>

              <!-- Four Charts Layout -->
              <div id="fourChartsLayout" class="hidden w-full h-full grid grid-cols-2 grid-rows-2 gap-1">
                <div id="tradingview_widget_3" class="w-full h-full"></div>
                <div id="tradingview_widget_4" class="w-full h-full"></div>
                <div id="tradingview_widget_5" class="w-full h-full"></div>
                <div id="tradingview_widget_6" class="w-full h-full"></div>
              </div>
            </div>
            </div>
          </div>

          <!-- Portfolio Section in Left Column -->
          <div class="portfolio-section glass border-t border-subtle">
            <!-- Portfolio content will be moved here via JavaScript -->
          </div>
        </div>

        <!-- Right Column: Trading Panel + Token List -->
        <div class="right-column">
          <!-- Trading Panel -->
          <aside id="tradesPanel" class="trading-panel relative border-l glass-strong hidden-scroll md:flex md:flex-col border-subtle">
          <!-- Resizer handle -->
          <div id="tpResizer" class="absolute -left-1 top-0 bottom-0 w-2 cursor-col-resize hover:bg-emerald-400/20 transition-colors"></div>

          <!-- Header with Tabs and Leverage -->
          <header class="relative px-3 border-b border-subtle">
            <div class="flex items-center gap-3">
              <!-- Mode Switch -->
               <div class="flex w-full">
                 <button id="tabTrade" class="flex-1 text-center py-1.5 text-[12px] font-medium tracking-tight text-white transition-all duration-200">Trade</button>
                 <button id="tabStrategies" class="flex-1 text-center py-1.5 text-[12px] font-medium tracking-tight text-neutral-400 hover:text-neutral-300 transition-all duration-200">Strategies</button>
              </div>
              
              <!-- Spacer to push elements to the right -->
              <div class="flex-1"></div>
            </div>
          </header>

          <!-- Content Areas -->
          <div class="flex-1 overflow-auto px-3 py-3">
            <!-- TRADE MODE -->
            <div id="tradeMode" class="divide-y divide-white/10">
              <!-- Controls row: Order Type + Buy/Sell -->
              <div class="py-2.5">
                <div class="grid grid-cols-1 gap-2.5">
                  <!-- Order Type Tabs & Leverage -->
                  <div class="p-0 flex items-center gap-2.5">
                    <div class="flex-1">
                    <div class="relative grid grid-cols-3 rounded-md ring-1 ring-white/10 bg-white/5">
                      <button id="orderMarket" class="relative z-10 w-full inline-flex items-center justify-center gap-1.5 py-1.5 text-[12px] font-medium text-center">Market</button>
                      <button id="orderLimit" class="relative z-10 w-full inline-flex items-center justify-center gap-1.5 py-1.5 text-[12px] font-medium text-center text-neutral-400">Limit</button>
                      <div class="relative">
                        <button id="orderPro" class="relative z-10 w-full inline-flex items-center justify-center gap-1.5 py-1.5 text-[12px] font-medium text-center text-neutral-400">
                          <span>Pro</span>
                          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                          </svg>
                        </button>
                        <!-- Pro dropdown -->
                        <div id="proMenu" class="hidden absolute right-0 z-20 mt-1 w-[180px] rounded-md glass-strong p-1">
                          <button data-pro="Scale" class="w-full text-left px-2 py-1.5 rounded-[6px] hover:bg-white/10 text-[12px]">Scale</button>
                          <button data-pro="Stop Limit" class="w-full text-left px-2 py-1.5 rounded-[6px] hover:bg-white/10 text-[12px]">Stop Limit</button>
                          <button data-pro="Stop Market" class="w-full text-left px-2 py-1.5 rounded-[6px] hover:bg-white/10 text-[12px]">Stop Market</button>
                          <button data-pro="TWAP" class="w-full text-left px-2 py-1.5 rounded-[6px] hover:bg-white/10 text-[12px]">TWAP</button>
                </div>
              </div>
                        <div id="orderTypeSlider" class="absolute inset-y-0 left-0 w-1/3 rounded-md bg-white/10 transition-all duration-200 order-market"></div>
            </div>
                    </div>
                    
                    <!-- Leverage -->
                    <button id="leverageOpen" class="group inline-flex items-center gap-1.5 rounded-md bg-white/5 hover:bg-white/10 active:bg-white/15 transition-all px-2 py-1.5 ring-1 ring-white/10 shrink-0">
                      <span id="marginModeLabel" class="text-[11px] font-medium text-emerald-300">Isolated</span>
                      <span class="text-[12px] font-medium tracking-tight"><span id="leverageLabel" class="mono font-semibold">20x</span></span>
                    </button>
          </div>

                  <!-- Buy/Sell Toggle -->
                  <div id="buySellToggle" class="p-1">
                    <div class="grid grid-cols-2 relative">
                      <button id="longBtn" class="relative z-10 py-2.5 text-[13px] font-medium text-emerald-300">Long</button>
                      <button id="shortBtn" class="relative z-10 py-2.5 text-[13px] font-medium text-rose-300 opacity-60">Short</button>
                      <div id="sideSlider" class="absolute top-1 bottom-1 left-1 w-[calc(50%-8px)] rounded-md transition-all duration-200 ease-out tab-slider-left side-slider-bg"></div>
                </div>
              </div>
            </div>
                </div>

              <!-- Position & Size -->
              <div class="py-2.5">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-neutral-400">
                    Avail: <span id="availBalance" class="text-emerald-200 mono font-semibold">2829.23</span>
                </div>
                  <div class="text-[11px] text-neutral-400">
                    Pos: <span class="text-neutral-100 mono font-semibold">0.0000 ETH</span>
              </div>
                </div>
                <div class="mt-1.5 space-y-3">
                  <!-- Position Size Slider -->
                  <div class="flex items-center gap-3">
                    <!-- Custom Slider Container -->
                    <div class="flex-1 relative">
                      <!-- Slider Track -->
                      <div class="h-2 rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm relative overflow-hidden">
                        <!-- Active Progress -->
                        <div id="sliderProgress" class="h-full bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600 rounded-sm transition-all duration-200" style="width: 0%"></div>
                        <!-- Slider Handle -->
                        <div id="sliderHandle" class="absolute top-1/2 -translate-y-1/2 w-5 h-5 rounded-md ring-1 ring-white/20 bg-white/90 backdrop-blur-sm cursor-pointer transition-all duration-200 shadow-lg" style="left: 0%"></div>
                </div>
                      <!-- Hidden Range Input -->
                      <input id="sizeSlider" type="range" min="0" max="100" step="1" value="0" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
              </div>
                    
                    <!-- Percentage Input -->
                    <div class="w-[80px]">
                      <div class="relative rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm px-3 py-2">
                        <input id="sizeInput" type="number" class="w-full bg-transparent outline-none text-[14px] mono font-semibold text-white text-center" value="0" min="0" max="100" step="1">
                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[12px] text-neutral-400 pointer-events-none">%</span>
                  </div>
                </div>
              </div>
                  
                  <!-- Percentage Buttons -->
                  <div class="flex justify-between items-center px-1">
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="25">25%</button>
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="33">33%</button>
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="50">50%</button>
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="66">66%</button>
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="75">75%</button>
                    <button class="percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="100">100%</button>
            </div>
                </div>
                
                <!-- Scale Trading UI (replaces regular inputs when Scale is selected) -->
                <div id="scaleUI" class="mt-2 space-y-3 hidden">


                  


                  <!-- Amount Input -->
                  <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Amount</span>
                      <button id="scaleAmountToggleBtn" class="text-[12px] mono font-semibold text-white hover:text-emerald-300 transition-colors cursor-pointer" onclick="toggleScaleAmountDisplay()">
                        <span id="scaleAmountDisplayValue">0.25</span> <span id="scaleAmountDisplayUnit">BTC</span>
                    </button>
                </div>
                    <input id="scaleAmountInput" type="number" placeholder="1625" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
              </div>

                  <!-- Start and End Price Row -->
                  <div class="grid grid-cols-2 gap-2.5">
                    <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Start (USD)</span>
                  </div>
                      <input type="number" placeholder="Enter start price" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
                </div>
                    
                    <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">End (USD)</span>
              </div>
                      <input type="number" placeholder="Enter end price" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
            </div>
                  </div>
                  
                  <!-- Bottom Row: Total Orders and Size Skew -->
                  <div class="grid grid-cols-2 gap-2.5">
                    <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Total Orders</span>
                      </div>
                      <input type="number" placeholder="10" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
                    </div>
                    
                    <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Size Skew</span>
                        <span class="text-[12px] mono font-semibold text-white">1.00</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- TWAP Trading UI (replaces regular inputs when TWAP is selected) -->
                <div id="twapUI" class="mt-2 space-y-3 hidden">

                  
                    <!-- Amount Input -->
                    <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                      <div class="flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Amount</span>
                      <button id="twapSizeToggleBtn" class="text-[12px] mono font-semibold text-white hover:text-emerald-300 transition-colors cursor-pointer" onclick="toggleTwapSizeDisplay()">
                        <span id="twapSizeDisplayValue">4777.05</span> <span id="twapSizeDisplayUnit">USD</span>
                      </button>
                    </div>
                    <input id="twapSizeInput" type="number" placeholder="4777.05" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
                  </div>
                  

                  
                  <!-- Running Time -->
                  <div class="space-y-2">
                    <span class="text-[11px] text-neutral-400">Running Time (5m - 24h)</span>
                    <div class="grid grid-cols-2 gap-2.5">
                      <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                        <div class="flex items-center justify-between">
                          <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Hour(s)</span>
                        </div>
                        <input id="twapHoursInput" type="number" placeholder="" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
                      </div>
                      
                      <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                        <div class="flex items-center justify-between">
                          <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Minute(s)</span>
                        </div>
                        <input id="twapMinutesInput" type="number" placeholder="30" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
                      </div>
                    </div>
                  </div>
                  
                    <!-- Options Toggles -->
                    <div class="space-y-2">
                      <button id="twapRandomizeToggle" class="group inline-flex items-center gap-2">
                        <span class="relative inline-flex h-4 w-7 items-center rounded-full bg-white/10 ring-1 ring-white/10">
                          <span id="twapRandomizeKnob" class="absolute left-0.5 top-1/2 -translate-y-1/2 h-3 w-3 rounded-full bg-neutral-300 transition-transform"></span>
                        </span>
                        <span class="text-[12px] font-medium">Randomize</span>
                      </button>
                      
                      <button id="twapReduceOnlyToggle" class="group inline-flex items-center gap-2">
                        <span class="relative inline-flex h-4 w-7 items-center rounded-full bg-white/10 ring-1 ring-white/10">
                          <span id="twapReduceOnlyKnob" class="absolute left-0.5 top-1/2 -translate-y-1/2 h-3 w-3 rounded-full bg-neutral-300 transition-transform"></span>
                        </span>
                        <span class="text-[12px] font-medium">Reduce Only</span>
                      </button>
                    </div>
                </div>
                
                <!-- Regular Trading Inputs (Price and Size inputs) -->
                <div id="regularInputs" class="mt-2 space-y-3">
                <div class="grid grid-cols-2 gap-2.5">
                  <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2 transition-opacity opacity-60" id="priceField">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Price</span>
                      <span id="priceHint" class="text-[11px] text-neutral-500">auto for Market</span>
                  </div>
                    <input id="priceInput" type="number" placeholder="Market" disabled="" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600 disabled:placeholder-neutral-500">
                </div>
                  <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                    <div class="flex items-center justify-between">
                      <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Amount</span>
                      <button id="amountToggleBtn" class="text-[12px] mono font-semibold text-white hover:text-emerald-300 transition-colors cursor-pointer" onclick="toggleAmountDisplay()">
                        <span id="amountDisplayValue">0.25</span> <span id="amountDisplayUnit">BTC</span>
                      </button>
              </div>
                    <input id="amountInput" type="number" placeholder="1625" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
            </div>
          </div>
        </div>

              <!-- Stop Price Input (shown only for Stop Limit orders) -->
              <div id="stopPriceSection" class="mt-2 hidden">
                <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                  <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Stop Price</span>
                  </div>
                  <input id="stopPriceInput" type="number" placeholder="Enter stop price" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
          </div>
        </div>

              <!-- Options -->
              <div class="py-2.5">
                <div class="flex items-center justify-between">
                  <!-- Reduce-only toggle -->
                  <button id="reduceToggle" class="group inline-flex items-center gap-2">
                    <span class="relative inline-flex h-4 w-7 items-center rounded-full bg-white/10 ring-1 ring-white/10">
                      <span id="reduceKnob" class="absolute left-0.5 top-1/2 -translate-y-1/2 h-3 w-3 rounded-full bg-neutral-300 transition-transform"></span>
                    </span>
                    <span class="text-[12px] font-medium">Reduce Only</span>
                  </button>
                    
                    <!-- TP / SL Toggle -->
                    <button id="tpSlToggle" class="group inline-flex items-center gap-2">
                      <span class="relative inline-flex h-4 w-7 items-center rounded-full bg-white/10 ring-1 ring-white/10">
                        <span id="tpSlKnob" class="absolute left-0.5 top-1/2 -translate-y-1/2 h-3 w-3 rounded-full bg-neutral-300 transition-transform"></span>
                      </span>
                      <span class="text-[12px] font-medium">TP / SL</span>
                  </button>
              </div>

                <!-- TP / SL Grid -->
                <div id="tpSlFields" class="mt-2 space-y-2">
                  <!-- TP Row -->
                  <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                    <div class="grid grid-cols-3 gap-2">
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">TP Price</div>
                        <input id="tpInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-emerald-300 placeholder-neutral-600">
                </div>
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">Gain $</div>
                        <input id="tpGainUsdInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-emerald-300 placeholder-neutral-600">
                </div>
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">Gain %</div>
                        <input id="tpGainPctInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-emerald-300 placeholder-neutral-600">
                      </div>
                    </div>
                  </div>
                  
                  <!-- SL Row -->
                  <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                    <div class="grid grid-cols-3 gap-2">
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">SL Price</div>
                        <input id="slInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-red-300 placeholder-neutral-600">
                </div>
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">Loss $</div>
                        <input id="slLossUsdInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-red-300 placeholder-neutral-600">
                </div>
                      <div class="text-left">
                        <div class="text-[11px] uppercase tracking-[0.02em] text-neutral-400 mb-1">Loss %</div>
                        <input id="slLossPctInput" type="number" placeholder="" class="w-full bg-transparent outline-none text-[12px] mono font-semibold text-red-300 placeholder-neutral-600">
            </div>
          </div>
                </div>
            </div>
          </div>
                </div>
                <!-- End Regular Inputs -->

              <!-- Place Order + Summary -->
              <div class="py-2.5">
                <button id="placeOrder" disabled="" class="w-full group relative inline-flex overflow-hidden text-[13px] opacity-60 cursor-not-allowed ring-1 ring-white/10 transition-all hover:opacity-95 active:opacity-90 font-semibold text-black tracking-tight rounded-lg pt-2.5 pr-3 pb-2.5 pl-3 items-center justify-center btn-primary">
                  <span class="relative z-10">Place Long</span>
                </button>

                <!-- Order Summary -->
                <!-- <div class="mt-2.5 grid grid-cols-2 gap-x-3 gap-y-1.5 text-[11px]">
                  <div class="text-neutral-400">Liquidation Price</div>
                  <div id="liqPrice" class="text-neutral-100 mono font-semibold">N/A</div>

                  <div class="text-neutral-400">Order Value</div>
                  <div id="orderValue" class="text-emerald-200 mono font-semibold">N/A</div>

                  <div class="text-neutral-400">Margin Required</div>
                  <div id="marginRequired" class="text-neutral-100 mono font-semibold">N/A</div>

                  <div class="text-neutral-400">Slippage</div>
                  <div id="slippageValue" class="text-neutral-100 mono font-semibold">Est 0.00% / Max 8.00%</div>

                  <div class="text-neutral-400">Fees</div>
                  <div id="feesValue" class="text-neutral-100 mono font-semibold">—</div>
                </div> -->
              </div>

              <!-- Deposit / Accounts -->
              


                
              </div>

            <!-- STRATEGIES MODE -->
            <div id="strategiesMode" class="hidden space-y-3">
                  <h3 class="text-[12px] font-medium uppercase tracking-[0.02em] text-neutral-200">Pre-built Bots</h3>
              
              <div class="space-y-2">
                <button data-bot="Grid" class="botBtn group w-full rounded-md bg-white/5 ring-1 ring-white/10 p-2 hover:ring-emerald-300/40 transition">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-emerald-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect width="7" height="7" x="3" y="3" rx="1"/>
                        <rect width="7" height="7" x="14" y="3" rx="1"/>
                        <rect width="7" height="7" x="14" y="14" rx="1"/>
                        <rect width="7" height="7" x="3" y="14" rx="1"/>
                      </svg>
                    <span class="text-[12px] font-medium tracking-tight">Grid</span>
                  </div>
                  </button>
                
                <button data-bot="DCA" class="botBtn group w-full rounded-md bg-white/5 ring-1 ring-white/10 p-2 hover:ring-emerald-300/40 transition">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-emerald-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7m0 14l4-4-4-4m6 4v9"/>
                      </svg>
                    <span class="text-[12px] font-medium tracking-tight">DCA</span>
              </div>
                  </button>
                
                <button data-bot="Smart Portfolio" class="botBtn group w-full rounded-md bg-white/5 ring-1 ring-white/10 p-2 hover:ring-emerald-300/40 transition">
              <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-emerald-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                      </svg>
                      <span class="text-[12px] font-medium tracking-tight">Smart Portfolio</span>
                </div>
                  </button>
            </div>


              </div>

            <!-- GRID BOT SETUP PANEL -->
            <div id="gridSetup" class="hidden">
              <div class="space-y-3">
                <!-- Header -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <button id="gridBack" class="inline-flex h-7 w-7 items-center justify-center rounded-md hover:bg-white/10 ring-1 ring-white/10 transition">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l-7-7 7-7"/>
                        <path d="M19 12H5"/>
                      </svg>
                    </button>
                    <h3 id="gridTitle" class="text-[14px] font-semibold tracking-tight text-neutral-100">Grid</h3>
        </div>
  </div>

                <!-- Lower limit -->
                <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Lower limit</span>
    </div>
                  <input id="lowerPrice" type="number" placeholder="0" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600" value="52000">
  </div>

                <!-- Upper limit -->
                <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Upper limit</span>
                  </div>
                  <input id="upperPrice" type="number" placeholder="0" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600" value="60000">
              </div>

                <!-- Grid quantity -->
                <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Grid quantity (2 - 500)</span>
                    <span class="text-[11px] text-neutral-500 mono font-semibold" id="gridQtyDisplay">25</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <!-- Custom Slider Container -->
                    <div class="custom-slider">
                      <div class="custom-slider-track">
                        <div id="gridQtyProgress" class="custom-slider-progress" style="width: 4.6%"></div>
                        <div id="gridQtyHandle" class="custom-slider-handle" style="left: calc(4.6% - 10px)"></div>
                </div>
                      <input id="gridQty" type="range" min="2" max="500" value="25" step="1" class="custom-slider-input">
                </div>
                    <input id="gridQtyInput" type="number" class="w-[70px] px-2 py-1.5 ring-1 ring-white/10 bg-white/5 rounded-md bg-transparent outline-none text-[12px] mono font-semibold" value="25" min="2" max="500" step="1">
                </div>
              </div>

                <!-- Profit per grid -->
                <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Profit per grid</span>
                    <span class="text-[11px] text-neutral-500">%</span>
                  </div>
                  <input id="profitPerGrid" type="number" placeholder="0.5" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600" value="0.5" step="0.1" min="0.1" max="10">
                </div>

                <!-- Available Balance Display -->
      <div class="flex items-center justify-between">
                  <div class="text-[11px] text-neutral-400">
                    Avail: <span id="gridAvailBalance" class="text-emerald-200 mono font-semibold">2829.23</span>
              </div>
                  <div class="text-[11px] text-neutral-400">
                    Pos: <span class="text-neutral-100 mono font-semibold">0.0000 ETH</span>
            </div>
      </div>

                <!-- Investment Amount Input -->
                <div class="rounded-md ring-1 ring-white/10 bg-white/5 p-2">
                  <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-[0.02em] text-neutral-400">Amount</span>
                    <button id="gridAmountToggleBtn" class="text-[12px] mono font-semibold text-white hover:text-emerald-300 transition-colors cursor-pointer">
                      <span id="gridAmountDisplayValue">0.25</span> <span id="gridAmountDisplayUnit">BTC</span>
                    </button>
            </div>
                  <input id="gridAmountInput" type="number" placeholder="1625" class="mt-1 w-full bg-transparent outline-none text-[12px] mono font-semibold placeholder-neutral-600">
          </div>

                <!-- Position Size Slider -->
                <div class="flex items-center gap-3">
                  <!-- Custom Slider Container -->
                  <div class="flex-1 relative">
                    <!-- Slider Track -->
                    <div class="h-2 rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm relative overflow-hidden">
                      <!-- Active Progress -->
                      <div id="gridSliderProgress" class="h-full bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600 rounded-sm transition-all duration-200" style="width: 0%"></div>
                      <!-- Slider Handle -->
                      <div id="gridSliderHandle" class="absolute top-1/2 -translate-y-1/2 w-5 h-5 rounded-md ring-1 ring-white/20 bg-white/90 backdrop-blur-sm cursor-pointer transition-all duration-200 shadow-lg" style="left: 0%"></div>
              </div>
                    <!-- Hidden Range Input -->
                    <input id="gridSizeSlider" type="range" min="0" max="100" step="1" value="0" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            </div>

                  <!-- Percentage Input -->
                  <div class="w-[80px]">
                    <div class="relative rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm px-3 py-2">
                      <input id="gridSizeInput" type="number" class="w-full bg-transparent outline-none text-[14px] mono font-semibold text-white text-center" value="0" min="0" max="100" step="1">
                      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[12px] text-neutral-400 pointer-events-none">%</span>
                </div>
              </div>
              </div>

                <!-- Percentage Buttons -->
                <div class="flex justify-between items-center px-1">
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="25">25%</button>
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="33">33%</button>
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="50">50%</button>
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="66">66%</button>
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="75">75%</button>
                  <button class="grid-percentage-btn text-[11px] font-medium text-neutral-400 hover:text-white transition-colors cursor-pointer" data-percent="100">100%</button>
              </div>

                <!-- Start Bot Button -->
                      <button id="startGrid" class="w-full group relative inline-flex items-center justify-center overflow-hidden rounded-lg px-3 py-2.5 text-[13px] font-semibold tracking-tight text-black ring-1 ring-white/10 transition-all hover:opacity-95 active:opacity-90 btn-primary">
                        <span class="relative z-10">Start Grid Bot</span>
                      </button>
              </div>
            </div>

          </div> <!-- /content -->
          </aside>

          <!-- Token List Panel -->
          <aside class="token-list border-l glass border-subtle">
          <!-- Header -->
          <div class="shrink-0 px-3 py-3 border-b border-subtle">

            <!-- Tabs and Search Row -->
            <div class="flex items-center gap-3">
            <!-- Tabs -->
              <div class="relative grid grid-cols-2 rounded-md ring-1 ring-white/10 bg-white/5 p-1 flex-shrink-0">
                <button id="tab-spot" class="group relative z-10 text-center py-1.5 px-3 text-[12px] font-semibold tracking-tight">Spot</button>
                <button id="tab-perp" class="group relative z-10 text-center py-1.5 px-3 text-[12px] font-semibold tracking-tight text-neutral-400">Perp</button>
                <div id="tokenTabSlider" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] rounded-md bg-white/10 backdrop-blur-md shadow-[inset_0_0_0_1px_rgba(255,255,255,0.10)] transition-all duration-200 ease-out"></div>
              </div>

            <!-- Search -->
              <div class="relative flex-1">
                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-neutral-400">
                  <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="M21 21l-4.35-4.35"/>
                </svg>
              </span>
                <input id="searchInput" placeholder="Search tokens" class="w-full pl-7 pr-3 py-1.5 text-[11px] rounded-md ring-1 ring-white/10 bg-white/5 text-neutral-200 placeholder-neutral-500 focus:ring-white/20 focus:bg-white/10 transition-all outline-none" />
              </div>
            </div>
          </div>

          <!-- Column Headers -->
          <div id="sortBar" class="grid grid-cols-12 gap-1 px-3 pb-1 text-[10px] text-gray-500 font-medium border-b border-subtle">
            <div class="col-span-6 flex items-center gap-2">
              <button data-sort="rank" class="inline-flex items-center gap-1 hover:text-gray-300 focus-ring">
                <span>Rank</span>
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 9l4-4 4 4"/>
                  <path d="M16 15l-4 4-4-4"/>
                </svg>
              </button>
              <button data-sort="token" class="inline-flex items-center gap-1 hover:text-gray-300 focus-ring">
                <span>Token</span>
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 9l4-4 4 4"/>
                  <path d="M16 15l-4 4-4-4"/>
                </svg>
              </button>
            </div>
            <div class="col-span-3 text-right">
              <button data-sort="price" class="inline-flex items-center gap-1 hover:text-gray-300 focus-ring">
                <span>Price</span>
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 9l4-4 4 4"/>
                  <path d="M16 15l-4 4-4-4"/>
                </svg>
              </button>
            </div>
            <div class="col-span-3 text-right">
              <button data-sort="change" class="inline-flex items-center gap-1 hover:text-gray-300 focus-ring">
                <span>24h</span>
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 9l4-4 4 4"/>
                  <path d="M16 15l-4 4-4-4"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Token list -->
          <div id="listContainer" class="flex-1 overflow-auto px-3">
            <div id="emptyState" class="hidden text-center text-gray-400 py-8 text-[10px]">
              No tokens yet. Add from list.
            </div>

            <ul id="tokenList" class=""></ul>
            <!-- Sentinel for infinite load -->
            <div id="sentinel" class="h-4"></div>
          </div>
          </aside>
        </div>

        <!-- Auxiliary Panels Column -->
        <div id="auxColumn" class="hidden md:flex flex-row overflow-x-auto border-l glass border-subtle panel-height">
          <!-- Panels will be injected here -->
        </div>

        <!-- Utility Icon Rail -->
        <div class="w-12 border-l glass flex flex-col items-center border-subtle panel-height">
          <button id="tradingPanelToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group" title="Show Trading Panel" onclick="toggleTradingPanel()">
            <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M15 3v18"/>
              <path d="M8 8h4"/>
              <path d="M8 12h4"/>
              <path d="M8 16h4"/>
            </svg>
          </button>
          
          <!-- Chart Layout Toggle -->
          <div class="relative group">
            <button id="chartLayoutToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all" title="Chart Layout">
              <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M12 3v18"/>
                <path d="M3 12h18"/>
              </svg>
            </button>
            
            <!-- Chart Layout Dropdown -->
            <div id="chartLayoutMenu" class="opacity-0 invisible group-hover:opacity-100 group-hover:visible absolute right-full top-0 mr-1 w-32 rounded-md glass-strong p-1 z-50 transition-all duration-200">
              <button data-layout="1" class="w-full text-left px-2 py-2 rounded-[6px] hover:bg-white/10 text-[12px] flex items-center gap-2 chart-layout-option active">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                1 Chart
              </button>
              <button data-layout="2" class="w-full text-left px-2 py-2 rounded-[6px] hover:bg-white/10 text-[12px] flex items-center gap-2 chart-layout-option">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="8" height="18" rx="2"/>
                  <rect x="13" y="3" width="8" height="18" rx="2"/>
                </svg>
                2 Charts
              </button>
              <button data-layout="4" class="w-full text-left px-2 py-2 rounded-[6px] hover:bg-white/10 text-[12px] flex items-center gap-2 chart-layout-option">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="8" height="8" rx="1"/>
                  <rect x="13" y="3" width="8" height="8" rx="1"/>
                  <rect x="3" y="13" width="8" height="8" rx="1"/>
                  <rect x="13" y="13" width="8" height="8" rx="1"/>
                </svg>
                4 Charts
              </button>
            </div>
          </div>
          <button id="bookToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group" title="Order Book" onclick="toggleAux('book')">
            <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 6h18"/>
              <path d="M3 10h12"/>
              <path d="M3 14h18"/>
              <path d="M3 18h8"/>
              <path d="M18 10l3 3-3 3"/>
              <path d="M6 18l-3-3 3-3"/>
            </svg>
          </button>
          <button id="newsToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group" title="News" onclick="toggleAux('news')">
            <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
              <path d="M18 14h-8"/>
              <path d="M15 18h-5"/>
              <path d="M10 6h8v4h-8z"/>
            </svg>
          </button>
          <button id="analyticsToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group" title="Analytics" onclick="toggleAux('analytics')">
            <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 3v18h18"/>
              <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
              <circle cx="18.5" cy="8.5" r="2.5"/>
              <circle cx="10.5" cy="10.5" r="1.5"/>
            </svg>
          </button>
          <button id="signalsToggle" class="h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group" title="Community Signals" onclick="toggleAux('signals')">
            <svg class="w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M2 20h20"/>
              <path d="M7 16v4"/>
              <path d="M12 8v12"/>
              <path d="M17 4v16"/>
              <circle cx="7" cy="16" r="2"/>
              <circle cx="12" cy="8" r="2"/>
              <circle cx="17" cy="4" r="2"/>
            </svg>
          </button>
        </div>
      </div>
    </main>
  </div>

    <!-- Portfolio Section Template (to be moved via JavaScript) -->
    <div id="portfolioSection" style="display: none;">
        <div class="portfolio-section glass border-t border-subtle">



          <!-- Tabs (36px) -->
          <div class="shrink-0 z-30 glass-header border-b border-subtle">
            <div class="h-9 flex items-center px-4">
              <div class="flex-1 flex overflow-x-auto scrollbar-thin">
              <button data-tab="balances" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Balances</button>
              <button data-tab="positions" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Positions</button>
              <button data-tab="openOrders" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Open Orders</button>
              <button data-tab="twap" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">TWAP</button>
              <button data-tab="tradeHistory" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Trade History</button>
              <button data-tab="fundingHistory" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Funding History</button>
              <button data-tab="orderHistory" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Order History</button>
              <button data-tab="activeBots" class="tab-btn relative px-4 h-9 text-[12px] font-medium text-neutral-400 whitespace-nowrap">Active Bots</button>
              </div>
              <!-- Fullscreen Button -->
              <button id="portfolioFullscreen" class="ml-2 h-7 w-7 rounded-md hover:bg-white/5 flex items-center justify-center transition-colors" title="Fullscreen Portfolio" onclick="togglePortfolioFullscreen()">
                <svg class="w-4 h-4 text-neutral-400 hover:text-neutral-200 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
                  <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
                  <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
                  <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
                </svg>
              </button>
              
              <!-- Toggle Button -->
              <button id="portfolioToggle" class="ml-2 h-7 w-7 rounded-md hover:bg-white/5 flex items-center justify-center transition-colors" title="Collapse Portfolio" onclick="togglePortfolioSection()">
                <svg class="w-4 h-4 text-neutral-400 hover:text-neutral-200 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18"/>
                  <path d="M6 6l12 12"/>
                </svg>
              </button>
      </div>
        </div>

                    <!-- Content -->
          <div id="portfolioContent" class="flex-1 overflow-y-auto p-4">

            <!-- Balances -->
            <section id="panel-balances">

              <!-- Balances Table -->
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-10 text-neutral-400">
                      <th class="text-left px-3 font-medium cursor-pointer hover:text-white">Coin</th>
                      <th class="text-right px-3 font-medium cursor-pointer hover:text-white">Total Balance</th>
                      <th class="text-right px-3 font-medium cursor-pointer hover:text-white">Available Balance</th>
                      <th class="text-right px-3 font-medium cursor-pointer hover:text-white">USDC Value</th>
                      <th class="text-right px-3 font-medium cursor-pointer hover:text-white">PNL (ROE%)</th>
                      <th class="text-left px-3 font-medium">Send</th>
                      <th class="text-left px-3 font-medium">Transfer</th>
                      <th class="text-left px-3 font-medium">Contract</th>
                    </tr>
                  </thead>
                  <tbody id="balancesBody" class="divide-y divide-gray-700/30">
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="perp" data-usdc="221.58">
                      <td class="px-3">USDC (Perps)</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">221.58 USDC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">21.64 USDC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$221.58</td>
                      <td class="px-3 text-right mono text-neutral-500">—</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer to Spot</button></td>
                      <td class="px-3 text-neutral-500">—</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="1845.12">
                      <td class="px-3">USDC (Spot)</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">1,845.12 USDC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">1,220.00 USDC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$1,845.12</td>
                      <td class="px-3 text-right mono text-neutral-500">—</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer to Perps</button></td>
                      <td class="px-3 text-neutral-500">—</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="9240.50" data-pnl="+312.11">
                      <td class="px-3">BTC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">0.1420 BTC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">0.0500 BTC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$9,240.50</td>
                      <td class="px-3 text-right mono text-emerald-400">+$312.11 (+3.5%)</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer</button></td>
                      <td class="px-3">Perp</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="9905.40" data-pnl="-118.44">
                      <td class="px-3">ETH</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">2.870 ETH</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">0.900 ETH</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$9,905.40</td>
                      <td class="px-3 text-right mono text-red-400">-$118.44 (-1.2%)</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer</button></td>
                      <td class="px-3">Perp</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="58356.00" data-pnl="+2034.70">
                      <td class="px-3">SOL</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">380.25 SOL</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">120.00 SOL</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$58,356.00</td>
                      <td class="px-3 text-right mono text-emerald-400">+$2,034.70 (+3.6%)</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer</button></td>
                      <td class="px-3">Spot</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="130240.00" data-pnl="-4210.00">
                      <td class="px-3">HYPE</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">2,950 HYPE</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">1,100 HYPE</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$130,240.00</td>
                      <td class="px-3 text-right mono text-red-400">-$4,210.00 (-3.1%)</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer</button></td>
                      <td class="px-3">Perp</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors" data-type="spot" data-usdc="8972.00" data-pnl="+145.00">
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">1,240 IP</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">200 IP</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$8,972.00</td>
                      <td class="px-3 text-right mono text-emerald-400">+$145.00 (+1.6%)</td>
                      <td class="px-3"><button class="text-accent hover:underline">Send</button></td>
                      <td class="px-3"><button class="text-accent hover:underline">Transfer</button></td>
                      <td class="px-3">Perp</td>
                    </tr>
                  </tbody>
                </table>
    </div>
            </section>

            <!-- Positions -->
            <section id="panel-positions" class="hidden">
              <!-- Metrics Strip -->
              <div class="flex flex-wrap gap-2 mb-4">
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">IP · <span class="mono">3x</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Position Value <span class="mono font-semibold">$599.88</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Entry <span class="mono">7.5160</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Mark <span class="mono">7.8416</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">PNL <span class="mono text-emerald-400">+$24.91 (+13.0%)</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Liq <span class="mono">5.9332</span></div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Margin <span class="mono">$199.96</span> (Cross)</div>
                <div class="px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px]">Funding <span class="mono">$0.09</span></div>
  </div>

              <!-- Positions Table -->
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-10 text-neutral-400">
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-right px-3 font-medium">Position Value</th>
                      <th class="text-right px-3 font-medium">Entry Price</th>
                      <th class="text-right px-3 font-medium">Mark Price</th>
                      <th class="text-right px-3 font-medium">PNL (ROE%)</th>
                      <th class="text-right px-3 font-medium">Liq. Price</th>
                      <th class="text-right px-3 font-medium">Margin</th>
                      <th class="text-right px-3 font-medium">Funding</th>
                      <th class="text-left px-3 font-medium">Close All</th>
                      <th class="text-left px-3 font-medium">TP/SL</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3">IP (3x)</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">76.5 IP</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$599.88</td>
                      <td class="px-3 text-right mono">7.5160</td>
                      <td class="px-3 text-right mono">7.8416</td>
                      <td class="px-3 text-right mono text-emerald-400">+$24.91 (+13.0%)</td>
                      <td class="px-3 text-right mono">5.9332</td>
                      <td class="px-3 text-right mono">$199.96 (Cross)</td>
                      <td class="px-3 text-right mono">$0.09</td>
                      <td class="px-3"><button class="text-accent hover:underline">Limit</button> · <button class="text-accent hover:underline">Market</button></td>
                      <td class="px-3">-- / --</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3">BTC (5x Short)</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">0.036 BTC</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$3,960.11</td>
                      <td class="px-3 text-right mono">110,001</td>
                      <td class="px-3 text-right mono">109,720</td>
                      <td class="px-3 text-right mono text-emerald-400">+$113.78 (+2.9%)</td>
                      <td class="px-3 text-right mono">121,500</td>
                      <td class="px-3 text-right mono">$792.02 (Isolated)</td>
                      <td class="px-3 text-right mono">$0.22</td>
                      <td class="px-3"><button class="text-accent hover:underline">Limit</button> · <button class="text-accent hover:underline">Market</button></td>
                      <td class="px-3">107,772 / 111,040</td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3">HYPE (4x Short)</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">47.8 HYPE</td>
                      <td class="px-3 text-right mono font-semibold text-gray-300 hover:text-white">$2,120.64</td>
                      <td class="px-3 text-right mono">44.431</td>
                      <td class="px-3 text-right mono">44.318</td>
                      <td class="px-3 text-right mono text-emerald-400">+$5.35 (+0.3%)</td>
                      <td class="px-3 text-right mono">49.980</td>
                      <td class="px-3 text-right mono">$530.16 (Cross)</td>
                      <td class="px-3 text-right mono">$0.10</td>
                      <td class="px-3"><button class="text-accent hover:underline">Limit</button> · <button class="text-accent hover:underline">Market</button></td>
                      <td class="px-3">44.223 / 44.584</td>
                    </tr>
                  </tbody>
                </table>
        </div>
            </section>

            <!-- All other sections will be added in next parts -->
            <!-- Open Orders -->
            <section id="panel-openOrders" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-10 text-neutral-400">
                      <th class="text-left px-3 font-medium">Time</th>
                      <th class="text-left px-3 font-medium">Type</th>
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-left px-3 font-medium">Direction</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-right px-3 font-medium">Original Size</th>
                      <th class="text-right px-3 font-medium">Order Value</th>
                      <th class="text-right px-3 font-medium">Price</th>
                      <th class="text-left px-3 font-medium">Reduce Only</th>
                      <th class="text-left px-3 font-medium">Trigger Conditions</th>
                      <th class="text-left px-3 font-medium">TP/SL</th>
                      <th class="text-left px-3 font-medium">Cancel</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:02:11</td>
                      <td class="px-3">Limit</td>
                      <td class="px-3">BTC</td>
                      <td class="px-3">Buy</td>
                      <td class="px-3 text-right mono">0.015</td>
                      <td class="px-3 text-right mono">0.030</td>
                      <td class="px-3 text-right mono">$983.40</td>
                      <td class="px-3 text-right mono">65,560</td>
                      <td class="px-3">No</td>
                      <td class="px-3">N/A</td>
                      <td class="px-3">--</td>
                      <td class="px-3"><button class="text-accent hover:underline">Cancel</button></td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:58:02</td>
                      <td class="px-3">Stop Market</td>
                      <td class="px-3">ETH</td>
                      <td class="px-3">Sell</td>
                      <td class="px-3 text-right mono">--</td>
                      <td class="px-3 text-right mono">1.200</td>
                      <td class="px-3 text-right mono">--</td>
                      <td class="px-3 text-right mono">Market</td>
                      <td class="px-3">Yes</td>
                      <td class="px-3">Price below 3,320</td>
                      <td class="px-3">SL</td>
                      <td class="px-3"><button class="text-accent hover:underline">Cancel</button></td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:37:45</td>
                      <td class="px-3">Limit</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3">Sell</td>
                      <td class="px-3 text-right mono">80.0</td>
                      <td class="px-3 text-right mono">80.0</td>
                      <td class="px-3 text-right mono">$12,960.00</td>
                      <td class="px-3 text-right mono">162.00</td>
                      <td class="px-3">No</td>
                      <td class="px-3">N/A</td>
                      <td class="px-3">TP</td>
                      <td class="px-3"><button class="text-accent hover:underline">Cancel</button></td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 08:15:10</td>
                      <td class="px-3">Stop Limit</td>
                      <td class="px-3">IP</td>
                      <td class="px-3">Buy</td>
                      <td class="px-3 text-right mono">30.0</td>
                      <td class="px-3 text-right mono">80.0</td>
                      <td class="px-3 text-right mono">$620.40</td>
                      <td class="px-3 text-right mono">7.65</td>
                      <td class="px-3">No</td>
                      <td class="px-3">Trigger 7.60</td>
                      <td class="px-3">--</td>
                      <td class="px-3"><button class="text-accent hover:underline">Cancel</button></td>
                    </tr>
                  </tbody>
                </table>
      </div>
            </section>

            <!-- TWAP -->
            <section id="panel-twap" class="hidden">
              <!-- Sub-tabs -->
              <div class="flex gap-2 mb-4">
                <button data-twap-tab="active" class="twap-tab px-3 py-1.5 rounded-md border border-white/10 bg-emerald-400 text-black text-[12px] font-medium">Active</button>
                <button data-twap-tab="history" class="twap-tab px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px] font-medium">History</button>
                <button data-twap-tab="fills" class="twap-tab px-3 py-1.5 rounded-md border border-white/10 bg-white/5 text-[12px] font-medium">Fill History</button>
            </div>

              <!-- Active -->
              <div id="twap-active" class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-10 text-neutral-400">
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-right px-3 font-medium">Executed Size</th>
                      <th class="text-right px-3 font-medium">Average Price</th>
                      <th class="text-right px-3 font-medium">Running Time / Total</th>
                      <th class="text-left px-3 font-medium">Reduce Only</th>
                      <th class="text-left px-3 font-medium">Creation Time</th>
                      <th class="text-left px-3 font-medium">Terminate</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3">BTC</td>
                      <td class="px-3 text-right mono">0.120</td>
                      <td class="px-3 text-right mono">0.048</td>
                      <td class="px-3 text-right mono">65,980</td>
                      <td class="px-3 text-right mono">00:08:21 / 00:30:00</td>
                      <td class="px-3">No</td>
                      <td class="px-3 mono">2025/9/03 09:50:00</td>
                      <td class="px-3"><button class="text-accent hover:underline">Terminate</button></td>
                    </tr>
                    <tr class="h-10 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3">ETH</td>
                      <td class="px-3 text-right mono">2.00</td>
                      <td class="px-3 text-right mono">0.60</td>
                      <td class="px-3 text-right mono">3,370</td>
                      <td class="px-3 text-right mono">00:03:05 / 00:15:00</td>
                      <td class="px-3">Yes</td>
                      <td class="px-3 mono">2025/9/03 09:57:00</td>
                      <td class="px-3"><button class="text-accent hover:underline">Terminate</button></td>
                    </tr>
                  </tbody>
                </table>
          </div>

              <!-- History -->
              <div id="twap-history" class="hidden">
                <div class="p-3 rounded-md border border-white/10 bg-white/5 text-[12px]">
                  <div class="text-neutral-400 mb-2">Recent TWAP History</div>
                  <ul class="space-y-1">
                    <li><span class="mono">2025/9/03 10:00:02</span> BTC filled 0.012 @ 66,020</li>
                    <li><span class="mono">2025/9/03 09:56:40</span> ETH filled 0.10 @ 3,372</li>
                    <li><span class="mono">2025/9/03 09:54:02</span> BTC partial 0.006 @ 65,995</li>
                  </ul>
              </div>
            </div>

              <!-- Fills -->
              <div id="twap-fills" class="hidden">
                <div class="p-3 rounded-md border border-white/10 bg-white/5 text-[12px]">
                  <div class="text-neutral-400 mb-2">Fill History</div>
                  <ul class="space-y-1">
                    <li><span class="mono">09:59:01</span> BTC 0.008 @ 66,010</li>
                    <li><span class="mono">09:57:20</span> ETH 0.05 @ 3,371</li>
                    <li><span class="mono">09:54:50</span> BTC 0.004 @ 65,990</li>
                  </ul>
              </div>
            </div>
            </section>

            <!-- Trade History -->
            <section id="panel-tradeHistory" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-9 text-neutral-400">
                      <th class="text-left px-3 font-medium">Time</th>
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-left px-3 font-medium">Direction</th>
                      <th class="text-right px-3 font-medium">Price</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-right px-3 font-medium">Trade Value</th>
                      <th class="text-right px-3 font-medium">Fee</th>
                      <th class="text-right px-3 font-medium">Closed PNL</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:05:30</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">161.90</td>
                      <td class="px-3 text-right mono">40.0 SOL</td>
                      <td class="px-3 text-right mono">6,476.00 USDC</td>
                      <td class="px-3 text-right mono">2.60 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-18.90 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:04:21</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3">Open Short</td>
                      <td class="px-3 text-right mono">162.20</td>
                      <td class="px-3 text-right mono">40.0 SOL</td>
                      <td class="px-3 text-right mono">6,488.00 USDC</td>
                      <td class="px-3 text-right mono">2.60 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-2.60 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:59:00</td>
                      <td class="px-3">BTC</td>
                      <td class="px-3">Open Long</td>
                      <td class="px-3 text-right mono">65,780</td>
                      <td class="px-3 text-right mono">0.0200 BTC</td>
                      <td class="px-3 text-right mono">1,315.60 USDC</td>
                      <td class="px-3 text-right mono">0.66 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-0.66 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:55:12</td>
                      <td class="px-3">ETH</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">3,355</td>
                      <td class="px-3 text-right mono">0.80 ETH</td>
                      <td class="px-3 text-right mono">2,684.00 USDC</td>
                      <td class="px-3 text-right mono">1.34 USDC</td>
                      <td class="px-3 text-right mono text-emerald-400">+9.70 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:20:45</td>
                      <td class="px-3">IP</td>
                      <td class="px-3">Open Long</td>
                      <td class="px-3 text-right mono">7.5200</td>
                      <td class="px-3 text-right mono">62.3 IP</td>
                      <td class="px-3 text-right mono">468.25 USDC</td>
                      <td class="px-3 text-right mono">0.07 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-0.07 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:20:29</td>
                      <td class="px-3">IP</td>
                      <td class="px-3">Open Long</td>
                      <td class="px-3 text-right mono">7.5200</td>
                      <td class="px-3 text-right mono">14.2 IP</td>
                      <td class="px-3 text-right mono">106.73 USDC</td>
                      <td class="px-3 text-right mono">0.02 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-0.02 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/02 15:55:05</td>
                      <td class="px-3">BTC</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">110,061</td>
                      <td class="px-3 text-right mono">0.03681 BTC</td>
                      <td class="px-3 text-right mono">4,051.33 USDC</td>
                      <td class="px-3 text-right mono">1.75 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-3.95 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/02 15:55:03</td>
                      <td class="px-3">BTC</td>
                      <td class="px-3">Open Short</td>
                      <td class="px-3 text-right mono">110,001</td>
                      <td class="px-3 text-right mono">0.03681 BTC</td>
                      <td class="px-3 text-right mono">4,049.14 USDC</td>
                      <td class="px-3 text-right mono">1.75 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-1.75 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/02 14:06:33</td>
                      <td class="px-3">HYPE</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">44.595</td>
                      <td class="px-3 text-right mono">47.66 HYPE</td>
                      <td class="px-3 text-right mono">2,125.40 USDC</td>
                      <td class="px-3 text-right mono">0.92 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-8.75 USDC</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/02 13:55:18</td>
                      <td class="px-3">HYPE</td>
                      <td class="px-3">Open Short</td>
                      <td class="px-3 text-right mono">44.431</td>
                      <td class="px-3 text-right mono">47.66 HYPE</td>
                      <td class="px-3 text-right mono">2,117.57 USDC</td>
                      <td class="px-3 text-right mono">0.91 USDC</td>
                      <td class="px-3 text-right mono text-red-400">-0.91 USDC</td>
                    </tr>
                  </tbody>
                </table>
          </div>
            </section>

            <!-- Funding History -->
            <section id="panel-fundingHistory" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-9 text-neutral-400">
                      <th class="text-left px-3 font-medium">Time</th>
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-left px-3 font-medium">Position Side</th>
                      <th class="text-right px-3 font-medium">Payment</th>
                      <th class="text-right px-3 font-medium">Rate</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:00</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3 text-right mono">120 SOL</td>
                      <td class="px-3">Short</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0301</td>
                      <td class="px-3 text-right mono">0.0010%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0072</td>
                      <td class="px-3 text-right mono">0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 08:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0068</td>
                      <td class="px-3 text-right mono">0.0012%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 07:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0074</td>
                      <td class="px-3 text-right mono">0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 06:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0074</td>
                      <td class="px-3 text-right mono">0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 05:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0075</td>
                      <td class="px-3 text-right mono">0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 04:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-emerald-400">$0.0079</td>
                      <td class="px-3 text-right mono">-0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 03:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0074</td>
                      <td class="px-3 text-right mono">0.0013%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 02:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-red-400">-$0.0066</td>
                      <td class="px-3 text-right mono">0.0011%</td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 01:00</td>
                      <td class="px-3">IP</td>
                      <td class="px-3 text-right mono">76.5 IP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono text-emerald-400">$0.0161</td>
                      <td class="px-3 text-right mono">-0.0027%</td>
                    </tr>
                  </tbody>
                </table>
            </div>
            </section>

            <!-- Order History -->
            <section id="panel-orderHistory" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-9 text-neutral-400">
                      <th class="text-left px-3 font-medium">Time</th>
                      <th class="text-left px-3 font-medium">Type</th>
                      <th class="text-left px-3 font-medium">Coin</th>
                      <th class="text-left px-3 font-medium">Direction</th>
                      <th class="text-right px-3 font-medium">Size</th>
                      <th class="text-right px-3 font-medium">Filled Size</th>
                      <th class="text-right px-3 font-medium">Order Value</th>
                      <th class="text-right px-3 font-medium">Price</th>
                      <th class="text-left px-3 font-medium">Reduce Only</th>
                      <th class="text-left px-3 font-medium">Trigger Conditions</th>
                      <th class="text-left px-3 font-medium">TP/SL</th>
                      <th class="text-left px-3 font-medium">Status</th>
                      <th class="text-left px-3 font-medium">Order ID</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:05:29</td>
                      <td class="px-3">Take Profit Market</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">40.0</td>
                      <td class="px-3 text-right mono">40.0</td>
                      <td class="px-3 text-right mono">--</td>
                      <td class="px-3 text-right mono">Market</td>
                      <td class="px-3">Yes</td>
                      <td class="px-3">Price below 161.95</td>
                      <td class="px-3">--</td>
                      <td class="px-3">Filled</td>
                      <td class="px-3"><button class="text-emerald-400 hover:underline copy-id" data-id="151108880001">151108880001</button></td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 10:04:20</td>
                      <td class="px-3">Market</td>
                      <td class="px-3">SOL</td>
                      <td class="px-3">Short</td>
                      <td class="px-3 text-right mono">40.0</td>
                      <td class="px-3 text-right mono">40.0</td>
                      <td class="px-3 text-right mono">--</td>
                      <td class="px-3 text-right mono">Market</td>
                      <td class="px-3">No</td>
                      <td class="px-3">N/A</td>
                      <td class="px-3">--</td>
                      <td class="px-3">Filled</td>
                      <td class="px-3"><button class="text-emerald-400 hover:underline copy-id" data-id="151108870998">151108870998</button></td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:59:03</td>
                      <td class="px-3">Limit</td>
                      <td class="px-3">BTC</td>
                      <td class="px-3">Long</td>
                      <td class="px-3 text-right mono">0.0200</td>
                      <td class="px-3 text-right mono">0.0200</td>
                      <td class="px-3 text-right mono">$1,315.60</td>
                      <td class="px-3 text-right mono">65,780</td>
                      <td class="px-3">No</td>
                      <td class="px-3">N/A</td>
                      <td class="px-3">--</td>
                      <td class="px-3">Filled</td>
                      <td class="px-3"><button class="text-emerald-400 hover:underline copy-id" data-id="151108820101">151108820101</button></td>
                    </tr>
                    <tr class="h-9 text-gray-400 hover:bg-white/6 hover:text-gray-200 transition-colors">
                      <td class="px-3 mono">2025/9/03 09:55:14</td>
                      <td class="px-3">Market</td>
                      <td class="px-3">ETH</td>
                      <td class="px-3">Close Short</td>
                      <td class="px-3 text-right mono">0.80</td>
                      <td class="px-3 text-right mono">0.80</td>
                      <td class="px-3 text-right mono">--</td>
                      <td class="px-3 text-right mono">Market</td>
                      <td class="px-3">No</td>
                      <td class="px-3">N/A</td>
                      <td class="px-3">--</td>
                      <td class="px-3">Filled</td>
                      <td class="px-3"><button class="text-emerald-400 hover:underline copy-id" data-id="151108800330">151108800330</button></td>
                    </tr>
                  </tbody>
          </table>
          </div>
            </section>

                        <!-- Active Bots -->
            <section id="panel-activeBots" class="hidden">
              <!-- Running Bots Table -->
              <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                  <thead class="border-b border-gray-700/50" class="glass-header">
                    <tr class="h-10 text-neutral-400">
                      <th class="text-left px-3 font-medium">Bot</th>
                      <th class="text-left px-3 font-medium">Market</th>
                      <th class="text-left px-3 font-medium">Side</th>
                      <th class="text-left px-3 font-medium">State</th>
                      <th class="text-right px-3 font-medium">Uptime</th>
                      <th class="text-right px-3 font-medium">Allocated / Leverage</th>
                      <th class="text-left px-3 font-medium">Price Range / Params</th>
                      <th class="text-right px-3 font-medium">Grids Filled</th>
                      <th class="text-right px-3 font-medium">PnL / ROE</th>
                      <th class="text-left px-3 font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700/30">
                    <tr class="h-10 hover:bg-white/6 cursor-pointer bot-row" data-bot="gridbot-perp">
                      <td class="px-3">
                        <div class="font-medium">Gridbot (Perp)</div>
                        <div class="text-[11px] text-neutral-400">Reserved Margin: ON · Start: Instant · Mode: Arithmetic</div>
                      </td>
                      <td class="px-3">BTC-PERP</td>
                      <td class="px-3">Long</td>
                      <td class="px-3">
          <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                          <span>Running</span>
            </div>
                      </td>
                      <td class="px-3 text-right mono">14h 22m</td>
                      <td class="px-3 text-right mono">$350 @ 10x</td>
                      <td class="px-3">59,000 – 66,000</td>
                      <td class="px-3 text-right mono">23 / 80</td>
                      <td class="px-3 text-right mono text-emerald-400">+$56.28 (+12.4%)</td>
                      <td class="px-3">
                        <button class="text-emerald-400 hover:underline mr-2">View</button>
                        <button class="text-accent hover:underline">Pause</button>
                      </td>
                    </tr>
                    <tr class="h-10 hover:bg-white/6 cursor-pointer bot-row" data-bot="gridbot-spot">
                      <td class="px-3">
                        <div class="font-medium">Gridbot (Spot)</div>
                        <div class="text-[11px] text-neutral-400">Simple Earn Allocation: 30% ON · Active Range: ±2% · Mode: Arithmetic</div>
                      </td>
                      <td class="px-3">SOL/USDC</td>
                      <td class="px-3">Neutral</td>
                      <td class="px-3">
                        <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                          <span>Running</span>
          </div>
                      </td>
                      <td class="px-3 text-right mono">3d 2h</td>
                      <td class="px-3 text-right mono">$600</td>
                      <td class="px-3">148.00 – 162.00 · Trailing ±0.8</td>
                      <td class="px-3 text-right mono">41 / 60</td>
                      <td class="px-3 text-right mono text-emerald-400">+$22.17 (+3.7%)</td>
                      <td class="px-3">
                        <button class="text-emerald-400 hover:underline mr-2">View</button>
                        <button class="text-accent hover:underline">Pause</button>
                      </td>
                    </tr>
                    <tr class="h-10 hover:bg-white/6 cursor-pointer bot-row" data-bot="smart-portfolio">
                      <td class="px-3">
                        <div class="font-medium">Smart Portfolio (Spot)</div>
                        <div class="text-[11px] text-neutral-400">Smart allocation; Scheduled daily 02:00; Threshold 3%</div>
                      </td>
                      <td class="px-3">BTC/ETH/SOL/HYPE</td>
                      <td class="px-3">n/a</td>
                      <td class="px-3">
          <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                          <span>Rebalancing</span>
          </div>
                      </td>
                      <td class="px-3 text-right mono">7d 4h</td>
                      <td class="px-3 text-right mono">$2,000</td>
                      <td class="px-3">Smart allocation; Scheduled daily 02:00; Threshold 3%</td>
                      <td class="px-3 text-right mono">—</td>
                      <td class="px-3 text-right mono text-red-400">-$18.52 (-0.9%)</td>
                      <td class="px-3">
                        <button class="text-emerald-400 hover:underline mr-2">View</button>
                        <button class="text-accent hover:underline">Rebalance</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
        </div>

              <!-- Live Bot Logs -->
              <div class="mt-6">
                <div class="text-[12px] font-medium mb-3">Live Bot Logs</div>
                <div id="botLogs" class="p-3 rounded-md border border-white/10 bg-white/5 text-[11px] mono space-y-1">
                  <div>10:04:58 Placed buy 0.0020 @ 62,310 (grid #22)</div>
                  <div>09:57:41 Filled sell 0.0020 @ 62,680 (TP +0.6%)</div>
                  <div>09:31:02 Adjusted upper to 66,000 (volatility +)</div>
                  <div>09:10:15 Funding paid -$0.12 (1h)</div>
                  <div>08:55:09 Health check: margin ratio 22.1%</div>
          </div>
            </div>
            </section>

          </div>
        </div>
        </div>
    </div>

  <!-- Enhanced Modals -->

  <!-- Command Palette -->
  <div id="commandPalette" class="fixed inset-0 hidden items-start justify-center pt-24 z-[70]">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCommandPalette(false)"></div>
    <div class="relative w-full max-w-xl rounded-lg glass-strong shadow-elevated p-2">
      <div class="h-10 px-2 rounded-md border flex items-center gap-2 border-subtle">
        <i data-lucide="search" class="w-4 h-4"></i>
        <input id="commandInput" placeholder="Search pairs, actions..." class="flex-1 bg-transparent outline-none text-[13px]" />
        <span class="text-[11px] text-gray-400">ESC</span>
      </div>
      <div class="mt-2 max-h-72 overflow-auto">
        <div class="px-2 py-2 text-[11px] uppercase text-gray-400">Suggestions</div>
        <ul class="px-1" id="commandResults">
          <li class="h-10 px-2 rounded-md flex items-center justify-between hover:bg-white/5 cursor-pointer">
            <span>Open BTC-PERP</span><span class="mono text-[12px] text-gray-400">Market</span>
          </li>
          <li class="h-10 px-2 rounded-md flex items-center justify-between hover:bg-white/5 cursor-pointer">
            <span>Deposit Funds</span><span class="mono text-[12px] text-gray-400">Action</span>
          </li>
          <li class="h-10 px-2 rounded-md flex items-center justify-between hover:bg-white/5 cursor-pointer">
            <span>Toggle Order Book</span><span class="mono text-[12px] text-gray-400">Panel</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Leverage Modal (Compact Enhanced UX) -->
  <div id="levModal" class="hidden fixed inset-0 z-[80] items-center justify-center">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-[3px]" data-close="lev"></div>
    <div class="relative w-full max-w-sm mx-4 rounded-xl glass-strong shadow-elevated overflow-hidden">
      
      <!-- Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
        <div>
          <div class="text-[14px] font-semibold text-white">Leverage & Margin</div>
          <div id="levContext" class="text-[11px] text-neutral-400">Control leverage for BTC positions</div>
          </div>
        <button class="h-7 w-7 inline-flex items-center justify-center rounded-md hover:bg-white/10 ring-1 ring-white/10 transition-colors" data-close="lev">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
          </div>
      
      <!-- Content -->
      <div class="px-4 py-4 space-y-4">
        
        <!-- Margin Mode Section -->
        <div class="space-y-2">
          <div class="text-[13px] font-semibold text-white">Margin Mode</div>
          <div class="flex gap-1.5">
            <button id="crossMarginBtn" class="flex-1 px-3 py-2 rounded-md ring-1 ring-white/10 bg-white/5 hover:bg-white/10 transition-colors text-[11px] text-neutral-300">
              Cross
            </button>
            <button id="isolatedMarginBtn" class="flex-1 px-3 py-2 rounded-md ring-1 ring-emerald-400/30 bg-emerald-400/10 text-emerald-300 text-[11px] font-medium">
              ✓ Isolated
            </button>
          </div>
          <div class="text-[10px] text-neutral-400 leading-relaxed">
            Isolated mode: margin ratio at 100% triggers liquidation. Margin can be adjusted per position.
          </div>
        </div>
        
        <!-- Leverage Section -->
        <div class="space-y-3">
      <div class="flex items-center justify-between">
            <div class="text-[13px] font-semibold text-white">Leverage</div>
            <!-- Big Leverage Display -->
            <div class="px-3 py-1.5 rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm">
              <span id="levValueLabel" class="text-[24px] font-bold mono text-emerald-300">6</span>
              <span class="text-[16px] font-bold mono text-neutral-400 ml-1">x</span>
      </div>
          </div>
          
          <!-- Custom Slider (Trading Panel Style) -->
          <div class="space-y-2">
        <div class="flex items-center gap-2">
              <!-- Slider Container -->
              <div class="flex-1 relative">
                <!-- Slider Track -->
                <div class="h-2 rounded-md ring-1 ring-white/10 bg-white/5 backdrop-blur-sm relative overflow-hidden">
                  <!-- Active Progress -->
                  <div id="levSliderProgress" class="h-full bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600 rounded-sm transition-all duration-200" style="width: 15%"></div>
                  <!-- Slider Handle -->
                  <div id="levSliderHandle" class="absolute top-1/2 -translate-y-1/2 w-5 h-5 rounded-md ring-1 ring-white/20 bg-white/90 backdrop-blur-sm cursor-pointer transition-all duration-200 shadow-lg" style="left: calc(15% - 10px)"></div>
        </div>
                <!-- Hidden Range Input -->
                <input id="levRange" type="range" min="1" max="40" value="6" step="1" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
        </div>
              
              <!-- Plus/Minus Controls -->
              <div class="flex items-center gap-1">
                <button id="levDecrease" class="w-7 h-7 rounded-md ring-1 ring-white/10 bg-white/5 hover:bg-white/10 transition-colors flex items-center justify-center">
                  <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14"/>
                  </svg>
                </button>
                <button id="levIncrease" class="w-7 h-7 rounded-md ring-1 ring-white/10 bg-white/5 hover:bg-white/10 transition-colors flex items-center justify-center">
                  <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                </button>
        </div>
        </div>
            
            <!-- Quick Select Buttons -->
            <div class="flex justify-between items-center px-1">
              <button class="lev-quick-btn text-[10px] font-medium text-neutral-400 hover:text-emerald-300 transition-colors cursor-pointer" data-lev="5">5x</button>
              <button class="lev-quick-btn text-[10px] font-medium text-neutral-400 hover:text-emerald-300 transition-colors cursor-pointer" data-lev="10">10x</button>
              <button class="lev-quick-btn text-[10px] font-medium text-neutral-400 hover:text-emerald-300 transition-colors cursor-pointer" data-lev="20">20x</button>
              <button class="lev-quick-btn text-[10px] font-medium text-neutral-400 hover:text-emerald-300 transition-colors cursor-pointer" data-lev="30">30x</button>
              <button class="lev-quick-btn text-[10px] font-medium text-neutral-400 hover:text-emerald-300 transition-colors cursor-pointer" data-lev="40">40x</button>
        </div>
          </div>
        </div>
        
        <!-- Risk Information with Fake Data -->
        <div class="space-y-2 rounded-md ring-1 ring-white/5 bg-white/5 p-3">
          <div class="flex justify-between text-[11px]">
            <span class="text-neutral-400">Maintenance margin</span>
            <span class="text-white mono" id="maintMarginValue">$142.50</span>
          </div>
          <div class="flex justify-between text-[11px]">
            <span class="text-neutral-400">Liquidation price</span>
            <span class="text-red-400 mono" id="liqPriceValue">$58,250</span>
          </div>
          <div class="flex justify-between text-[11px]">
            <span class="text-neutral-400">Max position size</span>
            <span class="text-emerald-300 mono" id="maxPosValue">$17,000</span>
          </div>
        </div>
        
        <!-- Compact Warning -->
        <div class="rounded-md ring-1 ring-orange-400/20 bg-orange-400/10 p-2">
          <div class="flex gap-2 items-start">
            <svg class="w-3.5 h-3.5 text-orange-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
            </svg>
            <div>
              <div class="text-[11px] font-medium text-orange-300">High Leverage Risk</div>
              <div class="text-[10px] text-orange-200 mt-0.5 leading-relaxed">
                Higher leverage increases both potential gains and losses significantly.
              </div>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="px-4 py-3 border-t border-white/10">
        <button id="levApply" class="w-full py-2.5 rounded-md font-semibold text-[13px] text-emerald-900 transition-all duration-200" style="background: linear-gradient(135deg, #10B981, #34D399); box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);">
          Apply Changes
        </button>
      </div>
      
      </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed inset-x-0 bottom-6 flex flex-col items-center gap-2 z-[90] pointer-events-none"></div>

  <!-- Mobile Trade Sheet -->
  <div id="mobileTradeSheet" class="md:hidden fixed left-0 right-0 bottom-0 translate-y-full transition-transform duration-200 z-[85]">
    <div class="rounded-t-2xl glass-strong border-t p-3 border-subtle">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[14px] font-semibold">Quick Trade</div>
        <button class="h-8 w-8 rounded-md btn-secondary flex items-center justify-center" onclick="toggleMobileTradeSheet(false)">
          <i data-lucide="chevron-down" class="w-4 h-4"></i>
        </button>
            </div>
      <div class="text-[13px] text-gray-300">Mobile trading interface - use desktop for full experience</div>
    </div>
  </div>

  <script>
    // Initialize icons and TradingView
    // Move portfolio to left column
    function movePortfolioToLeftColumn() {
      const portfolioTemplate = document.getElementById('portfolioSection');
      const portfolioTarget = document.querySelector('.left-column .portfolio-section');
      
      if (portfolioTemplate && portfolioTarget) {
        // Move the content from template to target
        const portfolioContent = portfolioTemplate.querySelector('.portfolio-section');
        if (portfolioContent) {
          portfolioTarget.innerHTML = portfolioContent.innerHTML;
        }
        // Remove the template
        portfolioTemplate.remove();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Move portfolio to correct position first
      movePortfolioToLeftColumn();
      
      if (window.lucide && lucide.createIcons) {
        lucide.createIcons();
      }
      initializeApp();
      
      // Direct TradingView initialization
      function tryInitTradingView() {
        if (window.TradingView) {
          console.log('Direct TradingView initialization...');
          new TradingView.widget({
            autosize: true,
            symbol: 'BINANCE:BTCUSDT',
            interval: '60',
            timezone: 'Etc/UTC',
            theme: 'dark',
            style: 1,
            locale: 'en',
            toolbar_bg: '#0a0a0a',
            enable_publishing: false,
            hide_top_toolbar: false,
            hide_legend: false,
            save_image: false,
            container_id: 'tradingview_widget',
            studies: [
              'Volume@tv-basicstudies',
              'MACD@tv-basicstudies'
            ],
            overrides: {
              'paneProperties.background': '#0a0a0a',
              'paneProperties.backgroundType': 'solid',
              'scalesProperties.textColor': '#b0b0b0',
              'scalesProperties.backgroundColor': '#111111',
              'mainSeriesProperties.candleStyle.upColor': '#6EE7B7',
              'mainSeriesProperties.candleStyle.downColor': '#FF5A5F',
              'mainSeriesProperties.candleStyle.drawWick': true,
              'mainSeriesProperties.candleStyle.drawBorder': true,
              'mainSeriesProperties.candleStyle.borderColor': '#6EE7B7',
              'mainSeriesProperties.candleStyle.borderUpColor': '#6EE7B7',
              'mainSeriesProperties.candleStyle.borderDownColor': '#FF5A5F',
              'volumePaneSize': 'medium'
            }
          });
        } else {
          setTimeout(tryInitTradingView, 500);
        }
      }
      
      setTimeout(tryInitTradingView, 1000);
    });



    // Main App Initialization
    function initializeApp() {
      // State management
      const appState = {
        tab: 'trade',
        orderType: 'Market',
        proType: null,
        side: 'long',
        asset: 'ETH',
        prices: { ETH: 3500, BTC: 65000, SOL: 150 },
        leverage: 20,
        reduceOnly: false,
        activeTab: 'balances',
        // grid
        grid: {
          active: false,
          context: 'Futures Grid',
          side: 'long',
          gm: 'Arithmetic',
          start: 'Instant',
          lev: 10,
          lower: 52000,
          upper: 60000,
          qty: 25,
          margin: 250,
          reserved: false
        }
      };

      // Utility functions
      const $ = (selector) => document.querySelector(selector);
      const $$ = (selector) => document.querySelectorAll(selector);
      const fmt = (num, decimals = 2) => Number(num).toLocaleString(undefined, { 
        minimumFractionDigits: decimals, 
        maximumFractionDigits: decimals 
      });

      // Toast system
      function showToast(message, type = 'info') {
        const container = $('#toastContainer');
        const toast = document.createElement('div');
        toast.className = 'pointer-events-auto rounded-md glass-strong px-3 py-2 text-[13px] flex items-center gap-2 shadow-elevated fade-in';
        
        const icon = type === 'success' ? 'check-circle-2' : type === 'error' ? 'alert-triangle' : 'info';
        toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i><span>${message}</span>`;
        
        container.appendChild(toast);
        lucide.createIcons();
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(-10px)';
          setTimeout(() => toast.remove(), 200);
        }, 3000);
      }

    // Command Palette
      function toggleCommandPalette(show) {
        const palette = $('#commandPalette');
        palette.classList.toggle('hidden', !show);
        palette.classList.toggle('flex', show);
        if (show) $('#commandInput').focus();
      }
      
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          toggleCommandPalette(true);
        }
        if (e.key === 'Escape') {
          toggleCommandPalette(false);
          closeLev();
          const proMenu = $('#proMenu');
          if (proMenu) proMenu.classList.add('hidden');
        }
      });

      // Tabs: Trade / Strategies
      const tradeMode = $('#tradeMode');
      const strategiesMode = $('#strategiesMode');
      const gridSetup = $('#gridSetup');
      const tabTrade = $('#tabTrade');
      const tabStrategies = $('#tabStrategies');
      
      $('#tabTrade').addEventListener('click', () => {
        appState.tab = 'trade';
        tradeMode.classList.remove('hidden');
        strategiesMode.classList.add('hidden');
        gridSetup.classList.add('hidden');
        // Update tab styling
        tabTrade.classList.remove('text-neutral-400');
        tabTrade.classList.add('text-white');
        tabStrategies.classList.remove('text-white');
        tabStrategies.classList.add('text-neutral-400');
      });
      
      $('#tabStrategies').addEventListener('click', () => {
        appState.tab = 'strategies';
        strategiesMode.classList.remove('hidden');
        tradeMode.classList.add('hidden');
        gridSetup.classList.add('hidden');
        // Update tab styling
        tabStrategies.classList.remove('text-neutral-400');
        tabStrategies.classList.add('text-white');
        tabTrade.classList.remove('text-white');
        tabTrade.classList.add('text-neutral-400');
      });

      // Asset is fixed to ETH (dropdown removed)

      // Order type tabs
      const priceField = $('#priceField');
      const priceInput = $('#priceInput');
      const priceHint = $('#priceHint');
      
      const orderTypeSlider = $('#orderTypeSlider');
      
      $('#orderMarket').addEventListener('click', () => {
        appState.orderType = 'Market'; 
        appState.proType = null;
        orderTypeSlider.className = orderTypeSlider.className.replace(/order-(market|limit|pro)/g, '') + ' order-market';
        $('#orderMarket').classList.remove('text-neutral-400');
        $('#orderLimit').classList.add('text-neutral-400');
        $('#orderPro').classList.add('text-neutral-400');
        // Show regular inputs, hide scale UI
        $('#regularInputs').classList.remove('hidden');
        $('#scaleUI').classList.add('hidden');
        $('#twapUI').classList.add('hidden');
        $('#stopPriceSection').classList.add('hidden');
        // Show TP/SL toggles for Market
        const tpSlToggleSection = $('#tpSlToggle').parentElement;
        tpSlToggleSection.style.display = 'flex';
        // Show Buy/Sell toggle for Market
        $('#buySellToggle').style.display = 'block';
        // Restore button text based on current side
        $('#placeOrder').querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        disablePrice(true, 'auto for Market');
        updateSummary();
      });
      
      $('#orderLimit').addEventListener('click', () => {
        appState.orderType = 'Limit'; 
        appState.proType = null;
        orderTypeSlider.className = orderTypeSlider.className.replace(/order-(market|limit|pro)/g, '') + ' order-limit';
        $('#orderMarket').classList.add('text-neutral-400');
        $('#orderLimit').classList.remove('text-neutral-400');
        $('#orderPro').classList.add('text-neutral-400');
        // Show regular inputs, hide scale UI
        $('#regularInputs').classList.remove('hidden');
        $('#scaleUI').classList.add('hidden');
        $('#twapUI').classList.add('hidden');
        $('#stopPriceSection').classList.add('hidden');
        // Show TP/SL toggles for Limit
        const tpSlToggleSection = $('#tpSlToggle').parentElement;
        tpSlToggleSection.style.display = 'flex';
        // Show Buy/Sell toggle for Limit
        $('#buySellToggle').style.display = 'block';
        // Restore button text based on current side
        $('#placeOrder').querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        disablePrice(false, 'enter price');
        updateSummary();
      });

      // Pro dropdown
      const proMenu = $('#proMenu');
      $('#orderPro').addEventListener('click', (e) => {
        e.stopPropagation();
        orderTypeSlider.className = orderTypeSlider.className.replace(/order-(market|limit|pro)/g, '') + ' order-pro';
        $('#orderMarket').classList.add('text-neutral-400');
        $('#orderLimit').classList.add('text-neutral-400');
        $('#orderPro').classList.remove('text-neutral-400');
        proMenu.classList.toggle('hidden');
      });
      
      proMenu.addEventListener('click', (e) => {
        const b = e.target.closest('button[data-pro]');
        if (!b) return;
        appState.orderType = 'Pro';
        appState.proType = b.dataset.pro;
        $('#orderPro span:first-child').textContent = appState.proType;
        
        // Clear all UIs first to prevent mixing
        const scaleUI = $('#scaleUI');
        const regularInputs = $('#regularInputs');
        const twapUI = $('#twapUI');
        const stopPriceSection = $('#stopPriceSection');
        const tpSlToggleSection = $('#tpSlToggle').parentElement;
        const buySellToggle = $('#buySellToggle');
        const placeOrderBtn = $('#placeOrder');
        
        // Hide all UIs first
        scaleUI.classList.add('hidden');
        regularInputs.classList.add('hidden');
        twapUI.classList.add('hidden');
        stopPriceSection.classList.add('hidden');
        
        // Then show the appropriate UI based on order type
        if (appState.proType === 'Scale') {
          scaleUI.classList.remove('hidden');
          // TP/SL not available for Scale
          tpSlToggleSection.style.display = 'none';
          // Show Buy/Sell toggle for Scale
          buySellToggle.style.display = 'block';
          // Restore original button text based on current side
          placeOrderBtn.querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        } else if (appState.proType === 'Stop Limit') {
          regularInputs.classList.remove('hidden');
          stopPriceSection.classList.remove('hidden');
          // TP/SL not available for Stop Limit
          tpSlToggleSection.style.display = 'none';
          // Show Buy/Sell toggle for Stop Limit
          buySellToggle.style.display = 'block';
          // Restore original button text based on current side
          placeOrderBtn.querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        } else if (appState.proType === 'Stop Market') {
          regularInputs.classList.remove('hidden');
          stopPriceSection.classList.remove('hidden');
          // TP/SL not available for Stop Market
          tpSlToggleSection.style.display = 'none';
          // Show Buy/Sell toggle for Stop Market
          buySellToggle.style.display = 'block';
          // Restore original button text based on current side
          placeOrderBtn.querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        } else if (appState.proType === 'TWAP') {
          twapUI.classList.remove('hidden');
          // TP/SL not available for TWAP
          tpSlToggleSection.style.display = 'none';
          // Show Buy/Sell toggle for TWAP
          buySellToggle.style.display = 'block';
          // Restore original button text based on current side
          placeOrderBtn.querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        } else {
          regularInputs.classList.remove('hidden');
          // TP/SL not available for other Pro options
          tpSlToggleSection.style.display = 'none';
          // Show Buy/Sell toggle for other Pro options
          buySellToggle.style.display = 'block';
          // Restore original button text based on current side
          placeOrderBtn.querySelector('span').textContent = appState.side === 'long' ? 'Place Long' : 'Place Short';
        }
        
        // Price enable rules
        if (appState.proType === 'Stop Limit' || appState.proType === 'TWAP' || appState.proType === 'Scale') {
          disablePrice(false, 'enter price');
      } else {
          disablePrice(true, 'auto for Stop Market');
        }
        proMenu.classList.add('hidden');
        updateSummary();
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!$('#orderPro').contains(e.target)) {
          proMenu.classList.add('hidden');
        }
      });

      function disablePrice(disabled, hint='') {
        priceInput.disabled = disabled;
        priceField.classList.toggle('opacity-60', disabled);
        priceHint.textContent = hint;
        priceInput.placeholder = disabled ? 'Market' : 'e.g. 3550';
      }

      // Side toggle
      const longBtn = $('#longBtn');
      const shortBtn = $('#shortBtn');
      const sideSlider = $('#sideSlider');
      const placeOrder = $('#placeOrder');
      
      longBtn.addEventListener('click', () => setSide('long'));
      shortBtn.addEventListener('click', () => setSide('short'));
      
      function setSide(side) {
        appState.side = side;
        if (side === 'long') {
          sideSlider.className = sideSlider.className.replace(/side-(long|short)/g, '') + ' side-long';
          longBtn.classList.remove('opacity-60'); 
          longBtn.classList.add('text-emerald-300');
          shortBtn.classList.add('opacity-60');
          shortBtn.classList.remove('text-rose-300');
          placeOrder.querySelector('span').textContent = 'Place Long';
          // Set place order button to bright emerald with glassy hover effect
          placeOrder.style.background = 'linear-gradient(135deg, #10B981, #34D399)';
          placeOrder.style.color = '#064E3B';
          placeOrder.style.fontWeight = '700';
          placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.2)';
          placeOrder.classList.remove('text-black', 'btn-primary', 'bg-red-500', 'text-red-900');
          placeOrder.classList.add('text-emerald-900', 'font-bold');
          // Add hover effect
          placeOrder.onmouseenter = () => {
            placeOrder.style.background = 'linear-gradient(135deg, #34D399, #6EE7B7)';
            placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.4), 0 0 20px rgba(16,185,129,0.3)';
            placeOrder.style.transform = 'translateY(-1px)';
          };
          placeOrder.onmouseleave = () => {
            placeOrder.style.background = 'linear-gradient(135deg, #10B981, #34D399)';
            placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.2)';
            placeOrder.style.transform = 'translateY(0)';
          };
      } else {
          sideSlider.className = sideSlider.className.replace(/side-(long|short)/g, '') + ' side-short';
          shortBtn.classList.remove('opacity-60'); 
          shortBtn.classList.add('text-rose-300');
          longBtn.classList.add('opacity-60');
          longBtn.classList.remove('text-emerald-300');
          placeOrder.querySelector('span').textContent = 'Place Short';
          // Set place order button to bright red with glassy hover effect
          placeOrder.style.background = 'linear-gradient(135deg, #EF4444, #F87171)';
          placeOrder.style.color = '#7F1D1D';
          placeOrder.style.fontWeight = '700';
          placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.2)';
          placeOrder.classList.remove('text-black', 'btn-primary', 'text-emerald-900');
          placeOrder.classList.add('text-red-900', 'font-bold');
          // Add hover effect
          placeOrder.onmouseenter = () => {
            placeOrder.style.background = 'linear-gradient(135deg, #F87171, #FCA5A5)';
            placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.4), 0 0 20px rgba(239,68,68,0.3)';
            placeOrder.style.transform = 'translateY(-1px)';
          };
          placeOrder.onmouseleave = () => {
            placeOrder.style.background = 'linear-gradient(135deg, #EF4444, #F87171)';
            placeOrder.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.2)';
            placeOrder.style.transform = 'translateY(0)';
          };
        }
        updateSummary();
      }

      // Reduce Only toggle (turns green when enabled)
      const reduceToggle = $('#reduceToggle');
      const reduceKnob = $('#reduceKnob');
      
      reduceToggle.addEventListener('click', () => {
        appState.reduceOnly = !appState.reduceOnly;
        if (appState.reduceOnly) {
          reduceToggle.classList.add('ring-emerald-400/40');
          reduceToggle.querySelector('span.relative').classList.add('bg-emerald-400/20', 'ring-emerald-300/40');
          reduceKnob.style.transform = 'translate(12px, -50%)';
          reduceKnob.classList.remove('bg-neutral-300');
          reduceKnob.classList.add('bg-emerald-300');
          reduceToggle.querySelector('span.text-[12px]').classList.add('text-emerald-300');
        } else {
          reduceToggle.classList.remove('ring-emerald-400/40');
          reduceToggle.querySelector('span.relative').classList.remove('bg-emerald-400/20', 'ring-emerald-300/40');
          reduceKnob.style.transform = 'translate(0, -50%)';
          reduceKnob.classList.remove('bg-emerald-300');
          reduceKnob.classList.add('bg-neutral-300');
          reduceToggle.querySelector('span.text-[12px]').classList.remove('text-emerald-300');
        }
      });

      // TP / SL toggle functionality
      const tpSlToggle = $('#tpSlToggle');
      const tpSlKnob = $('#tpSlKnob');
      const tpSlFields = $('#tpSlFields');
      
      // Initialize TP/SL as hidden by default
      let tpSlEnabled = false;
      tpSlFields.style.display = 'none';
      
      tpSlToggle.addEventListener('click', () => {
        tpSlEnabled = !tpSlEnabled;
        
        if (tpSlEnabled) {
          // Enable TP/SL - show fields and turn knob green (exact same styling as Reduce Only)
          tpSlFields.style.display = 'block';
          tpSlToggle.classList.add('ring-emerald-400/40');
          tpSlToggle.querySelector('span.relative').classList.add('bg-emerald-400/20', 'ring-emerald-300/40');
          tpSlKnob.style.transform = 'translate(12px, -50%)';
          tpSlKnob.classList.remove('bg-neutral-300');
          tpSlKnob.classList.add('bg-emerald-300');
          tpSlToggle.querySelector('span.text-[12px]').classList.add('text-emerald-300');
        } else {
          // Disable TP/SL - hide fields and turn knob neutral (exact same styling as Reduce Only)
          tpSlFields.style.display = 'none';
          tpSlToggle.classList.remove('ring-emerald-400/40');
          tpSlToggle.querySelector('span.relative').classList.remove('bg-emerald-400/20', 'ring-emerald-300/40');
          tpSlKnob.style.transform = 'translate(0, -50%)';
          tpSlKnob.classList.remove('bg-emerald-300');
          tpSlKnob.classList.add('bg-neutral-300');
          tpSlToggle.querySelector('span.text-[12px]').classList.remove('text-emerald-300');
        }
      });

      // Size controls (% of balance) - Custom Slider
      const sizeSlider = $('#sizeSlider');
      const sizeInput = $('#sizeInput');
      const sliderProgress = $('#sliderProgress');
      const sliderHandle = $('#sliderHandle');
      const amountInput = $('#amountInput');
      
      function syncPercent(val) {
        val = Math.max(0, Math.min(100, Number(val) || 0));
        sizeSlider.value = val; 
        sizeInput.value = val;
        
        // Update custom slider visuals
        updateSliderVisuals(val);
        
        // Update percentage button states
        updatePercentageButtons(val);
        
        // Map % of availBalance to amount assuming current input mode
        const avail = parseFloat($('#availBalance').textContent) || 0;
        const px = currentPrice();
        const usd = avail * val / 100;
        
        // Update amount input based on current display mode
        if (amountDisplayMode === 'USDT') {
          amountInput.value = usd ? usd.toFixed(2) : '';
        } else {
        const qty = px > 0 ? usd / px : 0;
          amountInput.value = qty ? qty.toFixed(4) : '';
        }
        updateAmountDisplay();
        updateSummary();
      }
      
      function updateSliderVisuals(val) {
        const percentage = val + '%';
        sliderProgress.style.width = percentage;
        sliderHandle.style.left = `calc(${percentage} - 10px)`; // Offset for handle center
      }
      
      function updatePercentageButtons(val) {
        // Remove active state from all buttons
        document.querySelectorAll('.percentage-btn').forEach(btn => {
          btn.classList.remove('text-emerald-400', 'font-semibold');
          btn.classList.add('text-neutral-400');
        });
        
        // Add active state to current percentage button (if exact match)
        const activeBtn = document.querySelector(`[data-percent="${val}"]`);
        if (activeBtn) {
          activeBtn.classList.remove('text-neutral-400');
          activeBtn.classList.add('text-emerald-400', 'font-semibold');
        }
      }
      
      sizeSlider.addEventListener('input', e => syncPercent(e.target.value));
      sizeInput.addEventListener('input', e => syncPercent(e.target.value));
      
      // Percentage button clicks
      document.querySelectorAll('.percentage-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const percent = parseInt(btn.dataset.percent);
          syncPercent(percent);
        });
      });
      
        // TWAP UI functionality
        const twapSlider = document.getElementById('twapSlider');
        const twapSliderProgress = document.getElementById('twapSliderProgress');
        const twapSliderHandle = document.getElementById('twapSliderHandle');
        const twapPercentage = document.getElementById('twapPercentage');
        
        if (twapSlider) {
          twapSlider.addEventListener('input', function() {
            const value = this.value;
            twapSliderProgress.style.width = value + '%';
            twapSliderHandle.style.left = `calc(${value}% - 10px)`;
            twapPercentage.textContent = value;
          });
        }

        // TWAP Randomize toggle functionality
        const twapRandomizeToggle = $('#twapRandomizeToggle');
        const twapRandomizeKnob = $('#twapRandomizeKnob');
        
        if (twapRandomizeToggle) {
          let twapRandomizeEnabled = false;
          twapRandomizeToggle.addEventListener('click', () => {
            twapRandomizeEnabled = !twapRandomizeEnabled;
            if (twapRandomizeEnabled) {
              twapRandomizeToggle.classList.add('ring-emerald-400/40');
              twapRandomizeToggle.querySelector('span.relative').classList.add('bg-emerald-400/20', 'ring-emerald-300/40');
              twapRandomizeKnob.style.transform = 'translate(12px, -50%)';
              twapRandomizeKnob.classList.remove('bg-neutral-300');
              twapRandomizeKnob.classList.add('bg-emerald-300');
              twapRandomizeToggle.querySelector('span.text-[12px]').classList.add('text-emerald-300');
            } else {
              twapRandomizeToggle.classList.remove('ring-emerald-400/40');
              twapRandomizeToggle.querySelector('span.relative').classList.remove('bg-emerald-400/20', 'ring-emerald-300/40');
              twapRandomizeKnob.style.transform = 'translate(0, -50%)';
              twapRandomizeKnob.classList.remove('bg-emerald-300');
              twapRandomizeKnob.classList.add('bg-neutral-300');
              twapRandomizeToggle.querySelector('span.text-[12px]').classList.remove('text-emerald-300');
            }
          });
        }

        // TWAP Reduce Only toggle functionality
        const twapReduceOnlyToggle = $('#twapReduceOnlyToggle');
        const twapReduceOnlyKnob = $('#twapReduceOnlyKnob');
        
        if (twapReduceOnlyToggle) {
          let twapReduceOnlyEnabled = false;
          twapReduceOnlyToggle.addEventListener('click', () => {
            twapReduceOnlyEnabled = !twapReduceOnlyEnabled;
            if (twapReduceOnlyEnabled) {
              twapReduceOnlyToggle.classList.add('ring-emerald-400/40');
              twapReduceOnlyToggle.querySelector('span.relative').classList.add('bg-emerald-400/20', 'ring-emerald-300/40');
              twapReduceOnlyKnob.style.transform = 'translate(12px, -50%)';
              twapReduceOnlyKnob.classList.remove('bg-neutral-300');
              twapReduceOnlyKnob.classList.add('bg-emerald-300');
              twapReduceOnlyToggle.querySelector('span.text-[12px]').classList.add('text-emerald-300');
            } else {
              twapReduceOnlyToggle.classList.remove('ring-emerald-400/40');
              twapReduceOnlyToggle.querySelector('span.relative').classList.remove('bg-emerald-400/20', 'ring-emerald-300/40');
              twapReduceOnlyKnob.style.transform = 'translate(0, -50%)';
              twapReduceOnlyKnob.classList.remove('bg-emerald-300');
              twapReduceOnlyKnob.classList.add('bg-neutral-300');
              twapReduceOnlyToggle.querySelector('span.text-[12px]').classList.remove('text-emerald-300');
            }
          });
        }

        // Scale UI functionality
      const scaleSlider = $('#scaleSlider');
      const scaleSliderProgress = $('#scaleSliderProgress');
      const scaleSliderHandle = $('#scaleSliderHandle');
      const scalePercentage = $('#scalePercentage');
      
      function updateScaleSliderVisuals(val) {
        const percentage = val + '%';
        scaleSliderProgress.style.width = percentage;
        scaleSliderHandle.style.left = `calc(${percentage} - 10px)`;
        scalePercentage.textContent = val;
        
        // Update dots based on percentage
        updateScaleDots(val);
      }
      
      function updateScaleDots(val) {
        const dots = document.querySelectorAll('#scaleUI .w-2.h-2');
        const activeCount = Math.ceil((val / 100) * 5);
        
        dots.forEach((dot, index) => {
          if (index < activeCount) {
            dot.classList.remove('bg-neutral-600');
            dot.classList.add('bg-emerald-400');
            if (index === activeCount - 1) {
              dot.classList.add('ring-2', 'ring-emerald-400/50');
            } else {
              dot.classList.remove('ring-2', 'ring-emerald-400/50');
            }
          } else {
            dot.classList.remove('bg-emerald-400', 'ring-2', 'ring-emerald-400/50');
            dot.classList.add('bg-neutral-600');
          }
        });
      }
      
      if (scaleSlider) {
        scaleSlider.addEventListener('input', (e) => {
          updateScaleSliderVisuals(e.target.value);
        });
        
        // Initialize scale slider
        updateScaleSliderVisuals(94);
      }
      amountInput.addEventListener('input', () => {
        updateAmountDisplay();
        updateSummary();
      });

      // Amount toggle functionality
      let amountDisplayMode = 'USDT'; // Current input mode: 'USDT' or 'BTC'
      
      window.toggleAmountDisplay = function() {
        const amountDisplayValue = document.getElementById('amountDisplayValue');
        const amountDisplayUnit = document.getElementById('amountDisplayUnit');
        const amountInput = document.getElementById('amountInput');
        
        const price = currentPrice() || 65000; // Get current price
        const currentInputValue = parseFloat(amountInput.value) || 0;
        
        if (amountDisplayMode === 'USDT') {
          // Switch to BTC input mode
          amountDisplayMode = 'BTC';
          
          // Convert current USDT input to BTC
          const btcAmount = currentInputValue / price;
          amountInput.value = btcAmount ? btcAmount.toFixed(6) : '';
          amountInput.placeholder = '0.25';
          
        } else {
          // Switch to USDT input mode
          amountDisplayMode = 'USDT';
          
          // Convert current BTC input to USDT
          const usdtAmount = currentInputValue * price;
          amountInput.value = usdtAmount ? usdtAmount.toFixed(0) : '';
          amountInput.placeholder = '1625';
        }
        
        updateAmountDisplay();
        updateSummary();
      };

      // Scale Amount toggle functionality
      let scaleAmountDisplayMode = 'USDT'; // Current input mode: 'USDT' or 'BTC'
      
      window.toggleScaleAmountDisplay = function() {
        const scaleAmountDisplayValue = document.getElementById('scaleAmountDisplayValue');
        const scaleAmountDisplayUnit = document.getElementById('scaleAmountDisplayUnit');
        const scaleAmountInput = document.getElementById('scaleAmountInput');
        
        const price = currentPrice() || 65000; // Get current price
        const currentInputValue = parseFloat(scaleAmountInput.value) || 0;
        
        if (scaleAmountDisplayMode === 'USDT') {
          // Switch to BTC input mode
          scaleAmountDisplayMode = 'BTC';
          
          // Convert current USDT input to BTC
          const btcAmount = currentInputValue / price;
          scaleAmountInput.value = btcAmount ? btcAmount.toFixed(6) : '';
          scaleAmountInput.placeholder = '0.25';
          
        } else {
          // Switch to USDT input mode
          scaleAmountDisplayMode = 'USDT';
          
          // Convert current BTC input to USDT
          const usdtAmount = currentInputValue * price;
          scaleAmountInput.value = usdtAmount ? usdtAmount.toFixed(0) : '';
          scaleAmountInput.placeholder = '1625';
        }
        
        updateScaleAmountDisplay();
        updateSummary();
      };

      // TWAP Size toggle functionality
      let twapSizeDisplayMode = 'USD'; // Current input mode: 'USD' or 'BTC'
      
      window.toggleTwapSizeDisplay = function() {
        const twapSizeDisplayValue = document.getElementById('twapSizeDisplayValue');
        const twapSizeDisplayUnit = document.getElementById('twapSizeDisplayUnit');
        const twapSizeInput = document.getElementById('twapSizeInput');
        
        const price = currentPrice() || 65000; // Get current price
        const currentInputValue = parseFloat(twapSizeInput.value) || 0;
        
        if (twapSizeDisplayMode === 'USD') {
          // Switch to BTC input mode
          twapSizeDisplayMode = 'BTC';
          
          // Convert current USD input to BTC
          const btcAmount = currentInputValue / price;
          twapSizeInput.value = btcAmount ? btcAmount.toFixed(6) : '';
          twapSizeInput.placeholder = '0.25';
          
        } else {
          // Switch to USD input mode
          twapSizeDisplayMode = 'USD';
          
          // Convert current BTC input to USD
          const usdAmount = currentInputValue * price;
          twapSizeInput.value = usdAmount ? usdAmount.toFixed(2) : '';
          twapSizeInput.placeholder = '4777.05';
        }
        
        updateTwapSizeDisplay();
        updateSummary();
      };
      
      function updateAmountDisplay() {
        const amountDisplayValue = document.getElementById('amountDisplayValue');
        const amountInput = document.getElementById('amountInput');
        const price = currentPrice() || 65000;
        const inputValue = parseFloat(amountInput.value) || 0;
        
        if (amountDisplayMode === 'USDT') {
          // Input is USDT, display shows BTC equivalent
          const btcAmount = inputValue / price;
          amountDisplayValue.textContent = btcAmount ? btcAmount.toFixed(4) : '0';
        } else {
          // Input is BTC, display shows USDT equivalent
          const usdtAmount = inputValue * price;
          amountDisplayValue.textContent = usdtAmount ? usdtAmount.toFixed(0) : '0';
        }
      }

      function updateScaleAmountDisplay() {
        const scaleAmountDisplayValue = document.getElementById('scaleAmountDisplayValue');
        const scaleAmountInput = document.getElementById('scaleAmountInput');
        const price = currentPrice() || 65000;
        const inputValue = parseFloat(scaleAmountInput.value) || 0;
        
        if (scaleAmountDisplayMode === 'USDT') {
          // Input is USDT, display shows BTC equivalent
          const btcAmount = inputValue / price;
          scaleAmountDisplayValue.textContent = btcAmount ? btcAmount.toFixed(4) : '0';
        } else {
          // Input is BTC, display shows USDT equivalent
          const usdtAmount = inputValue * price;
          scaleAmountDisplayValue.textContent = usdtAmount ? usdtAmount.toFixed(0) : '0';
        }
      }

      function updateTwapSizeDisplay() {
        const twapSizeDisplayValue = document.getElementById('twapSizeDisplayValue');
        const twapSizeInput = document.getElementById('twapSizeInput');
        const price = currentPrice() || 65000;
        const inputValue = parseFloat(twapSizeInput.value) || 0;
        
        if (twapSizeDisplayMode === 'USD') {
          // Input is USD, display shows BTC equivalent
          const btcAmount = inputValue / price;
          twapSizeDisplayValue.textContent = btcAmount ? btcAmount.toFixed(4) : '0';
        } else {
          // Input is BTC, display shows USD equivalent
          const usdAmount = inputValue * price;
          twapSizeDisplayValue.textContent = usdAmount ? usdAmount.toFixed(2) : '0';
        }
      }

      // Place order enable/summary
      function currentPrice() {
        if (appState.orderType === 'Market' || (appState.orderType === 'Pro' && appState.proType !== 'Stop Limit')) {
          return appState.prices[appState.asset] || 0;
        }
        const p = Number(priceInput.value);
        return p > 0 ? p : 0;
      }

      function updateSummary() {
        // Calculate BTC quantity based on current input mode
        const amountInputValue = Number(amountInput.value) || 0;
        let qty = 0;
        
        if (amountDisplayMode === 'USDT') {
          // Input is USDT, convert to BTC
          const px = currentPrice();
          qty = px > 0 ? amountInputValue / px : 0;
        } else {
          // Input is already BTC
          qty = amountInputValue;
        }
        const px = currentPrice();
        const canUsePrice = px > 0;
        const needsPrice = !(appState.orderType === 'Market' || (appState.orderType === 'Pro' && appState.proType !== 'Stop Limit'));
        const canPlace = qty > 0 && (!needsPrice || canUsePrice);
        
        placeOrder.disabled = !canPlace;
        placeOrder.classList.toggle('opacity-60', !canPlace);
        placeOrder.classList.toggle('cursor-not-allowed', !canPlace);

        if (!canUsePrice || qty <= 0) {
          $('#orderValue').textContent = 'N/A';
          $('#marginRequired').textContent = 'N/A';
          $('#liqPrice').textContent = 'N/A';
          $('#feesValue').textContent = '—';
          updateNavbarTradingData();
          return;
        }
        
        const val = qty * px;
        const lev = appState.leverage;
        const margin = val / lev;
        const feeRate = appState.orderType === 'Market' ? 0.0005 : 0.0003; // 5/3 bps
        const fees = val * feeRate;

        $('#orderValue').textContent = '$' + fmt(val);
        $('#marginRequired').textContent = '$' + fmt(margin);
        $('#feesValue').textContent = '$' + fmt(fees);

        const liq = (appState.side === 'long')
          ? px * (1 - (1 / lev)) * 0.99
          : px * (1 + (1 / lev)) * 1.01;
        $('#liqPrice').textContent = '$' + fmt(liqueSafe(liq));
        
        // Update navbar with new data
        updateNavbarTradingData();
      }
      
      // Function to update navbar trading data
      function updateNavbarTradingData() {
        if (window.nimbusNavbar) {
          // Update dropdown values
          updateNavbarDropdownValues();
          // Sync current display values
          window.nimbusNavbar.syncFromSidebar();
        }
      }
      
      // Update all dropdown values in navbar
      function updateNavbarDropdownValues() {
        const updates = [
          { selector: '[data-metric="order-value"] .mono', source: '#orderValue' },
          { selector: '[data-metric="margin-required"] .mono', source: '#marginRequired' },
          { selector: '[data-metric="liq-price"] .mono', source: '#liqPrice' },
          { selector: '[data-metric="fees"] .mono', source: '#feesValue' },
          { selector: '[data-metric="total-equity"] .mono', source: '#perpsBalance' },
          { selector: '[data-metric="perps-equity"] .mono', source: '#perpsBalance' },
          { selector: '[data-metric="available-balance"] .mono', source: '#perpsBalance2' },
          { selector: '[data-metric="cross-margin-ratio"] .mono', source: '#crossMarginRatio' },
          { selector: '[data-metric="cross-leverage"] .mono', source: '#crossLev' },
          { selector: '[data-metric="maintenance-margin"] .mono', source: '#maintMargin' }
        ];
        
        updates.forEach(({ selector, source }) => {
          const targetEl = document.querySelector(selector);
          const sourceEl = document.querySelector(source);
          if (targetEl && sourceEl) {
            targetEl.textContent = sourceEl.textContent;
          }
        });
      }
      
      function liqueSafe(n){ 
        return isFinite(n) ? n : 0; 
      }

      // Leverage Modal functionality
      const levModal = $('#levModal');
      const levSliderProgress = $('#levSliderProgress');
      const levSliderHandle = $('#levSliderHandle');
      let levTarget = 'trade'; // 'trade' | 'grid'
      let currentMarginMode = 'Isolated'; // 'Cross' | 'Isolated'
      
      $('#leverageOpen').addEventListener('click', () => openLev('trade', appState.leverage));
      
      function openLev(target, value) {
        levTarget = target;
        $('#levContext').textContent = 'Control the leverage and margin for ' + (target === 'trade' ? 'BTC positions.' : 'Grid Bot.');
        $('#levRange').value = value;
        $('#levValueLabel').textContent = value;
        updateLevSliderVisuals(value);
        levModal.classList.remove('hidden');
        levModal.classList.add('flex');
      }
      
      function updateLevSliderVisuals(val) {
        const percentage = ((val - 1) / 39) * 100; // Scale 1-40 to 0-100%
        levSliderProgress.style.width = percentage + '%';
        levSliderHandle.style.left = `calc(${percentage}% - 10px)`;
      }
      
      function closeLev() {
        levModal.classList.add('hidden');
        levModal.classList.remove('flex');
      }
      
      $$('[data-close="lev"]').forEach(b => b.addEventListener('click', closeLev));
      
      $('#levRange').addEventListener('input', (e) => {
        const v = e.target.value;
        $('#levValueLabel').textContent = v;
        updateLevSliderVisuals(v);
        updateLeverageFakeData(v);
      });
      
      // Plus/Minus Controls
      $('#levDecrease').addEventListener('click', () => {
        const current = parseInt($('#levRange').value);
        const newVal = Math.max(1, current - 1);
        $('#levRange').value = newVal;
        $('#levValueLabel').textContent = newVal;
        updateLevSliderVisuals(newVal);
        updateLeverageFakeData(newVal);
      });
      
      $('#levIncrease').addEventListener('click', () => {
        const current = parseInt($('#levRange').value);
        const newVal = Math.min(40, current + 1);
        $('#levRange').value = newVal;
        $('#levValueLabel').textContent = newVal;
        updateLevSliderVisuals(newVal);
        updateLeverageFakeData(newVal);
      });
      
      // Margin Mode Toggle
      $('#crossMarginBtn').addEventListener('click', () => {
        $('#crossMarginBtn').classList.add('ring-emerald-400/30', 'bg-emerald-400/10', 'text-emerald-300');
        $('#crossMarginBtn').classList.remove('text-neutral-300');
        $('#crossMarginBtn').innerHTML = '✓ Cross';
        
        $('#isolatedMarginBtn').classList.remove('ring-emerald-400/30', 'bg-emerald-400/10', 'text-emerald-300');
        $('#isolatedMarginBtn').classList.add('text-neutral-300');
        $('#isolatedMarginBtn').innerHTML = 'Isolated';
        
        // Update leverage button
        currentMarginMode = 'Cross';
        $('#marginModeLabel').textContent = 'Cross';
      });
      
      $('#isolatedMarginBtn').addEventListener('click', () => {
        $('#isolatedMarginBtn').classList.add('ring-emerald-400/30', 'bg-emerald-400/10', 'text-emerald-300');
        $('#isolatedMarginBtn').classList.remove('text-neutral-300');
        $('#isolatedMarginBtn').innerHTML = '✓ Isolated';
        
        $('#crossMarginBtn').classList.remove('ring-emerald-400/30', 'bg-emerald-400/10', 'text-emerald-300');
        $('#crossMarginBtn').classList.add('text-neutral-300');
        $('#crossMarginBtn').innerHTML = 'Cross';
        
        // Update leverage button
        currentMarginMode = 'Isolated';
        $('#marginModeLabel').textContent = 'Isolated';
      });
      
      // Quick select buttons
      document.querySelectorAll('.lev-quick-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const lev = parseInt(btn.dataset.lev);
          $('#levRange').value = lev;
          $('#levValueLabel').textContent = lev;
          updateLevSliderVisuals(lev);
          updateLeverageFakeData(lev);
          
          // Update button states
          document.querySelectorAll('.lev-quick-btn').forEach(b => {
            b.classList.remove('text-emerald-300');
            b.classList.add('text-neutral-400');
          });
          btn.classList.remove('text-neutral-400');
          btn.classList.add('text-emerald-300');
        });
      });
      
      // Update fake data based on leverage
      function updateLeverageFakeData(leverage) {
        const basePrice = 65000;
        const maintMargin = (leverage * 23.75).toFixed(2);
        const liqPrice = (basePrice * (1 - (0.8 / leverage))).toFixed(0);
        const maxPos = (2829 * leverage * 0.8).toFixed(0);
        
        $('#maintMarginValue').textContent = `$${maintMargin}`;
        $('#liqPriceValue').textContent = `$${liqPrice}`;
        $('#maxPosValue').textContent = `$${maxPos}`;
      }
      
      $$('.levQuick').forEach(b => b.addEventListener('click', () => {
        const v = Number(b.dataset.lev);
        $('#levRange').value = v; 
        $('#levInput').value = v; 
        $('#levValueLabel').textContent = v + 'x';
      }));
      
      $('#levApply').addEventListener('click', () => {
        const v = Number($('#levInput').value) || 1;
        if (levTarget === 'trade') {
          appState.leverage = v;
          $('#leverageLabel').textContent = v + 'x';
        } else {
          appState.grid.lev = v;
          if ($('#gridLevLabel')) $('#gridLevLabel').textContent = v + 'x';
          if ($('#gridLevVal')) $('#gridLevVal').textContent = v + 'x';
        }
        closeLev();
        showToast('Leverage set to ' + v + 'x');
        updateSummary();
      });

      // Strategies: open Grid setup
      $$('.botBtn').forEach(b => {
        b.addEventListener('click', () => {
          const name = b.dataset.bot;
          if (!name) return;
          appState.grid.context = name;
          if ($('#gridTitle')) $('#gridTitle').textContent = name;
          // If Spot strategy, we can reflect title only; keep UI same
          strategiesMode.classList.add('hidden');
          tradeMode.classList.add('hidden');
          gridSetup.classList.remove('hidden');
          appState.grid.active = true;
        });
      });
      
      // Back from grid
      if ($('#gridBack')) {
        $('#gridBack').addEventListener('click', () => {
          gridSetup.classList.add('hidden');
          strategiesMode.classList.remove('hidden');
          appState.grid.active = false;
        });
      }

      // Grid leverage button
      if ($('#gridLevOpen')) {
        $('#gridLevOpen').addEventListener('click', () => openLev('grid', appState.grid.lev));
      }

      // Grid UI functionality
      const gridQtySlider = $('#gridQty');
      const gridQtyInput = $('#gridQtyInput');
      const gridQtyDisplay = $('#gridQtyDisplay');
      const gridQtyProgress = $('#gridQtyProgress');
      const gridQtyHandle = $('#gridQtyHandle');

      // Grid amount controls (copied from limit UI)
      const gridSizeSlider = $('#gridSizeSlider');
      const gridSizeInput = $('#gridSizeInput');
      const gridSliderProgress = $('#gridSliderProgress');
      const gridSliderHandle = $('#gridSliderHandle');
      const gridAmountInput = $('#gridAmountInput');
      let gridAmountDisplayMode = 'BTC'; // Default to BTC

      // Update grid quantity slider visuals
      function updateGridQtyVisuals(value) {
        const percentage = ((value - 2) / (500 - 2)) * 100; // 2-500 range
        if (gridQtyProgress && gridQtyHandle) {
          gridQtyProgress.style.width = percentage + '%';
          gridQtyHandle.style.left = `calc(${percentage}% - 10px)`;
        }
      }

      // Grid size controls (% of balance) - copied from limit UI
      function syncGridPercent(val) {
        val = Math.max(0, Math.min(100, Number(val) || 0));
        if (gridSizeSlider) gridSizeSlider.value = val; 
        if (gridSizeInput) gridSizeInput.value = val;
        
        // Update custom slider visuals
        updateGridSliderVisuals(val);
        
        // Update percentage button states
        updateGridPercentageButtons(val);
        
        // Map % of availBalance to amount assuming current input mode
        const avail = parseFloat($('#gridAvailBalance').textContent) || 0;
        const px = currentPrice();
        const usd = avail * val / 100;
        
        // Update amount input based on current display mode
        if (gridAmountInput) {
          if (gridAmountDisplayMode === 'USDT') {
            gridAmountInput.value = usd ? usd.toFixed(2) : '';
          } else {
            const qty = px > 0 ? usd / px : 0;
            gridAmountInput.value = qty ? qty.toFixed(4) : '';
          }
        }
        updateGridAmountDisplay();
      }
      
      function updateGridSliderVisuals(val) {
        const percentage = val + '%';
        if (gridSliderProgress) gridSliderProgress.style.width = percentage;
        if (gridSliderHandle) gridSliderHandle.style.left = `calc(${percentage} - 10px)`; // Offset for handle center
      }
      
      function updateGridPercentageButtons(val) {
        // Remove active state from all buttons
        document.querySelectorAll('.grid-percentage-btn').forEach(btn => {
          btn.classList.remove('text-emerald-400', 'font-semibold');
          btn.classList.add('text-neutral-400');
        });
        
        // Add active state to current percentage button (if exact match)
        const activeBtn = document.querySelector(`.grid-percentage-btn[data-percent="${val}"]`);
        if (activeBtn) {
          activeBtn.classList.remove('text-neutral-400');
          activeBtn.classList.add('text-emerald-400', 'font-semibold');
        }
      }

      function updateGridAmountDisplay() {
        const displayValue = $('#gridAmountDisplayValue');
        const displayUnit = $('#gridAmountDisplayUnit');
        if (displayValue && displayUnit && gridAmountInput) {
          const val = parseFloat(gridAmountInput.value) || 0;
          if (gridAmountDisplayMode === 'BTC') {
            displayValue.textContent = val.toFixed(4);
            displayUnit.textContent = 'BTC';
          } else {
            displayValue.textContent = val.toFixed(2);
            displayUnit.textContent = 'USDT';
          }
        }
      }

      // Sync grid quantity slider and input
      if (gridQtySlider && gridQtyInput && gridQtyDisplay) {
        gridQtySlider.addEventListener('input', (e) => {
          const value = e.target.value;
          gridQtyInput.value = value;
          gridQtyDisplay.textContent = value;
          updateGridQtyVisuals(value);
        });

        gridQtyInput.addEventListener('input', (e) => {
          const value = Math.max(2, Math.min(500, parseInt(e.target.value) || 2));
          e.target.value = value;
          gridQtySlider.value = value;
          gridQtyDisplay.textContent = value;
          updateGridQtyVisuals(value);
        });
        
        // Initialize visuals
        updateGridQtyVisuals(gridQtySlider.value);
      }

      // Grid size slider and input events
      if (gridSizeSlider) gridSizeSlider.addEventListener('input', e => syncGridPercent(e.target.value));
      if (gridSizeInput) gridSizeInput.addEventListener('input', e => syncGridPercent(e.target.value));

      // Grid percentage button clicks
      document.querySelectorAll('.grid-percentage-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const percent = btn.dataset.percent;
          syncGridPercent(percent);
        });
      });

      // Grid amount toggle functionality
      const gridAmountToggleBtn = $('#gridAmountToggleBtn');
      if (gridAmountToggleBtn) {
        gridAmountToggleBtn.addEventListener('click', () => {
          if (gridAmountDisplayMode === 'BTC') {
            gridAmountDisplayMode = 'USDT';
          } else {
            gridAmountDisplayMode = 'BTC';
          }
          updateGridAmountDisplay();
        });
      }

      // Portfolio Tabs (New System)
      function initPortfolioTabs() {
        const tabButtons = $$('button[data-tab]');
        const panels = $$('[id^="panel-"]');

        function activateTab(key) {
          tabButtons.forEach(b => b.classList.remove('tab-active','tab-underline','text-neutral-200'));
          panels.forEach(p => p.classList.add('hidden'));
          const btn = tabButtons.find(b => b.dataset.tab === key);
          if (btn) btn.classList.add('tab-active','tab-underline','text-neutral-200');
          const panel = $(`#panel-${key}`);
          if (panel) panel.classList.remove('hidden');
        }

        tabButtons.forEach(btn => {
          btn.addEventListener('click', () => activateTab(btn.dataset.tab));
        });

        // Default
        activateTab('balances');
      }
      
      // Portfolio Filter functionality
      function initPortfolioFilters() {
        const menuBtn = $('#filterBtn');
        const menu = $('#filterMenu');
        const rows = Array.from($$('#balancesBody tr'));

        function applyFilters() {
          const activeType = menu.dataset.activeFilter || 'all';
          const hideSmall = $('#hideSmallToggle').classList.contains('toggle-on');
      rows.forEach(r => {
            const typeOk = activeType === 'all' || r.dataset.type === activeType;
            const smallOk = !hideSmall || (parseFloat(r.dataset.usdc || '0') >= 100);
            r.classList.toggle('hidden', !(typeOk && smallOk));
          });
        }

        if (menuBtn && menu) {
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('hidden');
          });
          
          document.addEventListener('click', () => menu.classList.add('hidden'));
          
          menu.querySelectorAll('button[data-filter]').forEach(b => {
            b.addEventListener('click', () => {
              menu.dataset.activeFilter = b.dataset.filter;
              menu.classList.add('hidden');
              applyFilters();
            });
          });
        }

        // Hide small toggle
        const toggle = $('#hideSmallToggle');
        if (toggle) {
          toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggle.classList.toggle('toggle-on');
            toggle.classList.toggle('toggle-off');
            applyFilters();
          });

          // Initial state
          toggle.classList.add('toggle-off');
          applyFilters();
        }
      }



      // Auxiliary Panels
      window.toggleAux = function(type) {
        const auxColumn = $('#auxColumn');
        const existingPanel = $(`#aux-${type}`);
        
        if (existingPanel) {
          // Clean up panel-specific functionality
          if (type === 'book' && orderBookUpdateInterval) {
            clearInterval(orderBookUpdateInterval);
            orderBookUpdateInterval = null;
            console.log('Order book updates stopped');
          } else if (type === 'news' && newsUpdateInterval) {
            clearInterval(newsUpdateInterval);
            newsUpdateInterval = null;
            // Save filter state
            localStorage.setItem('newsSearchTags', JSON.stringify(newsSearchTags));
            localStorage.setItem('newsTimeFilter', newsTimeFilter);
            console.log('News updates stopped');
          }
          existingPanel.remove();
          // Update button to inactive state
          updateAuxButtonState(type, false);
          return;
        }

        const panel = createAuxPanel(type);
        auxColumn.appendChild(panel);
        
        // Update button to active state
        updateAuxButtonState(type, true);
        
        // Initialize specific panel functionality
        if (type === 'book') {
          setTimeout(() => initializeOrderBook(), 100);
        } else if (type === 'analytics') {
          setTimeout(() => initAnalyticsTabs(), 100);
        } else if (type === 'news') {
          setTimeout(() => startNewsUpdates(), 100);
        } else if (type === 'signals') {
          setTimeout(() => initSignalsPanel(), 100);
        }
      };

      // Update auxiliary button visual states
      function updateAuxButtonState(type, isActive) {
        const toggleBtn = document.getElementById(`${type}Toggle`);
        if (!toggleBtn) return;
        
        const svg = toggleBtn.querySelector('svg');
        
        if (isActive) {
          // Active state - highlighted
          toggleBtn.className = "h-10 w-full flex items-center justify-center border-b border-emerald-600/30 hover:bg-emerald-600/30 hover:border-emerald-600/40 transition-all group bg-emerald-600/20";
          svg.className = "w-5 h-5 text-emerald-300 group-hover:text-emerald-100 transition-all drop-shadow-sm";
        } else {
          // Inactive state - neutral
          const baseClass = type === 'analytics' ? 
            "h-10 w-full flex items-center justify-center hover:bg-white/5 transition-all group" :
            "h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group";
          toggleBtn.className = baseClass;
          svg.className = "w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm";
        }
      }

      window.closeAuxPanel = function(button) {
        const panel = button.closest('[id^=aux-]');
        const panelId = panel.id;
        const type = panelId.replace('aux-', '');
        
        // Clean up panel-specific functionality
        if (type === 'book' && orderBookUpdateInterval) {
          clearInterval(orderBookUpdateInterval);
          orderBookUpdateInterval = null;
          console.log('Order book updates stopped');
        } else if (type === 'news' && newsUpdateInterval) {
          clearInterval(newsUpdateInterval);
          newsUpdateInterval = null;
          // Save filter state
          localStorage.setItem('newsSearchTags', JSON.stringify(newsSearchTags));
          localStorage.setItem('newsTimeFilter', newsTimeFilter);
          console.log('News updates stopped');
        }
        
        // Update button to inactive state
        updateAuxButtonState(type, false);
        
        panel.remove();
      };

      // Initialize trading panel button state on page load
      document.addEventListener('DOMContentLoaded', function() {
        const rightColumn = document.querySelector('.right-column');
        const toggleBtn = document.getElementById('tradingPanelToggle');
        
        // Since panel is visible by default, set button to active state
        if (rightColumn && toggleBtn) {
          const svg = toggleBtn.querySelector('svg');
          toggleBtn.className = "h-10 w-full flex items-center justify-center border-b border-emerald-600/30 hover:bg-emerald-600/30 hover:border-emerald-600/40 transition-all group bg-emerald-600/20";
          svg.className = "w-5 h-5 text-emerald-300 group-hover:text-emerald-100 transition-all drop-shadow-sm";
          toggleBtn.title = "Hide Trading Panel";
        }
      });

      // Toggle Portfolio Section
      window.togglePortfolioSection = function() {
        const portfolioContent = document.getElementById('portfolioContent');
        const portfolioToggle = document.getElementById('portfolioToggle');
        const portfolioSection = document.querySelector('.portfolio-section');
        
        if (portfolioContent && portfolioToggle) {
          const isCollapsed = portfolioContent.style.display === 'none';
          const isFullscreen = portfolioSection && portfolioSection.classList.contains('fullscreen');
          
          if (isCollapsed) {
            // Expand portfolio section
            portfolioContent.style.display = 'block';
            if (portfolioSection) {
              // Don't override height if in fullscreen mode
              if (!isFullscreen) {
                portfolioSection.style.height = '';  // Remove inline style to let CSS take over
              }
            }
            portfolioToggle.title = 'Collapse Portfolio';
            portfolioToggle.querySelector('svg').innerHTML = `
              <path d="M18 6L6 18"/>
              <path d="M6 6l12 12"/>
            `;
          } else {
            // Collapse portfolio section  
            portfolioContent.style.display = 'none';
            if (portfolioSection) {
              // Exit fullscreen mode first if active
              if (isFullscreen) {
                portfolioSection.classList.remove('fullscreen');
                const chartSection = document.querySelector('.chart-section');
                if (chartSection) {
                  chartSection.classList.remove('hidden-by-portfolio');
                }
                // Update fullscreen button
                const portfolioFullscreen = document.getElementById('portfolioFullscreen');
                if (portfolioFullscreen) {
                  portfolioFullscreen.title = 'Fullscreen Portfolio';
                  portfolioFullscreen.querySelector('svg').innerHTML = `
                    <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
                    <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
                    <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
                    <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
                  `;
                }
              }
              portfolioSection.style.height = '36px'; // Only show tabs height
            }
            portfolioToggle.title = 'Expand Portfolio';
            portfolioToggle.querySelector('svg').innerHTML = `
              <path d="M6 9l6 6 6-6"/>
            `;
          }
        }
      };

      // Toggle Portfolio Fullscreen
      window.togglePortfolioFullscreen = function() {
        const portfolioSection = document.querySelector('.portfolio-section');
        const chartSection = document.querySelector('.chart-section');
        const portfolioFullscreen = document.getElementById('portfolioFullscreen');
        const portfolioContent = document.getElementById('portfolioContent');
        const portfolioToggle = document.getElementById('portfolioToggle');
        
        if (portfolioSection && chartSection && portfolioFullscreen) {
          const isFullscreen = portfolioSection.classList.contains('fullscreen');
          const isCollapsed = portfolioContent && portfolioContent.style.display === 'none';
          
          if (isFullscreen) {
            // Exit fullscreen mode
            portfolioSection.classList.remove('fullscreen');
            chartSection.classList.remove('hidden-by-portfolio');
            // Remove inline height to let CSS take over
            portfolioSection.style.height = '';
            portfolioFullscreen.title = 'Fullscreen Portfolio';
            portfolioFullscreen.querySelector('svg').innerHTML = `
              <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
              <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
              <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
              <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
            `;
          } else {
            // Enter fullscreen mode
            // First, ensure portfolio is expanded if it's collapsed
            if (isCollapsed && portfolioContent && portfolioToggle) {
              portfolioContent.style.display = 'block';
              portfolioToggle.title = 'Collapse Portfolio';
              portfolioToggle.querySelector('svg').innerHTML = `
                <path d="M18 6L6 18"/>
                <path d="M6 6l12 12"/>
              `;
            }
            
            portfolioSection.classList.add('fullscreen');
            chartSection.classList.add('hidden-by-portfolio');
            portfolioFullscreen.title = 'Exit Fullscreen';
            portfolioFullscreen.querySelector('svg').innerHTML = `
              <path d="M8 3v3a2 2 0 0 1-2 2H3"/>
              <path d="M21 8h-3a2 2 0 0 1-2-2V3"/>
              <path d="M3 16h3a2 2 0 0 1 2 2v3"/>
              <path d="M16 21v-3a2 2 0 0 1 2-2h3"/>
            `;
          }
        }
      };

      // Toggle Trading Panel (Trade + Token List)
      window.toggleTradingPanel = function() {
        const rightColumn = document.querySelector('.right-column');
        const toggleBtn = document.getElementById('tradingPanelToggle');
        
        if (rightColumn && toggleBtn) {
          // Check if panel is currently visible (either no inline style or display is not 'none')
          const isCurrentlyVisible = rightColumn.style.display !== 'none';
          
          // Toggle the display
          rightColumn.style.display = isCurrentlyVisible ? 'none' : 'flex';
          
          const svg = toggleBtn.querySelector('svg');
          
          if (!isCurrentlyVisible) {
            // Show panel - highlight button (keep same icon)
            toggleBtn.className = "h-10 w-full flex items-center justify-center border-b border-emerald-600/30 hover:bg-emerald-600/30 hover:border-emerald-600/40 transition-all group bg-emerald-600/20";
            svg.className = "w-5 h-5 text-emerald-300 group-hover:text-emerald-100 transition-all drop-shadow-sm";
            toggleBtn.title = "Hide Trading Panel";
          } else {
            // Hide panel - remove highlight (keep same icon)
            toggleBtn.className = "h-10 w-full flex items-center justify-center border-b border-white/5 hover:bg-white/5 hover:border-white/10 transition-all group";
            svg.className = "w-5 h-5 text-neutral-400/70 group-hover:text-neutral-200 transition-all drop-shadow-sm";
            toggleBtn.title = "Show Trading Panel";
          }
        }
      };

      function createAuxPanel(type) {
        const panel = document.createElement('div');
        panel.id = `aux-${type}`;
        panel.className = 'slide-in shrink-0 w-[320px] min-w-[280px] max-w-[360px] glass-strong flex flex-col border-l';
        panel.style.borderColor = 'var(--color-border-subtle)';

        const titles = {
          book: 'Order Book', 
          news: 'Market News',
          analytics: 'Analytics',
          signals: 'Community Signals'
        };

        panel.innerHTML = `
          <div class="shrink-0 px-3 py-3 border-b border-subtle">
      <div class="flex items-center justify-between">
              <div class="text-[13px] font-semibold">${titles[type] || type}</div>
              <button class="h-7 w-7 rounded-md btn-secondary flex items-center justify-center" onclick="closeAuxPanel(this)">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18"/>
                  <path d="M6 6l12 12"/>
                </svg>
              </button>
          </div>
        </div>
          <div class="flex-1 overflow-auto px-3 pb-3">
            ${getAuxPanelContent(type)}
          </div>
        `;

        return panel;
      }

            function getAuxPanelContent(type) {
        switch (type) {
          case 'book':
            return `
              <div id="orderBookContainer" class="h-full flex flex-col">
                <!-- Enhanced Header -->
                <div class="flex items-center justify-between pb-2 border-b border-gray-700/30 mb-2">
                  <!-- Tabs -->
                  <div class="flex items-center gap-1 bg-gray-800/50 rounded-md p-0.5">
                    <button id="obTab" class="px-2 py-1 text-[10px] font-medium rounded-sm bg-gray-700 text-gray-200">Order Book</button>
                    <button id="rtTab" class="px-2 py-1 text-[10px] font-medium rounded-sm text-gray-400 hover:text-gray-200">Recent Trades</button>
                  </div>
                  
                  <!-- Controls -->
        <div class="flex items-center gap-2">
                    <!-- Precision Dropdown -->
                    <select class="bg-gray-800 border border-gray-700 rounded text-[10px] px-1 py-0.5 text-gray-300">
                      <option value="0.01">0.01</option>
                      <option value="0.1">0.1</option>
                      <option value="1">1</option>
                    </select>
                    
                    <!-- View Toggle Icons -->
          <div class="flex items-center gap-1">
                      <button class="p-1 rounded hover:bg-gray-700/50 text-gray-400 hover:text-gray-200" title="Full View">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="3" width="7" height="7"/>
                          <rect x="14" y="3" width="7" height="7"/>
                          <rect x="3" y="14" width="7" height="7"/>
                          <rect x="14" y="14" width="7" height="7"/>
                        </svg>
                      </button>
                      <button class="p-1 rounded hover:bg-gray-700/50 text-gray-400 hover:text-gray-200" title="Compact View">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 6h18"/>
                          <path d="M3 12h18"/>
                          <path d="M3 18h18"/>
                        </svg>
                      </button>
        </div>
      </div>
            </div>
                
                <!-- Column Headers -->
                <div class="grid grid-cols-3 gap-1 px-1 pb-1 text-[10px] text-gray-500 font-medium">
                  <div class="text-right">Price (USDT)</div>
                  <div class="text-right">Amount (ETH)</div>
                  <div class="text-right">Total (ETH)</div>
          </div>
                
                <!-- Order Book Content -->
                <div class="flex-1 flex flex-col min-h-0">
                  <!-- Sell Orders (Asks) -->
                  <div id="sellOrders" class="flex-1 flex flex-col-reverse overflow-hidden">
                    <!-- Sell orders will be populated here -->
              </div>
                  
                  <!-- Mid Price Section -->
                  <div id="midPrice" class="py-2 px-1 border-y border-gray-700/50 bg-gray-800/30">
                    <div class="text-center">
                      <div class="flex items-center justify-center gap-1">
                        <span id="lastPrice" class="text-[13px] font-bold text-gray-200">65,432.50</span>
                        <svg id="priceArrow" class="w-3 h-3 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 14l5-5 5 5"/>
                        </svg>
            </div>
                      <div id="fiatPrice" class="text-[10px] text-gray-400">$65,432.50</div>
              </div>
            </div>
                  
                  <!-- Buy Orders (Bids) -->
                  <div id="buyOrders" class="flex-1 overflow-hidden">
                    <!-- Buy orders will be populated here -->
          </div>
            </div>
                
                <!-- Buy/Sell Ratio Footer -->
                <div class="mt-2 pt-2 border-t border-gray-700/30">
                  <div class="flex items-center justify-between text-[10px] text-gray-400 mb-1">
                    <span>Buy Orders</span>
                    <span>Sell Orders</span>
          </div>
                  <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                    <div id="buyRatio" class="h-full bg-green-500 transition-all duration-300 ease-in-out w-[62%]"></div>
            </div>
                  <div class="flex items-center justify-between text-[10px] text-gray-500 mt-1">
                    <span id="buyPercent">62%</span>
                    <span id="sellPercent">38%</span>
          </div>
          </div>
          </div>
            `;
                    case 'news':
            return `
              <div class="pt-2">
                <!-- News Header -->
                <div class="flex items-center justify-between mb-2">
                  <div class="text-[11px] font-semibold text-gray-400 uppercase tracking-wide">Latest Updates</div>
                  <button id="refreshNewsBtn" class="text-[11px] text-gray-400 hover:text-gray-300 flex items-center gap-1" onclick="refreshNews()">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                      <path d="M21 3v5h-5"/>
                      <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                      <path d="M8 16H3v5"/>
                    </svg>
                    <span>Refresh</span>
                  </button>
        </div>

                <!-- Search and Filters -->
                <div class="mb-2">
                  <!-- Search Input -->
                  <div class="flex items-center gap-2 mb-2">
                    <div class="flex-1 relative">
                      <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="11" cy="11" r="8"/>
                          <path d="m21 21-4.35-4.35"/>
                        </svg>
                      </span>
                      <input id="newsSearchInput" type="text" placeholder="Search news..." class="w-full pl-7 pr-3 py-1.5 text-[10px] bg-gray-800 border border-gray-700 rounded text-gray-300 focus:border-gray-600 placeholder-gray-500" onkeypress="handleNewsSearch(event)" />
                    </div>
                    <!-- Time Filter -->
                    <select id="newsTimeFilter" class="bg-gray-800 border border-gray-700 rounded text-[10px] px-2 py-1.5 text-gray-300" onchange="applyNewsFilters()">
                      <option value="all">All Time</option>
                      <option value="today">Today</option>
                      <option value="week">Last Week</option>
                      <option value="month">Last Month</option>
                    </select>
                  </div>

                  <!-- Search Tags -->
                  <div id="newsSearchTags" class="flex flex-wrap gap-1 mb-2 min-h-[16px]"></div>
                </div>
                
                <!-- News Items -->
                <div id="newsContainer" class="space-y-2">
                  <div class="text-center text-gray-400 py-4 text-[10px]">
                    Loading news...
                  </div>
                </div>
              </div>
            `;
          case 'analytics':
            return `
              <div class="flex flex-col h-full">
                <!-- Controls Header -->
                <div class="shrink-0 p-3 border-b border-gray-700/30">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="text-[11px] font-semibold text-gray-300 uppercase tracking-wide">Portfolio Analytics</div>
                    <div class="flex-1"></div>
                    <button class="px-2 py-1 text-[11px] bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition-colors">24H</button>
                </div>
                
                  <!-- Compact Controls -->
                  <div class="space-y-2">
                    <!-- Metric/Market Row -->
                    <div class="flex gap-1">
                      <button class="flex-1 px-2 py-1 text-[11px] bg-emerald-600/20 text-emerald-300 rounded border border-emerald-600/30">P&L</button>
                      <button class="flex-1 px-2 py-1 text-[11px] text-gray-400 hover:text-gray-300 rounded border border-gray-600/30">ROI</button>
                    </div>
                    <!-- Market Type Row -->
                    <div class="flex gap-1">
                      <button class="flex-1 px-2 py-1 text-[11px] bg-blue-600/20 text-blue-300 rounded border border-blue-600/30">All</button>
                      <button class="flex-1 px-2 py-1 text-[11px] text-gray-400 hover:text-gray-300 rounded border border-gray-600/30">Perp</button>
                      <button class="flex-1 px-2 py-1 text-[11px] text-gray-400 hover:text-gray-300 rounded border border-gray-600/30">Spot</button>
                    </div>
          </div>
            </div>
                  
                <!-- Account Value -->
                <div class="shrink-0 p-3 border-b border-gray-700/30">
                  <div class="text-[11px] text-gray-400 mb-1">Account Value</div>
                  <div class="text-lg font-semibold tracking-tight text-white">$87,607.37</div>
                  <div class="text-[11px] text-emerald-400">+$3,147.29 (+3.59%)</div>
                </div>

                <!-- Key Metrics Grid -->
                <div class="shrink-0 p-3 border-b border-gray-700/30">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                      <div class="text-[11px] text-gray-400">Total P&L</div>
                      <div class="text-[11px] font-semibold text-red-400 mono">-$304.88</div>
                    </div>
                    <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                      <div class="text-[11px] text-gray-400">Win Rate</div>
                      <div class="text-[11px] font-semibold text-white mono">54.0%</div>
                    </div>
                    <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                      <div class="text-[11px] text-gray-400">Sharpe (30D)</div>
                      <div class="text-[11px] font-semibold text-white mono">1.12</div>
                    </div>
                    <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                      <div class="text-[11px] text-gray-400">Avg Duration</div>
                      <div class="text-[11px] font-semibold text-white mono">6h 12m</div>
                    </div>
          </div>
          </div>
                  
                <!-- Asset Allocation -->
                <div class="shrink-0 p-3 border-b border-gray-700/30">
                  <div class="text-[11px] text-gray-400 mb-2">Asset Allocation</div>
                  <div class="grid grid-cols-2 gap-1">
                    <div class="flex items-center justify-between py-1">
                      <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                        <span class="text-[11px] text-gray-300">BTC</span>
                      </div>
                      <span class="text-[11px] text-emerald-400 mono">+4.2%</span>
                    </div>
                    <div class="flex items-center justify-between py-1">
                      <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <span class="text-[11px] text-gray-300">ETH</span>
                      </div>
                      <span class="text-[11px] text-emerald-400 mono">+6.8%</span>
                    </div>
                    <div class="flex items-center justify-between py-1">
                      <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                        <span class="text-[11px] text-gray-300">SOL</span>
                      </div>
                      <span class="text-[11px] text-red-400 mono">-1.3%</span>
                    </div>
                    <div class="flex items-center justify-between py-1">
                      <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                        <span class="text-[11px] text-gray-300">USDT</span>
                      </div>
                      <span class="text-[11px] text-gray-400 mono">—</span>
                    </div>
                  </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="shrink-0 border-b border-gray-700/30">
                  <div class="flex text-[11px]">
                    <button class="flex-1 px-1 py-2 text-emerald-400 border-b border-emerald-400" data-tab="trades">Trades</button>
                    <button class="flex-1 px-1 py-2 text-gray-400 hover:text-gray-300" data-tab="charts">Charts</button>
                    <button class="flex-1 px-1 py-2 text-gray-400 hover:text-gray-300" data-tab="fills">Fills</button>
                    <button class="flex-1 px-1 py-2 text-gray-400 hover:text-gray-300" data-tab="funding">Funding</button>
                    <button class="flex-1 px-1 py-2 text-gray-400 hover:text-gray-300" data-tab="calendar">Calendar</button>
                  </div>
                </div>

                <!-- Scrollable Content Area -->
                <div class="flex-1 overflow-y-auto">
                  <!-- Trades Tab -->
                  <div id="tab-trades-content" class="p-3">
                    <div class="text-[11px] text-gray-400 mb-2">Recent Completed Trades</div>
                    <div class="space-y-2">
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">ETH/USDT Long</div>
                          <div class="text-[8px] text-gray-500">Aug 14, 10:22</div>
                        </div>
                    <div class="text-right">
                          <div class="text-[11px] text-emerald-400 font-medium">+$422.42</div>
                          <div class="text-[8px] text-gray-500">$12,500</div>
                        </div>
                      </div>
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">BTC/USDT Short</div>
                          <div class="text-[8px] text-gray-500">Aug 14, 15:04</div>
                        </div>
                        <div class="text-right">
                          <div class="text-[11px] text-red-400 font-medium">-$356.22</div>
                          <div class="text-[8px] text-gray-500">$35,000</div>
                        </div>
                      </div>
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">SOL/USDT Long</div>
                          <div class="text-[8px] text-gray-500">Aug 12, 08:40</div>
                        </div>
                        <div class="text-right">
                          <div class="text-[11px] text-emerald-400 font-medium">+$98.60</div>
                          <div class="text-[8px] text-gray-500">$4,800</div>
                        </div>
                      </div>
        </div>
      </div>
                  
                  <!-- Charts Tab (Hidden) -->
                  <div id="tab-charts-content" class="p-3 hidden">
                    <!-- P&L vs Benchmark Chart -->
                    <div class="mb-4">
                      <div class="text-[11px] text-gray-400 mb-2">P&L vs Benchmark (30D)</div>
                      <div class="h-24 bg-gray-800/40 rounded border border-gray-700/30 p-2 relative">
                        <!-- Simplified chart representation -->
                        <div class="h-full flex items-end justify-between gap-1">
                          <div class="w-1 bg-red-500 h-3/4"></div>
                          <div class="w-1 bg-emerald-500 h-2/3"></div>
                          <div class="w-1 bg-emerald-500 h-4/5"></div>
                          <div class="w-1 bg-red-500 h-1/2"></div>
                          <div class="w-1 bg-emerald-500 h-full"></div>
                          <div class="w-1 bg-emerald-500 h-3/5"></div>
                          <div class="w-1 bg-red-500 h-2/5"></div>
                          <div class="w-1 bg-emerald-500 h-4/5"></div>
                          <div class="w-1 bg-red-500 h-1/3"></div>
                          <div class="w-1 bg-emerald-500 h-2/3"></div>
                        </div>
                        <div class="absolute top-1 left-2 text-[11px] text-gray-500">P&L Trend</div>
                        <div class="absolute bottom-1 right-2 text-[11px] text-emerald-400">+$1,247</div>
                      </div>
                    </div>

                    <!-- Asset Allocation Chart -->
                    <div class="mb-4">
                      <div class="text-[11px] text-gray-400 mb-2">Asset Allocation</div>
                      <div class="h-20 bg-gray-800/40 rounded border border-gray-700/30 p-2 relative">
                        <!-- Doughnut chart representation -->
                        <div class="flex items-center justify-center h-full">
                          <div class="relative w-12 h-12">
                            <div class="absolute inset-0 rounded-full" style="background: conic-gradient(#f97316 0% 42%, #3b82f6 42% 63%, #a855f7 63% 71%, #6b7280 71% 100%);"></div>
                            <div class="absolute inset-2 bg-gray-800 rounded-full"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-[6px] text-white font-bold">Portfolio</div>
                          </div>
                        </div>
                        <div class="absolute top-1 right-1 text-[11px] text-gray-500">
                          <div class="flex items-center gap-1 mb-1"><div class="w-1 h-1 bg-orange-500"></div>BTC 42%</div>
                          <div class="flex items-center gap-1 mb-1"><div class="w-1 h-1 bg-blue-500"></div>ETH 21%</div>
                          <div class="flex items-center gap-1 mb-1"><div class="w-1 h-1 bg-purple-500"></div>SOL 8%</div>
                          <div class="flex items-center gap-1"><div class="w-1 h-1 bg-gray-500"></div>USDT 29%</div>
                        </div>
                      </div>
                    </div>

                    <!-- Secondary Charts Grid -->
                    <div class="grid grid-cols-1 gap-3">
                      <!-- Drawdown Chart -->
                      <div>
                        <div class="text-[11px] text-gray-400 mb-2">Max Drawdown (30D)</div>
                        <div class="h-16 bg-gray-800/40 rounded border border-gray-700/30 p-2 relative">
                          <div class="h-full flex items-end justify-between gap-1">
                            <div class="w-1 bg-red-500 h-1/4"></div>
                            <div class="w-1 bg-red-500 h-2/5"></div>
                            <div class="w-1 bg-red-500 h-3/5"></div>
                            <div class="w-1 bg-red-500 h-4/5"></div>
                            <div class="w-1 bg-red-500 h-full"></div>
                            <div class="w-1 bg-red-500 h-3/4"></div>
                            <div class="w-1 bg-red-500 h-1/2"></div>
                            <div class="w-1 bg-red-500 h-1/3"></div>
                          </div>
                          <div class="absolute top-1 left-2 text-[11px] text-gray-500">Drawdown</div>
                          <div class="absolute bottom-1 right-2 text-[11px] text-red-400">-8.2%</div>
                        </div>
                      </div>

                      <!-- Win/Loss by Weekday -->
                      <div>
                        <div class="text-[11px] text-gray-400 mb-2">Win Rate by Weekday</div>
                        <div class="h-16 bg-gray-800/40 rounded border border-gray-700/30 p-2 relative">
                          <div class="h-full flex items-end justify-between gap-1">
                            <div class="flex flex-col items-center">
                              <div class="w-3 bg-emerald-500 h-10 mb-1"></div>
                              <div class="text-[11px] text-gray-500">M</div>
                            </div>
                            <div class="flex flex-col items-center">
                              <div class="w-3 bg-yellow-500 h-6 mb-1"></div>
                              <div class="text-[11px] text-gray-500">T</div>
                            </div>
                            <div class="flex flex-col items-center">
                              <div class="w-3 bg-emerald-500 h-12 mb-1"></div>
                              <div class="text-[11px] text-gray-500">W</div>
                            </div>
                            <div class="flex flex-col items-center">
                              <div class="w-3 bg-yellow-500 h-8 mb-1"></div>
                              <div class="text-[11px] text-gray-500">T</div>
                            </div>
                            <div class="flex flex-col items-center">
                              <div class="w-3 bg-emerald-500 h-10 mb-1"></div>
                              <div class="text-[11px] text-gray-500">F</div>
                            </div>
                          </div>
                          <div class="absolute top-1 left-2 text-[11px] text-gray-500">Win %</div>
                          <div class="absolute top-1 right-2 text-[11px] text-emerald-400">Best: Mon</div>
                        </div>
                      </div>

                      <!-- Fees Chart -->
                      <div>
                        <div class="text-[11px] text-gray-400 mb-2">Trading Fees (30D)</div>
                        <div class="h-16 bg-gray-800/40 rounded border border-gray-700/30 p-2 relative">
                          <div class="h-full flex items-end justify-between gap-1">
                            <div class="w-1 bg-purple-500 h-2/3"></div>
                            <div class="w-1 bg-purple-500 h-1/2"></div>
                            <div class="w-1 bg-purple-500 h-3/4"></div>
                            <div class="w-1 bg-purple-500 h-4/5"></div>
                            <div class="w-1 bg-purple-500 h-full"></div>
                            <div class="w-1 bg-purple-500 h-3/5"></div>
                            <div class="w-1 bg-purple-500 h-2/5"></div>
                            <div class="w-1 bg-purple-500 h-1/3"></div>
                          </div>
                          <div class="absolute top-1 left-2 text-[11px] text-gray-500">Fees</div>
                          <div class="absolute bottom-1 right-2 text-[11px] text-purple-400">$127.45</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Fills Tab (Hidden) -->
                  <div id="tab-fills-content" class="p-3 hidden">
                    <div class="text-[11px] text-gray-400 mb-2">Fill History</div>
                    <div class="space-y-2">
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">ETH/USDT</div>
                          <div class="text-[8px] text-gray-500">Aug 14, 10:22:19</div>
                        </div>
                    <div class="text-right">
                          <div class="text-[11px] text-white font-medium">$2,498.12</div>
                          <div class="text-[8px] text-red-400">-$1.12 fee</div>
                        </div>
                      </div>
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">BTC/USDT</div>
                          <div class="text-[8px] text-gray-500">Aug 14, 15:04:02</div>
                        </div>
                        <div class="text-right">
                          <div class="text-[11px] text-white font-medium">$61,202.30</div>
                          <div class="text-[8px] text-red-400">-$2.44 fee</div>
                        </div>
                      </div>
    </div>
  </div>

                  <!-- Funding Tab (Hidden) -->
                  <div id="tab-funding-content" class="p-3 hidden">
                    <div class="text-[11px] text-gray-400 mb-2">Funding Payments</div>
                    <div class="space-y-2">
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">BTC-PERP</div>
                          <div class="text-[8px] text-gray-500">Aug 14, 04:00</div>
                        </div>
                    <div class="text-right">
                          <div class="text-[11px] text-emerald-400 font-medium">+$6.20</div>
      </div>
    </div>
                      <div class="flex items-center justify-between py-1 border-b border-gray-700/20">
                        <div class="flex-1">
                          <div class="text-[11px] text-gray-300">ETH-PERP</div>
                          <div class="text-[8px] text-gray-500">Aug 13, 20:00</div>
                        </div>
                        <div class="text-right">
                          <div class="text-[11px] text-red-400 font-medium">-$3.42</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Calendar Tab (Hidden) -->
                  <div id="tab-calendar-content" class="p-3 hidden relative">
                    <div class="text-[11px] text-gray-400 mb-2">Trading Calendar (August)</div>
                    
                    <!-- Calendar Controls -->
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-1">
                        <button class="h-6 w-6 rounded border border-gray-600/30 text-[10px] text-gray-400 hover:text-gray-300">‹</button>
                        <div class="px-2 py-1 text-[11px] text-gray-300">Aug 2025</div>
                        <button class="h-6 w-6 rounded border border-gray-600/30 text-[10px] text-gray-400 hover:text-gray-300">›</button>
                      </div>
                      <div class="flex items-center gap-2 text-[7px]">
                        <span class="text-gray-400">Legend:</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-emerald-500 rounded-full"></div>Profit</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-red-500 rounded-full"></div>Loss</span>
                      </div>
                    </div>

                    <!-- Month Summary (4 metrics) -->
                    <div class="grid grid-cols-2 gap-2 mb-3">
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Month P&L</div>
                        <div class="text-[10px] font-semibold text-red-400 mono">-$12,632.20</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Volume</div>
                        <div class="text-[10px] font-semibold text-white mono">$613,606.91</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Most Profitable</div>
                        <div class="text-[10px] font-semibold text-emerald-400 mono">ETH +$422.42</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Win Rate</div>
                        <div class="text-[10px] font-semibold text-white mono">50%</div>
                      </div>
                    </div>

                    <!-- Calendar Grid Header -->
                    <div class="grid grid-cols-7 gap-1 text-[8px] mb-1">
                      <div class="text-center text-gray-500">Sun</div>
                      <div class="text-center text-gray-500">Mon</div>
                      <div class="text-center text-gray-500">Tue</div>
                      <div class="text-center text-gray-500">Wed</div>
                      <div class="text-center text-gray-500">Thu</div>
                      <div class="text-center text-gray-500">Fri</div>
                      <div class="text-center text-gray-500">Sat</div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 relative z-10">
                      <!-- Week 1 (July 28-Aug 3) -->
                      <div class="h-12 border border-gray-600/20 rounded text-[10px] p-1 text-gray-500">28</div>
                      <div class="h-12 border border-gray-600/20 rounded text-[10px] p-1 text-gray-500">29</div>
                      <div class="h-12 border border-gray-600/20 rounded text-[10px] p-1 text-gray-500">30</div>
                      <div class="h-12 border border-gray-600/20 rounded text-[10px] p-1 text-gray-500">31</div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 1" data-value="+$45.32">
                        1<br><span class="text-[9px] font-semibold">+$45</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 1: <span class="text-emerald-400 font-bold">+$45.32</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 2" data-value="-$12.67">
                        2<br><span class="text-[9px] font-semibold">-$12</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 2: <span class="text-red-400 font-bold">-$12.67</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 3" data-value="+$89.45">
                        3<br><span class="text-[9px] font-semibold">+$89</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 3: <span class="text-emerald-400 font-bold">+$89.45</span>
                        </div>
                      </div>
                      
                      <!-- Week 2 (Aug 4-10) -->
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">4</div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 5" data-value="-$23.89">
                        5<br><span class="text-[9px] font-semibold">-$23</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 5: <span class="text-red-400 font-bold">-$23.89</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 6" data-value="+$156.78">
                        6<br><span class="text-[9px] font-semibold">+$156</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 6: <span class="text-emerald-400 font-bold">+$156.78</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 7" data-value="+$78.23">
                        7<br><span class="text-[9px] font-semibold">+$78</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 7: <span class="text-emerald-400 font-bold">+$78.23</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 8" data-value="-$67.45">
                        8<br><span class="text-[9px] font-semibold">-$67</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 8: <span class="text-red-400 font-bold">-$67.45</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 9" data-value="+$234.56">
                        9<br><span class="text-[9px] font-semibold">+$234</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 9: <span class="text-emerald-400 font-bold">+$234.56</span>
                        </div>
                      </div>
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">10</div>
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">11</div>
                      
                      <!-- Week 3 (Aug 11-17) -->
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 12" data-value="+$98.60">
                        12<br><span class="text-[9px] font-semibold">+$98</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 12: <span class="text-emerald-400 font-bold">+$98.60</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 13" data-value="-$145.22">
                        13<br><span class="text-[9px] font-semibold">-$145</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 13: <span class="text-red-400 font-bold">-$145.22</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 ring-1 ring-blue-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 14" data-value="+$422.42">
                        14<br><span class="text-[9px] font-semibold">+$422</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 14: <span class="text-emerald-400 font-bold">+$422.42</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 15" data-value="-$356.22">
                        15<br><span class="text-[9px] font-semibold">-$356</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 15: <span class="text-red-400 font-bold">-$356.22</span>
                        </div>
                      </div>
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">16</div>
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">17</div>
                      
                      <!-- Week 4 (Aug 18-24) -->
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">18</div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 19" data-value="+$167.89">
                        19<br><span class="text-[9px] font-semibold">+$167</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 19: <span class="text-emerald-400 font-bold">+$167.89</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 20" data-value="-$89.34">
                        20<br><span class="text-[9px] font-semibold">-$89</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 20: <span class="text-red-400 font-bold">-$89.34</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 21" data-value="+$312.45">
                        21<br><span class="text-[9px] font-semibold">+$312</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 21: <span class="text-emerald-400 font-bold">+$312.45</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 22" data-value="-$178.67">
                        22<br><span class="text-[9px] font-semibold">-$178</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 22: <span class="text-red-400 font-bold">-$178.67</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 23" data-value="+$445.23">
                        23<br><span class="text-[9px] font-semibold">+$445</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 23: <span class="text-emerald-400 font-bold">+$445.23</span>
                        </div>
                      </div>
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">24</div>
                      
                      <!-- Week 5 (Aug 25-31) -->
                      <div class="h-12 border border-gray-700/30 rounded text-[10px] p-1 text-gray-400">25</div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 26" data-value="-$234.78">
                        26<br><span class="text-[9px] font-semibold">-$234</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 26: <span class="text-red-400 font-bold">-$234.78</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 27" data-value="+$189.45">
                        27<br><span class="text-[9px] font-semibold">+$189</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 27: <span class="text-emerald-400 font-bold">+$189.45</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 28" data-value="+$67.89">
                        28<br><span class="text-[9px] font-semibold">+$67</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 28: <span class="text-emerald-400 font-bold">+$67.89</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 29" data-value="-$123.56">
                        29<br><span class="text-[9px] font-semibold">-$123</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 29: <span class="text-red-400 font-bold">-$123.56</span>
                        </div>
                      </div>
                      <div class="h-12 border border-emerald-600/30 bg-emerald-600/10 rounded text-[10px] p-1 text-emerald-400 hover:bg-emerald-600/20 transition-colors cursor-pointer relative group" data-date="Aug 30" data-value="+$278.34">
                        30<br><span class="text-[9px] font-semibold">+$278</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 30: <span class="text-emerald-400 font-bold">+$278.34</span>
                        </div>
                      </div>
                      <div class="h-12 border border-red-600/30 bg-red-600/10 rounded text-[10px] p-1 text-red-400 hover:bg-red-600/20 transition-colors cursor-pointer relative group" data-date="Aug 31" data-value="-$89.12">
                        31<br><span class="text-[9px] font-semibold">-$89</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-gray-700 text-white text-base rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-150 whitespace-nowrap z-50 pointer-events-none">
                          Aug 31: <span class="text-red-400 font-bold">-$89.12</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Performance Charts Summary -->
                  <div class="p-3 border-t border-gray-700/30">
                    <div class="text-[11px] text-gray-400 mb-2">Performance Summary</div>
                    <div class="grid grid-cols-2 gap-2">
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Max Drawdown</div>
                        <div class="text-[10px] font-semibold text-red-400 mono">-8.2%</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Best Day</div>
                        <div class="text-[10px] font-semibold text-emerald-400 mono">Mon</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Total Fees</div>
                        <div class="text-[10px] font-semibold text-yellow-400 mono">$127.45</div>
                      </div>
                      <div class="p-2 bg-gray-800/40 rounded border border-gray-700/30">
                        <div class="text-[11px] text-gray-400">Directional Bias</div>
                        <div class="text-[10px] font-semibold text-emerald-400">Long</div>
                      </div>
                    </div>
                  </div>
  </div>
          </div>
        `;

          case 'signals':
            return `
              <div class="flex flex-col h-full">
                <!-- Filter Tabs -->
                <div class="shrink-0 mb-3">
                  <div class="flex gap-1 bg-gray-800/50 rounded-md p-0.5">
                    <button class="signal-filter flex-1 px-2 py-1 text-[11px] font-medium rounded-sm bg-gray-700 text-gray-200" data-filter="all">All</button>
                    <button class="signal-filter flex-1 px-2 py-1 text-[11px] font-medium rounded-sm text-gray-400 hover:text-gray-200" data-filter="long">Long</button>
                    <button class="signal-filter flex-1 px-2 py-1 text-[11px] font-medium rounded-sm text-gray-400 hover:text-gray-200" data-filter="short">Short</button>
                  </div>
                </div>

                <!-- Signals Container -->
                <div id="signalsContainer" class="flex-1 overflow-auto space-y-3">
                  <!-- LONG Signal Cards -->
                  <div class="bg-gray-800/30 rounded-lg p-3 border border-green-500/30 cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                      <img src="https://images.unsplash.com/photo-1494790108755-2616b612b647?w=32&q=80" class="w-8 h-8 rounded-full" alt="Evelyn Chen">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-white text-[11px]">Evelyn Chen</h3>
                          <span class="text-[10px] text-gray-400">2h</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded">LONG</span>
                          <span class="text-[10px] text-gray-300">ETH/USDT</span>
                        </div>
                        <h4 class="text-white font-medium mb-2 text-[11px]">ETH Bull Flag Breakout Setup</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Entry</div>
                            <div class="font-mono text-white font-semibold">$2,480</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Target</div>
                            <div class="font-mono text-green-400 font-semibold">$2,560</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Stop Loss</div>
                            <div class="font-mono text-red-400 font-semibold">$2,440</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Take Profit</div>
                            <div class="font-mono text-green-400 font-semibold">$2,580</div>
                          </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                          <div class="flex items-center gap-2 text-[10px] text-gray-400">
                            <span>122 likes</span>
                            <span>48 comments</span>
                          </div>
                          <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="bg-gray-800/30 rounded-lg p-3 border border-green-500/30 cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                      <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=32&q=80" class="w-8 h-8 rounded-full" alt="Marcus Li">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-white text-[11px]">Marcus Li</h3>
                          <span class="text-[10px] text-gray-400">4h</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded">LONG</span>
                          <span class="text-[10px] text-gray-300">BTC/USDT</span>
                        </div>
                        <h4 class="text-white font-medium mb-2 text-[11px]">BTC Support Zone Long</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Entry</div>
                            <div class="font-mono text-white font-semibold">$64,200</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Target</div>
                            <div class="font-mono text-green-400 font-semibold">$66,800</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Stop Loss</div>
                            <div class="font-mono text-red-400 font-semibold">$63,500</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Take Profit</div>
                            <div class="font-mono text-green-400 font-semibold">$67,500</div>
                          </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                          <div class="flex items-center gap-2 text-[10px] text-gray-400">
                            <span>89 likes</span>
                            <span>34 comments</span>
                          </div>
                          <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- SHORT Signal Cards -->
                  <div class="bg-gray-800/30 rounded-lg p-3 border border-red-500/30 cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                      <img src="https://images.unsplash.com/photo-1507591064344-4c6ce005b128?w=32&q=80" class="w-8 h-8 rounded-full" alt="Kenji Sato">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-white text-[11px]">Kenji Sato</h3>
                          <span class="text-[10px] text-gray-400">3h</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded">SHORT</span>
                          <span class="text-[10px] text-gray-300">BTC/USDT</span>
                        </div>
                        <h4 class="text-white font-medium mb-2 text-[11px]">BTC Rejection at Resistance</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Entry</div>
                            <div class="font-mono text-white font-semibold">$65,800</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Target</div>
                            <div class="font-mono text-red-400 font-semibold">$63,200</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Stop Loss</div>
                            <div class="font-mono text-red-400 font-semibold">$66,500</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Take Profit</div>
                            <div class="font-mono text-red-400 font-semibold">$62,100</div>
                          </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                          <div class="flex items-center gap-2 text-[10px] text-gray-400">
                            <span>89 likes</span>
                            <span>23 comments</span>
                          </div>
                          <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="bg-gray-800/30 rounded-lg p-3 border border-red-500/30 cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                      <img src="https://images.unsplash.com/photo-1494790108755-2616b612b647?w=32&q=80" class="w-8 h-8 rounded-full" alt="BearHunter">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-white text-[11px]">BearHunter</h3>
                          <span class="text-[10px] text-gray-400">5h</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded">SHORT</span>
                          <span class="text-[10px] text-gray-300">ETH/USDT</span>
                        </div>
                        <h4 class="text-white font-medium mb-2 text-[11px]">ETH Head and Shoulders</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Entry</div>
                            <div class="font-mono text-white font-semibold">$2,520</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Target</div>
                            <div class="font-mono text-red-400 font-semibold">$2,380</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Stop Loss</div>
                            <div class="font-mono text-red-400 font-semibold">$2,580</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Take Profit</div>
                            <div class="font-mono text-red-400 font-semibold">$2,320</div>
                          </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                          <div class="flex items-center gap-2 text-[10px] text-gray-400">
                            <span>67 likes</span>
                            <span>19 comments</span>
                          </div>
                          <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="bg-gray-800/30 rounded-lg p-3 border border-green-500/30 cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                      <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&q=80" class="w-8 h-8 rounded-full" alt="CryptoNinja">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-white text-[11px]">CryptoNinja</h3>
                          <span class="text-[10px] text-gray-400">6h</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded">LONG</span>
                          <span class="text-[10px] text-gray-300">SOL/USDT</span>
                        </div>
                        <h4 class="text-white font-medium mb-2 text-[11px]">SOL Ascending Triangle</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Entry</div>
                            <div class="font-mono text-white font-semibold">$128.50</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Target</div>
                            <div class="font-mono text-green-400 font-semibold">$135.20</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Stop Loss</div>
                            <div class="font-mono text-red-400 font-semibold">$125.80</div>
                          </div>
                          <div class="bg-gray-700/40 rounded p-1.5 text-center">
                            <div class="text-gray-400">Take Profit</div>
                            <div class="font-mono text-green-400 font-semibold">$138.40</div>
                          </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                          <div class="flex items-center gap-2 text-[10px] text-gray-400">
                            <span>156 likes</span>
                            <span>67 comments</span>
                          </div>
                          <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;

          default:
            return `<div class="text-center text-gray-400 py-8 text-[12px]">Content for ${type}</div>`;
        }
      }

      // Order Book Functionality
      let orderBookData = {
        sells: [],
        buys: [],
        lastPrice: 65432.50,
        priceDirection: 'up',
        buyVolume: 0,
        sellVolume: 0
      };

      let orderBookUpdateInterval;

      function initializeOrderBook() {
        console.log('Initializing order book...');
        generateInitialOrderBookData();
        renderOrderBook();
        startOrderBookUpdates();
        
        // Tab functionality
        const obTab = document.getElementById('obTab');
        const rtTab = document.getElementById('rtTab');
        
        if (obTab && rtTab) {
          obTab.addEventListener('click', () => switchOrderBookTab('orderbook'));
          rtTab.addEventListener('click', () => switchOrderBookTab('trades'));
        }
      }

      function generateInitialOrderBookData() {
        const basePrice = 65432.50;
        const spread = 0.50;
        
        // Generate sell orders (asks) - descending from highest price
        orderBookData.sells = [];
        let cumulativeTotal = 0;
        for (let i = 12; i >= 1; i--) {
          const price = basePrice + spread + (i * (Math.random() * 2 + 0.5));
          const amount = Math.random() * 3 + 0.1;
          cumulativeTotal += amount;
          
          orderBookData.sells.push({
            price: price,
            amount: amount,
            total: cumulativeTotal,
            id: `sell-${i}`
          });
        }
        
        // Generate buy orders (bids) - ascending towards mid price
        orderBookData.buys = [];
        cumulativeTotal = 0;
        for (let i = 1; i <= 12; i++) {
          const price = basePrice - spread - (i * (Math.random() * 2 + 0.5));
          const amount = Math.random() * 3 + 0.1;
          cumulativeTotal += amount;
          
          orderBookData.buys.push({
            price: price,
            amount: amount,
            total: cumulativeTotal,
            id: `buy-${i}`
          });
        }
        
        // Calculate volumes for ratio
        orderBookData.buyVolume = orderBookData.buys.reduce((sum, order) => sum + order.amount, 0);
        orderBookData.sellVolume = orderBookData.sells.reduce((sum, order) => sum + order.amount, 0);
      }

      function renderOrderBook() {
        const sellOrdersContainer = document.getElementById('sellOrders');
        const buyOrdersContainer = document.getElementById('buyOrders');
        const lastPriceElement = document.getElementById('lastPrice');
        const priceArrowElement = document.getElementById('priceArrow');
        const fiatPriceElement = document.getElementById('fiatPrice');
        
        if (!sellOrdersContainer || !buyOrdersContainer) return;
        
        // Calculate max values for bar scaling
        const maxSellAmount = Math.max(...orderBookData.sells.map(o => o.amount));
        const maxBuyAmount = Math.max(...orderBookData.buys.map(o => o.amount));
        const maxAmount = Math.max(maxSellAmount, maxBuyAmount);

        // Render sell orders
        sellOrdersContainer.innerHTML = orderBookData.sells.map(order => {
          const barWidth = (order.amount / maxAmount * 100).toFixed(1);
          return `
            <div class="order-row relative grid grid-cols-3 gap-1 px-1 py-0.5 text-[10px] mono hover:bg-red-500/5 cursor-pointer" data-id="${order.id}">
              <div class="absolute inset-0 flex items-center justify-end pointer-events-none">
                <div class="h-full bg-red-500/10 transition-all duration-300 ease-in-out dynamic-width" style="--width: ${barWidth}%"></div>
          </div>
              <div class="relative text-right text-red-400 font-medium">${order.price.toFixed(2)}</div>
              <div class="relative text-right text-gray-300">${order.amount.toFixed(3)}</div>
              <div class="relative text-right text-gray-400">${order.total.toFixed(3)}</div>
        </div>
          `;
        }).join('');
        
        // Render buy orders
        buyOrdersContainer.innerHTML = orderBookData.buys.map(order => {
          const barWidth = (order.amount / maxAmount * 100).toFixed(1);
          return `
            <div class="order-row relative grid grid-cols-3 gap-1 px-1 py-0.5 text-[10px] mono hover:bg-green-500/5 cursor-pointer" data-id="${order.id}">
              <div class="absolute inset-0 flex items-center justify-end pointer-events-none">
                <div class="h-full bg-green-500/10 transition-all duration-300 ease-in-out dynamic-width" style="--width: ${barWidth}%"></div>
          </div>
              <div class="relative text-right text-green-400 font-medium">${order.price.toFixed(2)}</div>
              <div class="relative text-right text-gray-300">${order.amount.toFixed(3)}</div>
              <div class="relative text-right text-gray-400">${order.total.toFixed(3)}</div>
        </div>
      `;
        }).join('');
        
        // Update mid price
        if (lastPriceElement) {
          lastPriceElement.textContent = orderBookData.lastPrice.toFixed(2);
          lastPriceElement.classList.add('price-flash');
          setTimeout(() => lastPriceElement.classList.remove('price-flash'), 600);
        }
        
        if (priceArrowElement) {
          priceArrowElement.className = `w-3 h-3 ${orderBookData.priceDirection === 'up' ? 'text-green-400' : 'text-red-400'}`;
          if (orderBookData.priceDirection === 'up') {
            priceArrowElement.innerHTML = '<path d="M7 14l5-5 5 5"/>';
          } else {
            priceArrowElement.innerHTML = '<path d="M17 10l-5 5-5-5"/>';
          }
        }
        
        if (fiatPriceElement) {
          fiatPriceElement.textContent = `$${orderBookData.lastPrice.toFixed(2)}`;
        }
        
        // Update buy/sell ratio
        updateBuySellRatio();
      }

      function updateBuySellRatio() {
        const totalVolume = orderBookData.buyVolume + orderBookData.sellVolume;
        const buyPercentage = (orderBookData.buyVolume / totalVolume * 100).toFixed(0);
        const sellPercentage = (orderBookData.sellVolume / totalVolume * 100).toFixed(0);
        
        const buyRatioElement = document.getElementById('buyRatio');
        const buyPercentElement = document.getElementById('buyPercent');
        const sellPercentElement = document.getElementById('sellPercent');
        
        if (buyRatioElement) {
          buyRatioElement.style.setProperty('--width', `${buyPercentage}%`);
          buyRatioElement.className = buyRatioElement.className + ' dynamic-width';
        }
        
        if (buyPercentElement) {
          buyPercentElement.textContent = `${buyPercentage}%`;
        }
        
        if (sellPercentElement) {
          sellPercentElement.textContent = `${sellPercentage}%`;
        }
      }

      function updateOrderBookData() {
        // Simulate price movement
        const priceChange = (Math.random() - 0.5) * 10;
        const newPrice = orderBookData.lastPrice + priceChange;
        orderBookData.priceDirection = priceChange >= 0 ? 'up' : 'down';
        orderBookData.lastPrice = Math.max(newPrice, 50000); // Minimum price floor
        
        // Update some orders with animation
        const updateCount = Math.floor(Math.random() * 4) + 1;
        
        for (let i = 0; i < updateCount; i++) {
          // Randomly update sell orders
          if (Math.random() > 0.5 && orderBookData.sells.length > 0) {
            const randomIndex = Math.floor(Math.random() * orderBookData.sells.length);
            const order = orderBookData.sells[randomIndex];
            order.amount = Math.random() * 3 + 0.1;
            order.price += (Math.random() - 0.5) * 2;
            
            // Recalculate cumulative totals for sells
            let cumulativeTotal = 0;
            for (let j = orderBookData.sells.length - 1; j >= 0; j--) {
              cumulativeTotal += orderBookData.sells[j].amount;
              orderBookData.sells[j].total = cumulativeTotal;
            }
          }
          
          // Randomly update buy orders
          if (Math.random() > 0.5 && orderBookData.buys.length > 0) {
            const randomIndex = Math.floor(Math.random() * orderBookData.buys.length);
            const order = orderBookData.buys[randomIndex];
            order.amount = Math.random() * 3 + 0.1;
            order.price += (Math.random() - 0.5) * 2;
            
            // Recalculate cumulative totals for buys
            let cumulativeTotal = 0;
            for (let j = 0; j < orderBookData.buys.length; j++) {
              cumulativeTotal += orderBookData.buys[j].amount;
              orderBookData.buys[j].total = cumulativeTotal;
            }
          }
        }
        
        // Recalculate volumes
        orderBookData.buyVolume = orderBookData.buys.reduce((sum, order) => sum + order.amount, 0);
        orderBookData.sellVolume = orderBookData.sells.reduce((sum, order) => sum + order.amount, 0);
        
        renderOrderBook();
      }

      function startOrderBookUpdates() {
        if (orderBookUpdateInterval) {
          clearInterval(orderBookUpdateInterval);
        }
        
        orderBookUpdateInterval = setInterval(() => {
          updateOrderBookData();
        }, 2000 + Math.random() * 3000); // Random interval between 2-5 seconds
      }

      function switchOrderBookTab(tab) {
        const obTab = document.getElementById('obTab');
        const rtTab = document.getElementById('rtTab');
        
        if (tab === 'orderbook') {
          obTab.className = 'px-2 py-1 text-[10px] font-medium rounded-sm bg-gray-700 text-gray-200';
          rtTab.className = 'px-2 py-1 text-[10px] font-medium rounded-sm text-gray-400 hover:text-gray-200';
          // Show order book content (already visible)
        } else {
          rtTab.className = 'px-2 py-1 text-[10px] font-medium rounded-sm bg-gray-700 text-gray-200';
          obTab.className = 'px-2 py-1 text-[10px] font-medium rounded-sm text-gray-400 hover:text-gray-200';
          // Could implement recent trades view here
          console.log('Recent trades tab clicked - functionality can be added');
        }
      }

      // Live News Functionality
      let newsData = [];
      let filteredNewsData = [];
      let newsUpdateInterval;
      let newsSearchTags = [];
      let newsTimeFilter = 'all';

      // Community Signals Data - Using the exact same data from communityFeed
      const communitySignalsData = [
        // LONG Signals
        {
          type: 'signal',
          direction: 'long',
          author: 'Evelyn Chen',
          avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b647?w=32&q=80',
          time: '2h',
          pair: 'ETH/USDT',
          title: 'ETH Bull Flag Breakout Setup',
          entry: '$2,480',
          target: '$2,560',
          stopLoss: '$2,440',
          takeProfit: '$2,580',
          likes: 122,
          comments: 48
        },
        {
          type: 'signal',
          direction: 'long',
          author: 'Marcus Li',
          avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=32&q=80',
          time: '4h',
          pair: 'BTC/USDT',
          title: 'BTC Support Zone Long',
          entry: '$64,200',
          target: '$66,800',
          stopLoss: '$63,500',
          takeProfit: '$67,500',
          likes: 89,
          comments: 34
        },
        {
          type: 'signal',
          direction: 'long',
          author: 'CryptoNinja',
          avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&q=80',
          time: '6h',
          pair: 'SOL/USDT',
          title: 'SOL Ascending Triangle',
          entry: '$128.50',
          target: '$135.20',
          stopLoss: '$125.80',
          takeProfit: '$138.40',
          likes: 156,
          comments: 67
        },
        {
          type: 'signal',
          direction: 'long',
          author: 'TradeGuru',
          avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=32&q=80',
          time: '8h',
          pair: 'ADA/USDT',
          title: 'ADA Double Bottom Pattern',
          entry: '$0.485',
          target: '$0.520',
          stopLoss: '$0.465',
          takeProfit: '$0.535',
          likes: 78,
          comments: 23
        },
        {
          type: 'signal',
          direction: 'long',
          author: 'AlgoTrader',
          avatar: 'https://images.unsplash.com/photo-1507591064344-4c6ce005b128?w=32&q=80',
          time: '10h',
          pair: 'MATIC/USDT',
          title: 'MATIC Cup and Handle',
          entry: '$0.845',
          target: '$0.920',
          stopLoss: '$0.810',
          takeProfit: '$0.950',
          likes: 134,
          comments: 45
        },
        
        // SHORT Signals
        {
          type: 'signal',
          direction: 'short',
          author: 'Kenji Sato',
          avatar: 'https://images.unsplash.com/photo-1507591064344-4c6ce005b128?w=32&q=80',
          time: '3h',
          pair: 'BTC/USDT',
          title: 'BTC Rejection at Resistance',
          entry: '$65,800',
          target: '$63,200',
          stopLoss: '$66,500',
          takeProfit: '$62,100',
          likes: 89,
          comments: 23
        },
        {
          type: 'signal',
          direction: 'short',
          author: 'BearHunter',
          avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b647?w=32&q=80',
          time: '5h',
          pair: 'ETH/USDT',
          title: 'ETH Head and Shoulders',
          entry: '$2,520',
          target: '$2,380',
          stopLoss: '$2,580',
          takeProfit: '$2,320',
          likes: 67,
          comments: 19
        },
        {
          type: 'signal',
          direction: 'short',
          author: 'ShortMaster',
          avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&q=80',
          time: '7h',
          pair: 'AVAX/USDT',
          title: 'AVAX Bearish Divergence',
          entry: '$28.50',
          target: '$26.20',
          stopLoss: '$29.80',
          takeProfit: '$25.10',
          likes: 92,
          comments: 31
        },
        {
          type: 'signal',
          direction: 'short',
          author: 'CryptoVulture',
          avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=32&q=80',
          time: '9h',
          pair: 'DOT/USDT',
          title: 'DOT Rising Wedge Breakdown',
          entry: '$6.85',
          target: '$6.20',
          stopLoss: '$7.15',
          takeProfit: '$5.90',
          likes: 76,
          comments: 28
        },
        
        // Additional LONG Signals
        {
          type: 'signal',
          direction: 'long',
          author: 'CryptoWhale',
          avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&q=80',
          time: '1h',
          pair: 'UNI/USDT',
          title: 'UNI Bullish Pennant',
          entry: '$7.25',
          target: '$7.85',
          stopLoss: '$6.95',
          takeProfit: '$8.10',
          likes: 98,
          comments: 35
        },
        {
          type: 'signal',
          direction: 'long',
          author: 'TechnicalPro',
          avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&q=80',
          time: '3h',
          pair: 'AAVE/USDT',
          title: 'AAVE Inverse Head & Shoulders',
          entry: '$89.50',
          target: '$96.20',
          stopLoss: '$85.80',
          takeProfit: '$99.40',
          likes: 112,
          comments: 41
        },
        
        // Additional SHORT Signals
        {
          type: 'signal',
          direction: 'short',
          author: 'BearMarket',
          avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=32&q=80',
          time: '2h',
          pair: 'XRP/USDT',
          title: 'XRP Double Top Reversal',
          entry: '$0.625',
          target: '$0.585',
          stopLoss: '$0.650',
          takeProfit: '$0.560',
          likes: 67,
          comments: 21
        },
        {
          type: 'signal',
          direction: 'short',
          author: 'PatternMaster',
          avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b647?w=32&q=80',
          time: '4h',
          pair: 'LTC/USDT',
          title: 'LTC Descending Triangle',
          entry: '$72.50',
          target: '$68.20',
          stopLoss: '$75.80',
          takeProfit: '$65.40',
          likes: 89,
          comments: 33
        }
      ];

      const newsFeeds = [
        { name: 'CoinDesk', url: 'https://www.coindesk.com/arc/outboundfeeds/rss/', color: 'orange' },
        { name: 'CoinTelegraph', url: 'https://cointelegraph.com/rss', color: 'blue' },
        { name: 'Decrypt', url: 'https://decrypt.co/feed', color: 'purple' },
        { name: 'Bitcoin Magazine', url: 'https://bitcoinmagazine.com/.rss/full/', color: 'yellow' }
      ];

      async function fetchNews() {
        console.log('Fetching live news...');
        const allNews = [];

        for (const feed of newsFeeds) {
          try {
            // Using multiple proxy services for better reliability
            const proxies = [
              `https://api.allorigins.win/get?url=${encodeURIComponent(feed.url)}`,
              `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&count=15`,
              `https://cors-anywhere.herokuapp.com/${feed.url}`,
              `https://thingproxy.freeboard.io/fetch/${feed.url}`
            ];
            
            let response;
            let proxyIndex = 0;
            
            while (proxyIndex < proxies.length) {
              try {
                console.log(`Trying proxy ${proxyIndex + 1} for ${feed.name}...`);
                response = await fetch(proxies[proxyIndex]);
                if (response.ok) break;
              } catch (e) {
                console.log(`Proxy ${proxyIndex + 1} failed for ${feed.name}:`, e.message);
              }
              proxyIndex++;
            }
            
            if (!response || !response.ok) {
              throw new Error(`All proxies failed for ${feed.name}`);
            }
            
            const data = await response.json();
            
            let items = [];
            if (data.items) {
              // RSS2JSON format
              items = data.items.slice(0, 10);
            } else if (data.contents) {
              // AllOrigins format - parse XML
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(data.contents, 'text/xml');
              const xmlItems = xmlDoc.querySelectorAll('item');
              
              items = Array.from(xmlItems).slice(0, 10).map(item => ({
                title: item.querySelector('title')?.textContent || 'No title',
                link: item.querySelector('link')?.textContent || '#',
                pubDate: item.querySelector('pubDate')?.textContent || new Date().toISOString(),
                description: item.querySelector('description')?.textContent || ''
              }));
            } else if (typeof data === 'string') {
              // Raw XML response
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(data, 'text/xml');
              const xmlItems = xmlDoc.querySelectorAll('item');
              
              items = Array.from(xmlItems).slice(0, 10).map(item => ({
                title: item.querySelector('title')?.textContent || 'No title',
                link: item.querySelector('link')?.textContent || '#',
                pubDate: item.querySelector('pubDate')?.textContent || new Date().toISOString(),
                description: item.querySelector('description')?.textContent || ''
              }));
            }

            console.log(`Successfully fetched ${items.length} articles from ${feed.name}`);
            
            items.forEach(item => {
              if (item.title && item.title !== 'No title') {
                allNews.push({
                  title: item.title,
                  link: item.link,
                  pubDate: new Date(item.pubDate),
                  source: feed.name,
                  sourceColor: feed.color,
                  description: item.description || '',
                  type: determineNewsType(item.title, item.description)
                });
              }
            });

          } catch (error) {
            console.error(`Error fetching ${feed.name}:`, error);
          }
        }

        // Sort by date (newest first)
        allNews.sort((a, b) => b.pubDate - a.pubDate);
        
        // If we have very few articles, add some fallback content
        if (allNews.length < 5) {
          console.warn('Very few articles fetched, adding fallback content...');
          const fallbackNews = [
            {
              title: 'Bitcoin Trading Volume Surges as Market Sentiment Improves',
              link: '#',
              pubDate: new Date(Date.now() - 10 * 60 * 1000),
              source: 'CoinDesk',
              sourceColor: 'orange',
              description: 'Bitcoin sees increased trading activity as institutional investors show renewed interest.',
              type: 'bullish'
            },
            {
              title: 'Ethereum Layer 2 Solutions Show Strong Growth',
              link: '#',
              pubDate: new Date(Date.now() - 30 * 60 * 1000),
              source: 'CoinTelegraph',
              sourceColor: 'blue',
              description: 'Layer 2 scaling solutions continue to gain traction in the Ethereum ecosystem.',
              type: 'bullish'
            },
            {
              title: 'Regulatory Clarity Expected for Crypto Markets',
              link: '#',
              pubDate: new Date(Date.now() - 60 * 60 * 1000),
              source: 'Decrypt',
              sourceColor: 'purple',
              description: 'Government officials signal upcoming regulatory framework for digital assets.',
              type: 'neutral'
            },
            {
              title: 'DeFi Protocols Report Record TVL Growth',
              link: '#',
              pubDate: new Date(Date.now() - 2 * 60 * 60 * 1000),
              source: 'Bitcoin Magazine',
              sourceColor: 'yellow',
              description: 'Decentralized finance platforms see significant increase in total value locked.',
              type: 'bullish'
            }
          ];
          
          allNews.push(...fallbackNews);
          allNews.sort((a, b) => b.pubDate - a.pubDate);
        }
        
        // Take top 25 articles (more news for better filtering)
        newsData = allNews.slice(0, 25);
        
        console.log(`Final news dataset: ${newsData.length} articles`);
        return newsData;
      }

      function determineNewsType(title, description) {
        const text = (title + ' ' + description).toLowerCase();
        const bullishKeywords = ['surge', 'rally', 'bullish', 'gains', 'rise', 'up', 'adoption', 'breakthrough', 'positive'];
        const bearishKeywords = ['crash', 'drop', 'bearish', 'decline', 'fall', 'down', 'sell-off', 'negative', 'concern'];
        
        const bullishCount = bullishKeywords.filter(word => text.includes(word)).length;
        const bearishCount = bearishKeywords.filter(word => text.includes(word)).length;
        
        if (bullishCount > bearishCount) return 'bullish';
        if (bearishCount > bullishCount) return 'bearish';
        return 'neutral';
      }

      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m`;
        if (diffHours < 24) return `${diffHours}h`;
        return `${diffDays}d`;
      }

      function renderNews() {
        const newsContainer = document.getElementById('newsContainer');
        if (!newsContainer) return;

        const dataToRender = filteredNewsData.length > 0 || newsSearchTags.length > 0 || newsTimeFilter !== 'all' ? filteredNewsData : newsData;

        if (dataToRender.length === 0) {
          const hasFilters = newsSearchTags.length > 0 || newsTimeFilter !== 'all';
          newsContainer.innerHTML = `
            <div class="text-center text-gray-400 py-4 text-[10px]">
              ${hasFilters ? 'No news matches your filters.' : 'No news available.'} 
              <button onclick="${hasFilters ? 'clearAllNewsFilters()' : 'refreshNews()'}" class="text-gray-300 hover:text-gray-200 underline">
                ${hasFilters ? 'Clear filters' : 'Try refreshing'}
              </button>
          </div>
          `;
          return;
        }

        newsContainer.innerHTML = dataToRender.map(article => {
          const typeColor = article.type === 'bullish' ? 'bg-green-400' : 
                          article.type === 'bearish' ? 'bg-red-400' : 'bg-gray-400';
          
          const sourceColor = {
            'orange': 'text-orange-400',
            'blue': 'text-blue-400', 
            'purple': 'text-purple-400',
            'yellow': 'text-yellow-400'
          }[article.sourceColor] || 'text-gray-400';

          return `
            <div class="py-2 border-b border-gray-700/30 last:border-b-0 hover:bg-white/2 cursor-pointer" onclick="window.open('${article.link}', '_blank')">
              <div class="flex items-start justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <div class="text-[11px] font-medium text-gray-200 leading-relaxed mb-1 line-clamp-2">${article.title}</div>
                  <div class="flex items-center gap-2 text-[11px] text-gray-400">
                    <span class="${sourceColor}">${article.source}</span>
                    <span>•</span>
                    <span>${formatTimeAgo(article.pubDate)}</span>
          </div>
        </div>
                <div class="w-2 h-2 rounded-full mt-1.5 ${typeColor} flex-shrink-0"></div>
          </div>
        </div>
      `;
        }).join('');
      }

      window.refreshNews = async function() {
        const refreshBtn = document.getElementById('refreshNewsBtn');
        const newsContainer = document.getElementById('newsContainer');
        
        if (refreshBtn) {
          refreshBtn.innerHTML = `
            <svg class="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M8 16H3v5"/>
            </svg>
            <span>Loading...</span>
          `;
        }

        if (newsContainer) {
          newsContainer.innerHTML = `
            <div class="text-center text-gray-400 py-4 text-[10px]">
              Fetching latest news...
          </div>
          `;
        }

        try {
          await fetchNews();
          renderNews();
          console.log('News refreshed successfully');
        } catch (error) {
          console.error('Error refreshing news:', error);
          if (newsContainer) {
            newsContainer.innerHTML = `
              <div class="text-center text-red-400 py-4 text-[10px]">
                Failed to load news. <button onclick="refreshNews()" class="text-gray-300 hover:text-gray-200 underline">Retry</button>
            </div>
            `;
          }
        }

        if (refreshBtn) {
          refreshBtn.innerHTML = `
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M8 16H3v5"/>
            </svg>
            <span>Refresh</span>
          `;
        }
      };

      // Analytics Tab Functionality
      function initAnalyticsTabs() {
        const tabButtons = document.querySelectorAll('[data-tab]');
        const tabContents = document.querySelectorAll('[id$="-content"]');
        
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Reset all tab buttons
            tabButtons.forEach(btn => {
              btn.classList.remove('text-emerald-400', 'border-b', 'border-emerald-400');
              btn.classList.add('text-gray-400');
            });
            
            // Reset all tab contents
            tabContents.forEach(content => {
              content.classList.add('hidden');
            });
            
            // Activate selected tab
            button.classList.remove('text-gray-400');
            button.classList.add('text-emerald-400', 'border-b', 'border-emerald-400');
            
            // Show selected content
            const targetContent = document.getElementById(`tab-${targetTab}-content`);
            if (targetContent) {
              targetContent.classList.remove('hidden');
            }
          });
        });
      }

      function startNewsUpdates() {
        if (newsUpdateInterval) {
          clearInterval(newsUpdateInterval);
        }
        
        // Restore saved filter state
        restoreNewsFilterState();
        
        // Initial load
        refreshNews();
        
        // Update every 5 minutes
        newsUpdateInterval = setInterval(() => {
          refreshNews();
        }, 5 * 60 * 1000);
      }

      function restoreNewsFilterState() {
        try {
          const savedTags = localStorage.getItem('newsSearchTags');
          const savedTimeFilter = localStorage.getItem('newsTimeFilter');
          
          if (savedTags) {
            newsSearchTags = JSON.parse(savedTags);
            setTimeout(() => renderSearchTags(), 100);
          }
          
          if (savedTimeFilter) {
            newsTimeFilter = savedTimeFilter;
            setTimeout(() => {
              const timeFilterSelect = document.getElementById('newsTimeFilter');
              if (timeFilterSelect) {
                timeFilterSelect.value = newsTimeFilter;
              }
            }, 100);
          }
        } catch (error) {
          console.error('Error restoring news filter state:', error);
          newsSearchTags = [];
          newsTimeFilter = 'all';
        }
      }

      function stopNewsUpdates() {
        if (newsUpdateInterval) {
          clearInterval(newsUpdateInterval);
          newsUpdateInterval = null;
        }
      }

      // News Search and Filter Functions
      window.handleNewsSearch = function(event) {
        if (event.key === 'Enter') {
          const input = event.target;
          const searchTerm = input.value.trim();
          
          if (searchTerm && !newsSearchTags.includes(searchTerm.toLowerCase())) {
            newsSearchTags.push(searchTerm.toLowerCase());
            input.value = '';
            renderSearchTags();
            applyNewsFilters();
          }
        }
      };

      function renderSearchTags() {
        const tagsContainer = document.getElementById('newsSearchTags');
        if (!tagsContainer) return;

        if (newsSearchTags.length === 0) {
          tagsContainer.innerHTML = '';
          return;
        }

        tagsContainer.innerHTML = newsSearchTags.map(tag => `
          <div class="flex items-center gap-1 bg-gray-700 text-gray-200 px-2 py-1 rounded text-[9px]">
            <span>${tag}</span>
            <button onclick="removeNewsSearchTag('${tag}')" class="text-gray-400 hover:text-gray-200">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18"/>
                <path d="M6 6l12 12"/>
              </svg>
            </button>
          </div>
        `).join('');
      }

      window.removeNewsSearchTag = function(tag) {
        newsSearchTags = newsSearchTags.filter(t => t !== tag);
        renderSearchTags();
        applyNewsFilters();
      };

      window.applyNewsFilters = function() {
        const timeFilterSelect = document.getElementById('newsTimeFilter');
        if (timeFilterSelect) {
          newsTimeFilter = timeFilterSelect.value;
        }

        filteredNewsData = newsData.filter(article => {
          // Apply time filter
          if (newsTimeFilter !== 'all') {
            const now = new Date();
            const articleDate = article.pubDate;
            let timeLimit;

            switch (newsTimeFilter) {
              case 'today':
                timeLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
              case 'week':
                timeLimit = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                break;
              case 'month':
                timeLimit = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                break;
              default:
                timeLimit = new Date(0);
            }

            if (articleDate < timeLimit) {
              return false;
            }
          }

          // Apply search tags filter
          if (newsSearchTags.length > 0) {
            const articleText = (article.title + ' ' + article.description + ' ' + article.source).toLowerCase();
            return newsSearchTags.some(tag => articleText.includes(tag));
          }

          return true;
        });

        renderNews();
        updateFilterCounts();
      };

      function updateFilterCounts() {
        const timeFilterSelect = document.getElementById('newsTimeFilter');
        if (!timeFilterSelect) return;

        // Update option text with counts
        const options = timeFilterSelect.querySelectorAll('option');
        options.forEach(option => {
          const filterValue = option.value;
          let count = 0;

          if (filterValue === 'all') {
            count = newsData.length;
          } else {
            const now = new Date();
            let timeLimit;

            switch (filterValue) {
              case 'today':
                timeLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
              case 'week':
                timeLimit = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                break;
              case 'month':
                timeLimit = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                break;
            }

            count = newsData.filter(article => article.pubDate >= timeLimit).length;
          }

          const baseText = option.textContent.split(' (')[0];
          option.textContent = `${baseText} (${count})`;
        });
      }

      window.clearAllNewsFilters = function() {
        newsSearchTags = [];
        newsTimeFilter = 'all';
        
        const timeFilterSelect = document.getElementById('newsTimeFilter');
        if (timeFilterSelect) {
          timeFilterSelect.value = 'all';
        }
        
        renderSearchTags();
        applyNewsFilters();
      };

      // Update the existing refreshNews function to apply filters after fetching
      const originalRefreshNews = window.refreshNews;
      window.refreshNews = async function() {
        await originalRefreshNews();
        setTimeout(() => {
          applyNewsFilters();
        }, 100);
      };

      // Mobile Trade Sheet
      window.toggleMobileTradeSheet = function(show) {
        const sheet = $('#mobileTradeSheet');
        sheet.style.transform = show ? 'translateY(0)' : 'translateY(100%)';
      };

      $('#openMobileTrade').addEventListener('click', () => toggleMobileTradeSheet(true));

      // Chart Layout Management
      let currentChartLayout = 1;
      let chartWidgets = {};

      // Chart layout dropdown (now hover-based)
      const chartLayoutMenu = $('#chartLayoutMenu');
      
      if (chartLayoutMenu) {
        // Handle layout selection
        chartLayoutMenu.addEventListener('click', (e) => {
          const layoutOption = e.target.closest('.chart-layout-option');
          if (layoutOption) {
            const layout = parseInt(layoutOption.dataset.layout);
            setChartLayout(layout);
          }
        });
      }

      // Set chart layout function
      function setChartLayout(layout) {
        if (layout === currentChartLayout) return;

        // Update active state in dropdown
        document.querySelectorAll('.chart-layout-option').forEach(option => {
          option.classList.remove('active');
        });
        document.querySelector(`[data-layout="${layout}"]`).classList.add('active');

        // Hide all layouts
        $('#singleChartLayout').classList.add('hidden');
        $('#twoChartsLayout').classList.add('hidden');
        $('#fourChartsLayout').classList.add('hidden');

        // Destroy existing widgets except the main one
        Object.keys(chartWidgets).forEach(key => {
          if (key !== 'main' && chartWidgets[key]) {
            try {
              chartWidgets[key].remove();
              delete chartWidgets[key];
            } catch (e) {
              console.log('Error removing widget:', e);
            }
          }
        });

        currentChartLayout = layout;

        // Show appropriate layout and create widgets
        switch (layout) {
          case 1:
            $('#singleChartLayout').classList.remove('hidden');
            // Main widget should already exist
            break;
          
          case 2:
            $('#twoChartsLayout').classList.remove('hidden');
            createChartWidget('tradingview_widget_1', 'BINANCE:BTCUSDT');
            createChartWidget('tradingview_widget_2', 'BINANCE:ETHUSDT');
            break;
          
          case 4:
            $('#fourChartsLayout').classList.remove('hidden');
            createChartWidget('tradingview_widget_3', 'BINANCE:BTCUSDT');
            createChartWidget('tradingview_widget_4', 'BINANCE:ETHUSDT');
            createChartWidget('tradingview_widget_5', 'BINANCE:ADAUSDT');
            createChartWidget('tradingview_widget_6', 'BINANCE:SOLUSDT');
            break;
        }
      }

      // Create individual chart widget
      function createChartWidget(containerId, symbol) {
        if (!window.TradingView) {
          console.log('TradingView not loaded yet');
          return;
        }

        try {
          const widget = new TradingView.widget({
            autosize: true,
            symbol: symbol,
            interval: '1H',
            theme: 'dark',
            container_id: containerId,
            locale: 'en',
            toolbar_bg: '#0a0a0a',
            hide_side_toolbar: false,
            allow_symbol_change: true,
            hide_top_toolbar: false,
            hide_legend: false,
            studies_overrides: {},
            disabled_features: [
              'header_saveload', 'header_compare', 'header_screenshot',
              'header_fullscreen_button'
            ],
            enabled_features: [
              'header_symbol_search', 'header_resolutions', 'header_chart_type',
              'header_settings', 'header_indicators'
            ],
            overrides: {
              "paneProperties.background": "#0a0a0a",
              "paneProperties.backgroundType": "solid",
              "scalesProperties.textColor": "#b0b0b0",
              "scalesProperties.backgroundColor": "#111111",
              "mainSeriesProperties.candleStyle.upColor": "#6EE7B7",
              "mainSeriesProperties.candleStyle.downColor": "#F87171",
              "mainSeriesProperties.candleStyle.borderUpColor": "#6EE7B7",
              "mainSeriesProperties.candleStyle.borderDownColor": "#F87171",
              "mainSeriesProperties.candleStyle.wickUpColor": "#6EE7B7",
              "mainSeriesProperties.candleStyle.wickDownColor": "#F87171"
            }
          });

          chartWidgets[containerId] = widget;
        } catch (error) {
          console.error('Error creating chart widget:', error);
        }
      }

      // Panel Resizing
      const tradesPanel = $('#tradesPanel');
      const tpResizer = $('#tpResizer');
      let isResizing = false;

      tpResizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      window.addEventListener('mouseup', () => {
        isResizing = false;
        document.body.style.userSelect = '';
      });

      window.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerWidth = window.innerWidth;
        const railWidth = 48;
        const auxWidth = $('#auxColumn').offsetWidth || 0;
        const newWidth = Math.min(500, Math.max(320, containerWidth - e.clientX - railWidth - auxWidth));
        
        tradesPanel.style.width = newWidth + 'px';
      });

      // Close dropdowns on outside click
      document.addEventListener('click', (e) => {
        // Close dropdowns when clicking outside
        const proMenu = $('#proMenu');
        if (proMenu && !$('#orderPro').contains(e.target) && !proMenu.contains(e.target)) {
          proMenu.classList.add('hidden');
        }
        if (levModal.classList.contains('flex') && e.target.dataset.close === 'lev') {
          closeLev();
        }
      });

      // Initialize UI state
      $('#leverageLabel').textContent = appState.leverage + 'x';
      $('#marginModeLabel').textContent = currentMarginMode;
      disablePrice(true, 'auto for Market');
      setSide('long');
      updateSummary();
      
      // Initialize portfolio functionality
      initPortfolioTabs();
      initPortfolioFilters();
      

      
      // Show welcome message
      setTimeout(() => {
        showToast('Welcome to Nimbus Trading Platform with Strategies!');
      }, 2000);
      
      // Fallback TradingView initialization
      setTimeout(() => {
        if (window.TradingView && !document.querySelector('#tradingview_widget iframe')) {
          console.log('Fallback: Initializing TradingView...');
          if (typeof initTV === 'function') {
            initTV('BINANCE:BTCUSDT');
      } else {
            console.log('initTV function not available yet');
          }
        }
      }, 3000);
    }

    // Global functions for onclick handlers
    window.toggleCommandPalette = function(show) {
      const palette = document.getElementById('commandPalette');
      palette.classList.toggle('hidden', !show);
      palette.classList.toggle('flex', show);
      if (show) document.getElementById('commandInput').focus();
    };

    window.toggleLeverageModal = function(show) {
      const modal = document.getElementById('leverageModal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);
    };

    // Portfolio functionality
    function initPortfolioTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('[id^="panel-"]');
      
      function activateTab(tabKey) {
        // Update tab buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('tab-active', 'text-neutral-200');
          btn.classList.add('text-neutral-400');
        });
        
        // Update panels
        panels.forEach(panel => panel.classList.add('hidden'));
        
        // Activate selected tab and panel
        const activeBtn = document.querySelector(`[data-tab="${tabKey}"]`);
        const activePanel = document.getElementById(`panel-${tabKey}`);
        
        if (activeBtn) {
          activeBtn.classList.add('tab-active', 'text-neutral-200');
          activeBtn.classList.remove('text-neutral-400');
        }
        
        if (activePanel) {
          activePanel.classList.remove('hidden');
        }
      }
      
      // Add click listeners
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabKey = btn.dataset.tab;
          if (tabKey) activateTab(tabKey);
        });
      });
      
      // Initialize with first tab active
      activateTab('balances');
    }

    function initPortfolioFilters() {
      const filterBtn = document.getElementById('filterBtn');
      const filterMenu = document.getElementById('filterMenu');
      const toggle = document.getElementById('hideSmallToggle');
      
      // Filter menu toggle
      if (filterBtn && filterMenu) {
        filterBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          filterMenu.classList.toggle('hidden');
        });
        
        document.addEventListener('click', () => {
          filterMenu.classList.add('hidden');
        });
      }
      
      // Hide small balances toggle
      if (toggle) {
        toggle.addEventListener('click', () => {
          toggle.classList.toggle('toggle-on');
          toggle.classList.toggle('toggle-off');
        });
      }
    }

    // TWAP sub-tabs functionality
    function initTwapTabs() {
      const twapTabs = document.querySelectorAll('.twap-tab');
      const twapSections = {
        active: document.getElementById('twap-active'),
        history: document.getElementById('twap-history'),
        fills: document.getElementById('twap-fills')
      };

      function setActiveTwapTab(tabKey) {
        // Update tab buttons
        twapTabs.forEach(tab => {
          tab.classList.remove('bg-emerald-400', 'text-black');
          tab.classList.add('bg-white/5');
        });

        // Update sections
        Object.values(twapSections).forEach(section => {
          if (section) section.classList.add('hidden');
        });

        // Activate selected
        const activeTab = document.querySelector(`[data-twap-tab="${tabKey}"]`);
        if (activeTab) {
          activeTab.classList.add('bg-emerald-400', 'text-black');
          activeTab.classList.remove('bg-white/5');
        }

        if (twapSections[tabKey]) {
          twapSections[tabKey].classList.remove('hidden');
        }
      }

      // Add click listeners
      twapTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabKey = tab.dataset.twapTab;
          if (tabKey) setActiveTwapTab(tabKey);
        });
      });

      // Initialize with active tab
      setActiveTwapTab('active');
    }

    // Copy order ID functionality
    function initCopyOrderIds() {
    document.addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-id');
        if (!copyBtn) return;

        const orderId = copyBtn.dataset.id || copyBtn.textContent.trim();
        if (navigator.clipboard) {
          navigator.clipboard.writeText(orderId).then(() => {
            showPortfolioToast('Order ID copied to clipboard');
          });
        }
      });
    }

    // Toast notification function for portfolio
    function showPortfolioToast(message) {
      // Create toast if it doesn't exist
      let toast = document.getElementById('portfolioToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'portfolioToast';
        toast.className = 'fixed bottom-4 right-4 px-3 py-2 rounded-md border border-white/10 bg-black/90 text-[12px] text-white transform translate-y-full opacity-0 transition-all duration-300 z-50';
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.classList.remove('translate-y-full', 'opacity-0');

      // Hide after 2 seconds
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
      }, 2000);
    }

    // Global token state (using the complete implementation from provided example)
    const state = {
      marketType: localStorage.getItem('nimbus-market') || 'spot',   // 'spot' | 'perp'
      interval: localStorage.getItem('nimbus-interval') || '60',
      active: null, // {symbol, name, tv}
      allTokens: [], // unified list
      filtered: [],
      renderCount: 60,
      darkTheme: true,
      tvWidget: null,
      symbolSetUSDT: new Set(), // Binance spot pairs for USDT
      byPair: new Map(), // 'BTCUSDT' -> token
      rowMap: new Map(), // 'BTCUSDT' -> {priceEl, chgEl, root}
      ws: null,
      wsType: null,
      // Sorting
      sortKey: localStorage.getItem('nimbus-sort-key') || 'rank', // rank|token|price|change
      sortDir: localStorage.getItem('nimbus-sort-dir') || 'asc', // asc|desc
      rerenderScheduled: false,
    };

    const els = {
      tokenList: document.getElementById('tokenList'),
      emptyState: document.getElementById('emptyState'),
      sentinel: document.getElementById('sentinel'),
      tabSpot: document.getElementById('tab-spot'),
      tabPerp: document.getElementById('tab-perp'),
      search: document.getElementById('searchInput'),
      activeBadge: document.getElementById('activeBadge'),
      toast: document.getElementById('toast'),
      toastText: document.getElementById('toastText'),
      themeBtn: document.getElementById('themeBtn'),
      intervalGroup: document.getElementById('intervalGroup'),
      listContainer: document.getElementById('listContainer'),
      tvContainer: document.getElementById('tvContainer'),
      sortBar: document.getElementById('sortBar'),
    };

    // Helpers
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmtPrice = (n) => {
      if (n === null || n === undefined || isNaN(n)) return '—';
      if (n >= 1000) return '$' + n.toLocaleString(undefined,{maximumFractionDigits:0});
      if (n >= 1) return '$' + n.toLocaleString(undefined,{maximumFractionDigits:2});
      return '$' + n.toLocaleString(undefined,{maximumFractionDigits:6});
    };
    const pctClass = (v) => v >= 0 ? 'text-[color:var(--accent)]' : 'text-[color:var(--neg)]';

    function savePersist() {
      localStorage.setItem('nimbus-market', state.marketType);
      localStorage.setItem('nimbus-interval', state.interval);
      localStorage.setItem('nimbus-sort-key', state.sortKey);
      localStorage.setItem('nimbus-sort-dir', state.sortDir);
      if (state.active?.symbol) localStorage.setItem('nimbus-active', JSON.stringify(state.active));
    }

    function toast(msg) {
      els.toastText.textContent = msg;
      els.toast.classList.remove('hidden');
      setTimeout(() => els.toast.classList.add('hidden'), 2200);
    }

    // TradingView
    function initTV(defaultSymbol){
      console.log('initTV called with symbol:', defaultSymbol);
      if (!window.TradingView) {
        console.log('TradingView not available in initTV');
        return;
      }
      const symbol = defaultSymbol || 'BINANCE:BTCUSDT';
      console.log('Creating TradingView widget with symbol:', symbol);
      try {
        state.tvWidget = new TradingView.widget({
        autosize: true,
        symbol: symbol,
        interval: state.interval,
        theme: 'dark',
        container_id: 'tradingview_widget',
        locale: 'en',
        toolbar_bg: '#0a0a0a',
        hide_side_toolbar: false,
        allow_symbol_change: false,
        studies_overrides: {},
        disabled_features: ['header_saveload','header_compare','header_screenshot','left_toolbar','symbol_info','symbol_search_hot_key'],
        enabled_features: [],
        overrides: {
          "paneProperties.background": "#0a0a0a",
          "paneProperties.backgroundType": "solid",
          "scalesProperties.textColor": "#b0b0b0",
          "scalesProperties.backgroundColor": "#111111",
          "mainSeriesProperties.candleStyle.upColor": "#6EE7B7",
          "mainSeriesProperties.candleStyle.downColor": "#FF5A5F",
          "mainSeriesProperties.candleStyle.drawWick": true,
          "mainSeriesProperties.candleStyle.drawBorder": true,
          "mainSeriesProperties.candleStyle.borderColor": "#6EE7B7",
          "mainSeriesProperties.candleStyle.borderUpColor": "#6EE7B7",
          "mainSeriesProperties.candleStyle.borderDownColor": "#FF5A5F",
          "volumePaneSize": "medium"
        }
      });
      
      console.log('TradingView widget created successfully');

      state.tvWidget.onChartReady(() => {
        console.log('TradingView chart ready');
        if (els.activeBadge) {
          els.activeBadge.textContent = symbol;
        }
      });
      } catch (error) {
        console.error('Error creating TradingView widget:', error);
      }
    }

    function setChartSymbol(tvSymbol){
      if (!state.tvWidget) return;
      const start = performance.now();
      try{
        state.tvWidget.chart().setSymbol(tvSymbol, state.interval, () => {
          const ms = Math.max(40, Math.round(performance.now() - start));
          toast(`Chart updated. ${ms} ms load.`);
          els.activeBadge.textContent = tvSymbol;
        });
      }catch(e){
        toast('Symbol not available.');
      }
    }

    // Data
    async function fetchBinanceUSDT() {
      const url = 'https://api.binance.com/api/v3/exchangeInfo';
      const res = await fetch(url);
      const data = await res.json();
      const set = new Set();
      const rows = [];
      for (const s of data.symbols || []) {
        if (s.status !== 'TRADING') continue;
        if (!s.symbol.endsWith('USDT')) continue;
        set.add(s.symbol);
        rows.push({ base: s.baseAsset, symbol: s.symbol });
      }
      state.symbolSetUSDT = set;
      return rows;
    }

    async function fetchCoinGeckoTop() {
      const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false&price_change_percentage=24h';
      const res = await fetch(url);
      if (!res.ok) throw new Error('CoinGecko limit');
      const data = await res.json();
      const bySymbol = new Map(); // UPPER -> coin
      for (const c of data) {
        bySymbol.set((c.symbol || '').toUpperCase(), c);
      }
      return { list: data, bySymbol };
    }

    function buildUnified(binanceRows, coingecko){
      const tokens = [];
      for (const row of binanceRows) {
        const base = row.base.toUpperCase();
        const cg = coingecko.bySymbol.get(base);
        const name = cg?.name || base;
        const image = cg?.image || 'https://images.unsplash.com/photo-1621619856624-42fd193a0661?w=80&q=60&auto=format&fit=crop';
        const price = cg?.current_price ?? null;
        const change = cg?.price_change_percentage_24h ?? null;
        const marketCapRank = cg?.market_cap_rank ?? 9999;
        tokens.push({
          symbol: base,
          name,
          pair: `${base}USDT`,
          tvSpot: `BINANCE:${base}USDT`,
          tvPerp: `BINANCE:${base}USDT.P`,
          image,
          price,
          change,
          rank: marketCapRank
        });
      }
      // Sort by market cap rank then alphabetically
      tokens.sort((a,b) => (a.rank||9999)-(b.rank||9999) || a.symbol.localeCompare(b.symbol));
      return tokens;
    }

    function restoreActive(tokens){
      const cached = localStorage.getItem('nimbus-active');
      if (cached) {
        try {
          const a = JSON.parse(cached);
          const match = tokens.find(t => t.symbol === a.symbol);
          if (match) return match;
        } catch {}
      }
      return tokens.find(t => t.symbol === 'BTC') || tokens[0];
    }

    // Sorting
    function getSorted(arr){
      const a = arr.slice();
      const key = state.sortKey;
      const dir = state.sortDir === 'asc' ? 1 : -1;
      if (key === 'token') {
        a.sort((x,y)=> x.symbol.localeCompare(y.symbol)*dir);
      } else if (key === 'price') {
        a.sort((x,y)=> ((x.price??-Infinity) - (y.price??-Infinity)) * dir);
      } else if (key === 'change') {
        a.sort((x,y)=> ((x.change??-Infinity) - (y.change??-Infinity)) * dir);
      } else { // rank
        a.sort((x,y)=> (((x.rank??9999)-(y.rank??9999)) || x.symbol.localeCompare(y.symbol)) * dir);
      }
      return a;
    }

    function applySortUI(){
      const btns = els.sortBar.querySelectorAll('button[data-sort]');
      btns.forEach(b=>{
        const active = b.dataset.sort === state.sortKey;
        b.classList.toggle('text-[color:var(--text)]', active);
        b.classList.toggle('text-[color:var(--text-3)]', !active);
        const icon = b.querySelector('i[data-lucide]');
        if (!icon) return;
        const desired = active
          ? (state.sortDir === 'asc' ? 'arrow-up' : 'arrow-down')
          : 'arrow-up-down';
        if (icon.getAttribute('data-lucide') !== desired) {
          icon.setAttribute('data-lucide', desired);
        }
      });
      if (window.lucide) lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
    }

    // Render
    function renderList(reset=false){
      const baseArr = state.filtered.length ? state.filtered : state.allTokens;
      const arr = getSorted(baseArr);
      if (reset) state.renderCount = 60;
      els.tokenList.innerHTML = '';
      state.rowMap.clear();

      if (!arr.length) {
        els.emptyState.classList.remove('hidden');
        return;
      } else {
        els.emptyState.classList.add('hidden');
      }

      const take = arr.slice(0, state.renderCount);
      for (const t of take) {
        const isActive = state.active && state.active.symbol === t.symbol;
        const li = document.createElement('li');
                li.className = "";
        li.innerHTML = `
          <button class="w-full flex items-center gap-2 px-1 py-0.5 hover:bg-white/5 cursor-pointer border-b border-gray-700/30 last:border-b-0 ${isActive ? 'bg-gray-700/50' : ''}" data-symbol="${t.symbol}">
            <img src="${t.image}" alt="${t.symbol}" class="w-4 h-4 rounded-full object-cover border border-gray-700 bg-gray-800" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1621619856624-42fd193a0661?w=80&q=60&auto=format&fit=crop'"/>
            <div class="grid grid-cols-12 gap-1 w-full text-[10px] mono">
              <div class="col-span-6 flex flex-col text-left min-w-0">
                <div class="flex items-center gap-1">
                  <span class="text-gray-200 font-medium truncate">${t.symbol}-USDT</span>
                  <span class="text-gray-500 text-[9px]">#${t.rank ?? '—'}</span>
                </div>
                <span class="text-gray-400 text-[9px] truncate">${t.name}</span>
              </div>
              <div class="col-span-3 text-right text-gray-300 font-medium" data-role="price">${fmtPrice(t.price)}</div>
              <div class="col-span-3 text-right font-medium ${pctClass(t.change)}" data-role="change">${(t.change!=null? (t.change>=0?'+':'')+Number(t.change).toFixed(2)+'%':'—')}</div>
            </div>
          </button>
        `;
        const btn = li.querySelector('button');
        btn.addEventListener('click', () => onTokenClick(t));
        const priceEl = li.querySelector('[data-role="price"]');
        const chgEl = li.querySelector('[data-role="change"]');
        els.tokenList.appendChild(li);
        state.rowMap.set(t.pair, { priceEl, chgEl, root: btn });
      }
    }

    function loadMore(){
      const arr = state.filtered.length ? state.filtered : state.allTokens;
      if (state.renderCount < arr.length) {
        state.renderCount += 60;
        renderList(false);
      }
    }

    function onTokenClick(token){
      state.active = token;
      savePersist();
      renderList(false);
      const tvSymbol = state.marketType === 'perp' ? token.tvPerp : token.tvSpot;
      setChartSymbol(tvSymbol);
    }

    // Tabs
    function applyTabUI(){
      const tokenTabSlider = document.getElementById('tokenTabSlider');
      if (state.marketType === 'spot') {
        els.tabSpot.classList.remove('text-neutral-400');
        els.tabPerp.classList.add('text-neutral-400');
        tokenTabSlider.style.transform = 'translateX(0)';
      } else {
        els.tabPerp.classList.remove('text-neutral-400');
        els.tabSpot.classList.add('text-neutral-400');
        tokenTabSlider.style.transform = 'translateX(100%)';
      }
      if (state.active) {
        const tvSymbol = state.marketType === 'perp' ? state.active.tvPerp : state.active.tvSpot;
        setChartSymbol(tvSymbol);
      }
      switchWS(); // switch live stream to match Spot/Perp
      savePersist();
    }

    // Search
    function applySearch(q){
      const query = (q || '').trim().toLowerCase();
      if (!query) {
        state.filtered = [];
      } else {
        state.filtered = state.allTokens.filter(t =>
          t.symbol.toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query)
        );
      }
      renderList(true);
    }

        // Infinite
    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) loadMore();
      }
    });
    io.observe(document.getElementById('sentinel'));

    // Events
    els.tabSpot.addEventListener('click', () => { state.marketType = 'spot'; applyTabUI(); });
    els.tabPerp.addEventListener('click', () => { state.marketType = 'perp'; applyTabUI(); });
    els.search.addEventListener('input', (e) => applySearch(e.target.value));

    // Sorting events
    els.sortBar.addEventListener('click', (e) => {
      const b = e.target.closest('button[data-sort]');
      if (!b) return;
      const key = b.dataset.sort;
      if (state.sortKey === key) {
        state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortKey = key;
        state.sortDir = (key === 'token' || key === 'rank') ? 'asc' : 'desc';
      }
      savePersist();
      applySortUI();
      renderList(false);
    });

    // Caching (24h)
    function cacheSet(key, data){
      const payload = { t: Date.now(), data };
      localStorage.setItem(key, JSON.stringify(payload));
    }
    function cacheGet(key, maxAgeMs){
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      try{
        const obj = JSON.parse(raw);
        if (Date.now() - obj.t > maxAgeMs) return null;
        return obj.data;
      }catch{return null;}
    }

    async function bootstrap(force=false){
      if (window.lucide) lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });

      let binanceRows = !force ? cacheGet('nimbus-binance', 6*60*60*1000) : null;
      if (!binanceRows) {
        try {
          binanceRows = await fetchBinanceUSDT();
          cacheSet('nimbus-binance', binanceRows);
        } catch {
          binanceRows = [];
        }
      }

      let cg = !force ? cacheGet('nimbus-cg', 30*60*1000) : null;
      if (!cg) {
        try {
          const cgRes = await fetchCoinGeckoTop();
          cg = { list: cgRes.list, bySymbol: Array.from(cgRes.bySymbol.entries()) };
          cacheSet('nimbus-cg', cg);
        } catch {
          cg = { list: [], bySymbol: [] };
        }
      }
      const cgMap = new Map(cg.bySymbol || []);
      const unified = buildUnified(binanceRows, { list: cg.list, bySymbol: cgMap });

      state.allTokens = unified;
      state.byPair = new Map();
      for (const t of unified) state.byPair.set(t.pair, t);

      state.active = restoreActive(unified);
      applyTabUI();
      applySortUI();
      renderList(true);

      if (!state.tvWidget) {
        initTV(state.marketType === 'perp' ? state.active.tvPerp : state.active.tvSpot);
      } else {
        const tvSymbol = state.marketType === 'perp' ? state.active.tvPerp : state.active.tvSpot;
        setChartSymbol(tvSymbol);
      }
    }

    // Live updates via Binance streams
    function switchWS(){
      const desired = state.marketType === 'perp' ? 'perp' : 'spot';
      if (state.ws && state.wsType === desired) return;
      if (state.ws) { try { state.ws.close(); } catch {} state.ws = null; }
      connectWS(desired);
    }

    function connectWS(type){
      const url = type === 'perp'
        ? 'wss://fstream.binance.com/ws/!ticker@arr'
        : 'wss://stream.binance.com:9443/ws/!ticker@arr';
      try{
        const ws = new WebSocket(url);
        state.ws = ws;
        state.wsType = type;
        ws.onopen = ()=>{ /* connected */ };
        ws.onmessage = (msg)=>{
          let data;
          try { data = JSON.parse(msg.data); } catch { return; }
          if (!Array.isArray(data)) return;
          for (const t of data) {
            const s = t.s; // SYMBOL e.g., BTCUSDT
            if (!s || !s.endsWith('USDT')) continue;
            const tok = state.byPair.get(s);
            if (!tok) continue;
            // Update live values
            const last = parseFloat(t.c);
            const pct = parseFloat(t.P);
            if (!isNaN(last)) tok.price = last;
            if (!isNaN(pct)) tok.change = pct;

            // Update row if visible
            const row = state.rowMap.get(s);
            if (row) {
              if (!isNaN(last)) row.priceEl.textContent = fmtPrice(last);
              if (!isNaN(pct)) {
                row.chgEl.textContent = (pct>=0?'+':'') + pct.toFixed(2) + '%';
                row.chgEl.classList.toggle('text-[color:var(--accent)]', pct >= 0);
                row.chgEl.classList.toggle('text-[color:var(--neg)]', pct < 0);
              }
            }
          }
          // If sorted by live metrics, schedule rerender
          if (state.sortKey === 'price' || state.sortKey === 'change') {
            if (!state.rerenderScheduled) {
              state.rerenderScheduled = true;
              setTimeout(()=>{ state.rerenderScheduled = false; renderList(false); }, 700);
            }
          }
        };
        ws.onclose = ()=>{
          if (state.ws === ws) {
            state.ws = null;
            // Reconnect after short delay if still same type
            setTimeout(()=>{ if (!state.ws) connectWS(type); }, 1500);
          }
        };
        ws.onerror = ()=>{ try{ ws.close(); }catch{} };
      }catch(e){
        // retry later
        setTimeout(()=>connectWS(type), 2000);
      }
    }

    // Start
    bootstrap().then(()=> {
      switchWS();
      // Initialize TradingView chart after data is loaded
      setTimeout(() => {
        console.log('TradingView available:', !!window.TradingView);
        console.log('Current tvWidget:', state.tvWidget);
        if (window.TradingView && !state.tvWidget) {
          console.log('Initializing TradingView...');
          initTV('BINANCE:BTCUSDT');
        } else {
          console.log('TradingView not available or widget already exists');
        }
      }, 2000);
    });

    

    // Initialize portfolio functionality
    document.addEventListener('DOMContentLoaded', () => {
      initPortfolioTabs();
      initPortfolioFilters();
      initTwapTabs();
      initCopyOrderIds();
    });

    // Community Signals Functionality
    function renderCommunitySignals(filter = 'all') {
      const container = document.getElementById('signalsContainer');
      if (!container) {
        console.log('signalsContainer not found');
        return;
      }

      // Filter signals based on selected filter
      let filteredSignals = communitySignalsData;
      if (filter !== 'all') {
        filteredSignals = communitySignalsData.filter(signal => signal.direction === filter);
      }

      console.log('Rendering signals:', filteredSignals.length, 'signals with filter:', filter);

      // Clear container
      container.innerHTML = '';

      // Render each signal
      filteredSignals.forEach(signal => {
        const signalCard = createSignalCard(signal);
        container.appendChild(signalCard);
      });

      // If no signals, show a message
      if (filteredSignals.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8 text-[12px]">No signals found</div>';
      }
    }

    function createSignalCard(signal) {
      const card = document.createElement('div');
      const directionClass = signal.direction === 'long' ? 'border-green-500/30' : 'border-red-500/30';
      
      card.className = `bg-gray-800/30 rounded-lg p-3 border ${directionClass} cursor-pointer hover:bg-gray-800/50 transition-colors`;
      
      // Use the exact same HTML structure as community.html
      card.innerHTML = createCardHTML(signal);
      
      return card;
    }

    // Function to create card HTML - same as community.html
    function createCardHTML(item) {
      return `
        <div class="flex items-start gap-3">
          <img src="${item.avatar}" class="w-8 h-8 rounded-full" alt="${item.author}">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="font-semibold text-white text-[11px]">${item.author}</h3>
              <span class="text-[10px] text-gray-400">${item.time}</span>
            </div>
            ${getTypeSpecificHTML(item)}
            <div class="flex items-center justify-between pt-2 border-t border-gray-700">
              <div class="flex items-center gap-2 text-[10px] text-gray-400">
                <span>${item.likes} likes</span>
                <span>${item.comments} comments</span>
              </div>
              <button class="bg-gray-600 text-gray-300 hover:bg-gray-500 hover:text-white px-2 py-1 rounded text-[10px]">Read</button>
            </div>
          </div>
        </div>
      `;
    }

    // Function to get type-specific HTML - same as community.html
    function getTypeSpecificHTML(item) {
      if (item.type === 'signal') {
        const directionClass = item.direction === 'long' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
        const targetColor = item.direction === 'long' ? 'text-green-400' : 'text-red-400';
        return `
          <div class="flex items-center gap-2 mb-2">
            <span class="text-[10px] ${directionClass} px-2 py-1 rounded">${item.direction.toUpperCase()}</span>
            <span class="text-[10px] text-gray-300">${item.pair}</span>
          </div>
          <h4 class="text-white font-medium mb-2 text-[11px]">${item.title}</h4>
          <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
            <div class="bg-gray-700/40 rounded p-1.5 text-center">
              <div class="text-gray-400">Entry</div>
              <div class="font-mono text-white font-semibold">${item.entry}</div>
            </div>
            <div class="bg-gray-700/40 rounded p-1.5 text-center">
              <div class="text-gray-400">Target</div>
              <div class="font-mono ${targetColor} font-semibold">${item.target}</div>
            </div>
            <div class="bg-gray-700/40 rounded p-1.5 text-center">
              <div class="text-gray-400">Stop Loss</div>
              <div class="font-mono text-red-400 font-semibold">${item.stopLoss}</div>
            </div>
            <div class="bg-gray-700/40 rounded p-1.5 text-center">
              <div class="text-gray-400">Take Profit</div>
              <div class="font-mono ${targetColor} font-semibold">${item.takeProfit}</div>
            </div>
          </div>
        `;
      }
      return '';
    }

    function initSignalsPanel() {
      console.log('initSignalsPanel called');
      console.log('communitySignalsData length:', communitySignalsData.length);
      
      // Initialize filter buttons
      const filterButtons = document.querySelectorAll('.signal-filter');
      console.log('Found filter buttons:', filterButtons.length);
      
      filterButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          // Update active state
          filterButtons.forEach(btn => {
            btn.className = 'signal-filter flex-1 px-2 py-1 text-[11px] font-medium rounded-sm text-gray-400 hover:text-gray-200';
          });
          e.target.className = 'signal-filter flex-1 px-2 py-1 text-[11px] font-medium rounded-sm bg-gray-700 text-gray-200';
          
          // Filter signals
          const filter = e.target.getAttribute('data-filter');
          renderCommunitySignals(filter);
        });
      });

      // Initial render
      renderCommunitySignals();
    }

  </script>
</body>
</html>
